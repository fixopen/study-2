<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>小雨知时</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0,user-scalable=no"
          id="viewport"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="screen-orientation" content="portrait"/>
    <link rel="stylesheet" href="/bootstrap/bootstrap.min.css">
</head>
<body class="wrap">
<article id="volumes">
    <h1 id="subjectTitle"></h1>
    <!-- Nav tabs -->
    <ul id="subjects" class="nav nav-tabs" role="tablist">
        <li role="presentation" class="active"><a href="#low" role="tab" data-toggle="tab">chinese</a></li>
        <li role="presentation"><a href="#high" role="tab" data-toggle="tab">math</a></li>
    </ul>
    <!-- Tab panes -->
    <div class="tab-content">
        <div role="tabpanel" class="tab-pane active" id="low"></div>
        <div role="tabpanel" class="tab-pane" id="high"></div>
    </div>
</article>
<article id="knowledgePoints" style="display: none;">
    <h1 id="volumeTitle"></h1>
    <ol id="knowledge-point-contents"></ol>
</article>
<article id="knowledgePoint" style="display: none;">
    <section id="knowledgePointTitle"></section>
    <section>
        <h2>选文赏析</h2>
        <ul id="origin"></ul>
    </section>
    <section id="content"></section>
    <section id="video"></section>
    <section>
        <h2>闯关练习</h2>
        <dl id="problems"></dl>
    </section>
    <section id="interaction"></section>
    <section>
        <span>写留言<img src="write.png" alt="写留言"/></span>
        <textarea id="new-comment" style="display: none"></textarea>
        <section id="comments"></section>
    </section>
</article>

<template id="volume-template">
    <li>
        <a href="#">${title}</a>
    </li>
</template>

<template id="volume-title-template">
    <span>${title}</span>
</template>
<template id="knowledge-point-template">
    <li>
        <a href="#">${name}</a>
        <div>
            阅读<span>${readCount}</span>
            <span>${likeCount}</span>
        </div>
        <img src="separator.png" alt=""/>
    </li>
</template>

<template id="knowledge-point-title-template">
    <h1>${title}</h1>
</template>
<template id="origin-template">
    <article>
        <section>${content}</section>
        <address>${source}</address>
    </article>
</template>
<template id="content-text-template">
    <p>${content}</p>
</template>
<template id="content-image-template">
    <span>
        <img src="${href}" alt="${description}"/>
    </span>
</template>
<template id="content-image-text-template">
    <p>
        <img src="${href}" alt="${description}"/>
        ${content}
    </p>
</template>
<template id="video-template">
    <span>
        <a href="${href}"><img src="${storePath}"/></a>
    </span>
</template>
<template id="problem-option-template">
    <li>
        <span>${title}</span>
        <label>${name}</label>
    </li>
</template>
<template id="problem-template">
    <div>
        <p><span>${type}</span>${title}</p>
        <img src="${storePath}" alt=""/>
        <ol type="A" data-ext-point="options"></ol>
        <div data-ext-point="explain"></div>
    </div>
</template>
<template id="interaction-template">
    <div>
        <span>阅读</span><span>${readCount}</span>
        <span><img src="like.jpg" alt="like"/></span><span>${likeCount}</span>
        <a href="${previous}">previous</a><a href="${next}">next</a>
    </div>
</template>
<template id="comment-template">
    <article>
        <img src="${avatar}" alt=""/>
        <span>${name}</span>
        <span><img src="like.jpg" alt="like"/></span><span>${likeCount}</span>
        <section>${content}</section>
        <time>${time}</time>
    </article>
</template>

<dialog>成为会员才可继续观看视频哟！成为会员才可继续观看视频哟！</dialog>
<dialog>您的卡片已过期，请重新购买！</dialog>
<dialog>您的卡片只可观看***，<br>观看其他内容请购买相应卡片！</dialog>
<dialog>还剩24雨点不够观看啦，请充值！</dialog>
<dialog>雨点所剩不多，请尽快充值哦！</dialog>

<script src="/jquery/jquery-3.1.1.min.js"></script>
<script src="/bootstrap/bootstrap.min.js"></script>
<script src="/util.js"></script>
<script src="/basic.js"></script>
<script>
    var subjects = []

    var state = {
        currentArticle: document.getElementById('volumes'),
        init: function () {
            var userId = g.getUrlParameter('userid')
            g.setCookie('userId', userId)

            $.ajax({
                type: 'GET',
                url: '/api/subjects',
                dataType: 'json',
                success: function (ss) {
                    subjects = ss
                    for (var i = 0; i < subjects.length; ++i) {
                        subjects[i].low = []
                        subjects[i].high = []
                    }
                    $.ajax({
                        type: 'GET',
                        url: '/api/volumes',
                        dataType: 'json',
                        success: function (vs) {
                            for (var i = 0; i < vs.length; ++i) {
                                vs[i].knowledgePoints = []
                                var s = state.subject.getById(vs[i].subjectId)
                                if (s) {
                                    var gn = state.grade.getNameByValue(vs[i].grade)
                                    s[gn].push(vs[i])
                                } else {
                                    console.log(vs[i])
                                }
                            }
                            $.ajax({
                                type: 'GET',
                                url: '/api/knowledge-points',
                                dataType: 'json',
                                success: function (kps) {
                                    var isNew = function(now, kp) {
                                        var result = false
                                        if (+kp.showTime + 24 * 60 * 60 * 1000 > +now) {
                                            result = true
                                        }
                                        return result
                                    }
                                    var now = Date.now()
                                    for (var i = 0; i < kps.length; ++i) {
                                        var v = state.volume.getById(kps[i].volumeId)
                                        if (v) {
                                            kps[i].showTime = Date.parse(kps[i].showTime.replace('-', '/'))
                                            if (isNew(now, kps[i])) {
                                                kps[i].type = 'normalNew'
                                                v.knowledgePoints.unshift(kps[i])
                                            } else {
                                                kps[i].type = 'normalOld'
                                                v.knowledgePoints.push(kps[i])
                                            }
                                        } else {
                                            console.log(kps[i])
                                        }
                                    }

                                    var subjectId = g.getUrlParameter('subjectId')
                                    //state.volumes.subjectId = subjectId
                                    //state['volumes'].init()
                                    history.pushState(null, null, '/content.html#volumes')

                                    state['volumes'].changeId(subjectId)
                                },
                                error: function (r) {
                                }
                            })
                        },
                        error: function (r) {
                        }
                    })
                },
                error: function (r) {
                }
            })

            var switchTo = function(id) {
                state.currentArticle.style.display = 'none'
                state.currentArticle = document.getElementById(id)
                state.currentArticle.style.display = 'block'
                history.pushState(null, null, '/content.html#' + id)
                state[id].init()
            }

            $(document).on('click', '[data-article]', function (e) {
                var id = e.target.dataset.article
                switchTo(id)
            })

            window.addEventListener('hashchange', function(e) {
                var hashPos = e.newURL.indexOf('#')
                var hash = e.newURL.substring(hashPos + 1)
                switchTo(hash)
            })
        },
        volumes: {
            parentId: 0,
            init: function () {},
            changeId: function(subjectId) {
                if (state.volumes.parentId != subjectId) {
                    state.volumes.parentId = subjectId
                    state.volumes.value = state.subject.getById(state.volumes.parentId)
                    state.volumes.show()
                }
            },
            value: null,
            show: function() {
                //bind subject's volume to this article

                //step1: clear the article

                //step2: rebind the article
            }
        },
        knowledgePoints: {
            parentId: null,
            init: function () {},
            changeId: function(volumeId) {
                if (state.volumes.parentId != volumeId) {
                    state.volumes.parentId = volumeId
                    state.knowledgePoints.value = state.volume.getById(state.knowledgePoints.parentId)
                    state.knowledgePoints.show()
                }
            },
            value: null,
            show: function() {
                //bind volume's knowledgePoints to this article

                //step1: clear the article

                //step2: rebind the article
            }
        },
        knowledgePoint: {
            init: function () {},
            parentId: 0,
            changeId: function(knowledgePointId) {
                if (state.knowledgePoint.parentId != knowledgePointId) {
                    state.knowledgePoint.parentId = knowledgePointId
                    state.knowledgePoint.value = state.knowledgePoint.getById(state.knowledgePoint.parentId)
                    if (!state.knowledgePoint.value.contents) {
                        $.ajax({
                            type: 'get',
                            url: 'api/knowledge-points/' + state.knowledgePoint.value.id + '/contents',
                            dataType: 'json',
                            success: function (data) {
                                state.knowledgePoint.value.contents = data
                                state.knowledgePoint.show()
                            }
                        })
                    } else {
                        state.knowledgePoint.show()
                    }
                }
            },
            value: null,
            show: function() {
                //bind knowledgePoint's contents to this article

                //step1: clear the article

                //step2: rebind the article
                var value = state.knowledgePoint.value
                proc({
                    templateId: 'title-template',
                    data: value,
                    containerId: 'title'
                })

                proc({
                    templateId: 'origin-template',
                    data: value.contents.quotes,
                    containerId: 'origin'
                })

                proc({
                    data: value.contents.contents,
                    containerId: 'content',
                    alterTemplates: [
                        {type: 'text', templateId: 'content-text-template'},
                        {type: 'image', templateId: 'content-image-template'}
                    ]
                })

                proc({
                    templateId: 'video-template',
                    data: value.contents.video,
                    containerId: 'video'
                })

                proc({
                    templateId: 'problem-template',
                    data: value.contents.problems,
                    containerId: 'problems',
                    secondBind: {
                        extPoint: 'options',
                        dataFieldName: 'options',
                        templateId: 'problem-option-template'
                    }
                })

                proc({
                    templateId: 'interaction-template',
                    data: value.contents.interaction,
                    containerId: 'interaction'
                })

                proc({
                    templateId: 'comment-template',
                    data: value.contents.comments,
                    containerId: 'comments'
                })
            },
            getById: function(id) {
                var result = null
                var isFind = false
                for (var i = 0; i < subjects.length; ++i) {
                    for (var j = 0; j < subjects[i].low.length; ++j) {
                        for (var k = 0; k < subjects[i].low[j].knowledgePoints.length; ++k) {
                            if (subjects[i].low[j].knowledgePoints[k].id == id) {
                                result = subjects[i].low[j].knowledgePoints[k]
                                isFind = true
                                break
                            }
                        }
                    }
                    if (isFind) {
                        break
                    }
                    for (var j = 0; j < subjects[i].high.length; ++j) {
                        for (var k = 0; k < subjects[i].high[j].knowledgePoints.length; ++k) {
                            if (subjects[i].high[j].knowledgePoints[k].id == id) {
                                result = subjects[i].high[j].knowledgePoints[k]
                                isFind = true
                                break
                            }
                        }
                    }
                    if (isFind) {
                        break
                    }
                }
                return result
            }
        },
        subject: {
            index: 0,
            value: null,
            getById: function (id) {
                var result = null
                for (var i = 0; i < subjects.length; ++i) {
                    if (subjects[i].id == id) {
                        result = subjects[i]
                        break
                    }
                }
                return result
            }
        },
        grade: {
            index: 0,
            value: 20,
            name: 'low',
            getNameByValue: function (v) {
                var result = 'low'
                if (v == 21) {
                    result = 'high'
                }
                return result
            }
        },
        volume: {
            index: 0,
            value: null,
            maxOrder: 1,
            getById: function (id) {
                var result = null
                var isFind = false
                for (var i = 0; i < subjects.length; ++i) {
                    for (var j = 0; j < subjects[i].low.length; ++j) {
                        if (subjects[i].low[j].id == id) {
                            result = subjects[i].low[j]
                            isFind = true
                            break
                        }
                    }
                    if (isFind) {
                        break
                    }
                    for (var j = 0; j < subjects[i].high.length; ++j) {
                        if (subjects[i].high[j].id == id) {
                            result = subjects[i].high[j]
                            isFind = true
                            break
                        }
                    }
                    if (isFind) {
                        break
                    }
                }
                return result
            }
        }
    }

    state.init()
</script>
</body>
</html>