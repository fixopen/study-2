<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>直播视频</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0,user-scalable=no"
          id="viewport"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="screen-orientation" content="portrait"/>
    <link rel="stylesheet" href="/bootstrap/bootstrap.min.css">
    <style>
        .convenient {
            position: absolute;
            top: 2.7%;
            left: 50%;
            -webkit-transform: translateX(-50%);
            -ms-transform: translateX(-50%);
            -o-transform: translateX(-50%);
            transform: translateX(-50%);
            display: block;
            width: 92%;
            background: url('img/schedule.png') no-repeat center top;
            -webkit-background-size: 100% 100%;
            background-size: 100% 100%;
            padding: 10.5% 4.3% 4.5%;
            box-sizing: border-box;
            overflow: hidden;
            text-align: center;
        }

        .week {
            position: absolute;
            top: 3%;
            left: 28.3%;
            font-size: 1rem;
            color: #000;
            font-family: "Microsoft YaHei", serif;
        }

        .schedule-table {
            width: 100%;
            height: 100%;
        }

        .schedule-table thead {
            height: 1.8125rem;
        }

        .schedule-table tr {
            height: 1.25rem;
        }

        .color:nth-child(even) {
            background-color: #ffd5ce;
            border-bottom: 0.0625rem solid #ea875f;
        }

        .color:nth-child(odd) {
            background-color: #fff;
            border-bottom: 0.09375rem solid #ea875f;
        }

        .schedule-table td {
            font-size: 0.6875rem;
            color: #371f1f;
            text-align: center;
        }

        .data :nth-child(even) {
            border-top: 1px solid #ea875f;
        }
    </style>
</head>
<body>
<article id="main">
    <img src="" alt="" id="schedulerEntry" data-article="scheduler"/>
    <!-- Nav tabs -->
    <ul id="subjects" class="nav nav-tabs" role="tablist">
        <li role="presentation" class="active"><a href="#zero" role="tab" data-toggle="tab">chinese</a></li>
        <li role="presentation"><a href="#one" role="tab" data-toggle="tab">math</a></li>
    </ul>
    <!-- Tab panes -->
    <div class="tab-content">
        <div role="tabpanel" class="tab-pane active" id="zero">
            <div id="zeroPlaying"></div>
            <div id="zeroFuture"></div>
        </div>
        <div role="tabpanel" class="tab-pane" id="one">
            <div id="onePlaying"></div>
            <div id="oneFuture"></div>
        </div>
    </div>
</article>
<article id="passed" style="display: none;">
    <div>
        <select id="subject"></select>
        <select id="teacher"></select>
        <select id="grade"></select>
    </div>
    <div>
        <div id="zeroPassed"></div>
        <div id="zeroTips"></div>
        <button id="zeroMore">More</button>
    </div>
    <div>
        <div id="onePassed"></div>
        <div id="oneTips"></div>
        <button id="oneMore">More</button>
    </div>
</article>
<article id="video" style="display: none;">
    <video id="video-item" src="#" controls autoplay style="width: 100%;height: 100%; margin-left: 11px;"></video>
</article>
<article id="scheduler" style="display: none;">
    <div class="convenient">
        <div class="week">
            第<span id="week"></span>周
        </div>
        <table class="schedule-table">
            <thead>
            <tr style="background-color: #fff;">
                <th style="width: 15%;"></th>
                <th style="width: 85%; font-size: small">
                    <table style="width: 100%; height: 100%; border: none; border: none; border-spacing: 0; border-collapse: collapse;">
                        <tr style="width: 100%; height: 100%;">
                            <th style="width: 28%; height: 100%;">时间</th>
                            <th style="width: 24%; height: 100%; border-left: 1px solid #ea875f; border-right: 1px solid #ea875f;">授课年级</th>
                            <th style="width: 48%; height: 100%;">授课内容</th>
                        </tr>
                    </table>
                </th>
            </tr>
            </thead>
            <tbody id="day"></tbody>
        </table>
    </div>
</article>
<article id="futureNote" style="display: none;">
    <div class="goBack"></div>
</article>

<template id="playing-template"></template>
<template id="future-template"></template>

<template id="passed-template"></template>

<template id="day-template">
    <tr class="color">
        <td style="width: 15%;">星期${day}<br>(${date})</td>
        <td style="width: 85%;">
            <table style="width: 100%; height: 100%; border: none; border-spacing: 0; border-collapse: collapse;">
                <tbody data-ext-point="items" class="data"></tbody>
            </table>
        </td>
    </tr>
</template>
<template id="item-template">
    <tr>
        <td style="width: 28%;">${st}-${et}</td>
        <td style="width: 24%; border-top: none; border-bottom: none; border-left: 1px solid #ea875f; border-right: 1px solid #ea875f;">${grade}</td>
        <td style="width: 48%;">${title}</td>
    </tr>
</template>

<script src="/jquery/jquery-3.1.1.min.js"></script>
<script src="/bootstrap/bootstrap.min.js"></script>
<script src="/moment/moment.min.js"></script>
<script src="/util.js"></script>
<script src="/basic.js"></script>
<script>
    //{..., teachers: [], grades: [], playings: [], futures: [], ...}
    var subjects = []

    var passed = []

    var courseTable = [
        {day: '一', date: '', items: []},
        {day: '二', date: '', items: []},
        {day: '三', date: '', items: []},
        {day: '四', date: '', items: []},
        {day: '五', date: '', items: []}
    ]

    var state = {
        currentArticle: document.getElementById('main'),
        main: {
            isInit: false,
            init: function() {
                if (!state.main.isInit) {
                    $(document).on('click', '@@', function () {
                        //
                    })

                    var now = Date.now()

                    $.ajax({
                        type: 'get',
                        url: '/api/schedulers?filter=' + JSON.stringify({
                            subjectId: subjects[0].id,
                            endTime: '> ' + now
                        }),
                        dataType: 'json',
                        success: function (zeroSchedulers) {
                            subjects[0].playing = zeroSchedulers[0]
                            subjects[0].futures = zeroSchedulers[1]
                            state.adjustData(0)
                            state.oneFuture.data = subjects[0].futures
                            state.onePlaying.data = subjects[0].playing
                            state.refreshState(0)
                            $.ajax({
                                type: 'get',
                                url: '/api/schedulers?filter=' + JSON.stringify({
                                    subjectId: subjects[1].id,
                                    endTime: '> ' + now
                                }),
                                dataType: 'json',
                                success: function (oneSchedulers) {
                                    subjects[1].playing = oneSchedulers[0]
                                    subjects[1].futures = oneSchedulers[1]
                                    state.adjustData(1)
                                    state.oneFuture.data = subjects[1].futures
                                    state.onePlaying.data = subjects[1].playing
                                    state.refreshState(1)

                                    var oneFirst = true
                                    if (subjects[0].playing.length > 0) {
                                        if (subjects[1].playing.length > 0) {
                                            if (+subjects[0].playing[0].startTime < +subjects[1].playing[0].startTime) {
                                                oneFirst = false
                                            }
                                        } else {
                                            oneFirst = false
                                        }
                                    } else if (subjects[0].futures.length > 0) {
                                        if (subjects[1].futures.length > 0) {
                                            if (+subjects[0].futures[0].startTime < +subjects[1].futures[0].startTime) {
                                                oneFirst = false
                                            }
                                        } else {
                                            oneFirst = false
                                        }
                                    } else {
                                        oneFirst = false
                                    }
                                    if (oneFirst) {
                                        $('#subjects').find('a[href="#one"]').tab('show') // Select tab by name
                                        //$('#subjects').find('a:first').tab('show') // Select first tab
                                        //$('#subjects').find('a:last').tab('show') // Select last tab
                                        //$('#subjects').find('li:eq(2) a').tab('show') // Select third tab (0-indexed)
                                    }

                                    setInterval(function () {
                                        state.refreshState(0)
                                        state.refreshState(1)
                                    }, 60 * 1000)
                                }
                            })
                        }
                    })

                    state.main.isInit = true
                }
            },
            getGrade: function (gradeValue) {
                var result = ''
                if (gradeValue == 1) {
                    result = '一年级'
                } else if (gradeValue == 2) {
                    result = '二年级'
                } else if (gradeValue == 3) {
                    result = '三年级'
                } else if (gradeValue == 4) {
                    result = '四年级'
                } else if (gradeValue == 5) {
                    result = '五年级'
                } else if (gradeValue == 6) {
                    result = '六年级'
                } else if (gradeValue == 20) {
                    result = '低年级'
                } else {
                    result = '高年级'
                }
                return result
            },
            adjustData: function (subjectIndex) {
                for (var i = 0; i < subjects[subjectIndex].playing.length; ++i) {
                    var item = subjects[subjectIndex].playing[i]
                    item.grade = state.getGrade(item.grade)
                    item.startTime = Date.parse(item.startTime.replace('-', '/'))
                    item.endTime = Date.parse(item.endTime.replace('-', '/'))
                    item.year = item.startTime.getFullYear()
                    item.month = item.startTime.getMonth() + 1
                    item.date = item.startTime.getDate()
                }
                for (var i = 0; i < subjects[subjectIndex].futures.length; ++i) {
                    var item = subjects[subjectIndex].playing[i]
                    item.grade = state.getGrade(item.grade)
                    item.startTime = Date.parse(item.startTime.replace('-', '/'))
                    item.endTime = Date.parse(item.endTime.replace('-', '/'))
                    item.year = item.startTime.getFullYear()
                    item.month = item.startTime.getMonth() + 1
                    item.date = item.startTime.getDate()
                }
            },
            refreshState: function (subjectIndex) {
                var now = new Date()
                for (var i = 0; i < subjects[subjectIndex].playing.length; ++i) {
                    var endTime = subjects[subjectIndex].playing[i].endTime
                    if (+endTime < +now) {
                        subjects[subjectIndex].playing.splice(i, 1)
                    }
                }
                for (var i = 0; i < subjects[subjectIndex].futures.length; ++i) {
                    var startTime = subjects[subjectIndex].futures[i].startTime
                    startTime = new Date(+startTime - 15 * 60 * 1000)
                    if (+startTime < +now) {
                        subjects[subjectIndex].playing.unshift(subjects[subjectIndex].futures[i])
                        subjects[subjectIndex].futures.splice(i, 1)
                    }
                }
                switch (subjectIndex) {
                    case 0:
                        state.zeroFuture.container.innerHTML = ''
                        proc(state.zeroFuture)
                        state.zeroPlaying.container.innerHTML = ''
                        proc(state.zeroPlaying)
                        break
                    case 1:
                        state.oneFuture.container.innerHTML = ''
                        proc(state.oneFuture)
                        state.onePlaying.container.innerHTML = ''
                        proc(state.onePlaying)
                        break
                    default:
                        break
                }
            },
            zeroFuture: {
                container: document.getElementById(''),
                template: document.getElementById(''),
                data: null
            },
            zeroPlaying: {
                container: document.getElementById(''),
                template: document.getElementById(''),
                data: null
            },
            oneFuture: {
                container: document.getElementById(''),
                template: document.getElementById(''),
                data: null
            },
            onePlaying: {
                container: document.getElementById(''),
                template: document.getElementById(''),
                data: null
            },
            schedulerEntry: document.getElementById('schedulerEntry'),
            teacherChoice: document.getElementById('teacherChoice'),
            gradeChoice: document.getElementById('gradeChoice'),
            keywords: document.getElementById('keywords'),
            search: function() {
                //filter the playing and future data via the filter element state
            }
        },
        passed: {
            isInit: false,
            init: function() {
                if (!state.passed.isInit) {
                    $.ajax({
                        type: 'get',
                        url: '/api/schedulers/teachers?filter=' + JSON.stringify({subjectId: subjects[0].id}),
                        success: function(ts) {
                            subjects[0].teachers = ts
                            $.ajax({
                                type: 'get',
                                url: '/api/schedulers/teachers?filter=' + JSON.stringify({subjectId: subjects[1].id}),
                                success: function(ts) {
                                    subjects[1].teachers = ts
                                    //fill to teachers choice
                                }
                            })
                        }
                    })

                    $.ajax({
                        type: 'get',
                        url: '/api/schedulers/grades?filter=' + JSON.stringify({subjectId: subjects[0].id}),
                        success: function(gs) {
                            subjects[0].grades = gs
                            $.ajax({
                                type: 'get',
                                url: '/api/schedulers/grades?filter=' + JSON.stringify({subjectId: subjects[1].id}),
                                success: function(gs) {
                                    subjects[1].grades = gs
                                    //fill to grades choice
                                }
                            })
                        }
                    })

                    var now = Date.now()
                    $.ajax({
                        type: 'get',
                        url: '/api/schedulers?filter=' + JSON.stringify({
                            cdnLink: 'IS NOT NULL',
                            endTime: '< ' + +now
                        }),
                        dataType: 'json',
                        success: function (schedulers) {
                            passed = schedulers[2]
                        }
                    })

                    state.passed.isInit = true
                }
            },
            search: function() {
                //filter the passed data via the filter element state
            },
            showPassed: function (state, moreId, tips) {
                proc(state)
                document.getElementById(moreId).style.display = 'none'
                var tips = document.getElementById(tips)
                tips.innerHTML = '没有更多视频，敬请期待'
            },
            zeroPassed: {
                container: document.getElementById(''),
                template: document.getElementById(''),
                data: null,
                show: function () {
                    state.showPassed(state.zeroPassed, 'zeroMore', 'zeroTips')
                }
            },
            onePassed: {
                container: document.getElementById(''),
                template: document.getElementById(''),
                data: null,
                show: function () {
                    state.showPassed(state.onePassed, 'oneMore', 'oneTips')
                }
            }
        },
        scheduler: {
            isInit: false,
            init: function() {
                if (!state.scheduler.isInit) {
                    state.scheduler.year = state.scheduler.now.getFullYear()
                    var m = moment(state.scheduler.now)
                    state.scheduler.week = m.week()
                    state.scheduler.weekDay = m.day()
                    state.scheduler.weekElement.innerHTML = state.scheduler.week - 41

                    $.ajax({
                        type: "get",
                        url: '/api/schedulers/years/' + state.scheduler.year + '/weeks/' + state.scheduler.week,
                        dataType: "json",
                        success: function (result) {
                            var course = result
                            var monday = state.scheduler.now
                            if (state.scheduler.weekDay > 1) {
                                monday = new Date(+state.scheduler.now - (state.scheduler.weekDay - 1) * 24 * 60 * 60 * 1000)
                            }
                            for (var i = 0; i < course.length; ++i) {
                                course[i].st = course[i].startTime.substr(11, 5)
                                course[i].et = course[i].endTime.substr(11, 5)
                                course[i].grade = state.getGrade(course[i].grade)
                                switch (course[i].day) {
                                    case 1:
                                        if (courseTable[0].date == '') {
                                            courseTable[0].date = monday.getFullYear() + '-' + (monday.getMonth() + 1) + '-' + monday.getDate()
                                        }
                                        courseTable[0].items.push(course[i])
                                        break
                                    case 2:
                                        if (courseTable[1].date == '') {
                                            var t = new Date(+monday + 24 * 60 * 60 * 1000)
                                            courseTable[1].date = t.getFullYear() + '-' + (t.getMonth() + 1) + '-' + t.getDate()
                                        }
                                        courseTable[1].items.push(course[i])
                                        break
                                    case 3:
                                        if (courseTable[2].date == '') {
                                            var t = new Date(+monday + 2 * 24 * 60 * 60 * 1000)
                                            courseTable[2].date = t.getFullYear() + '-' + (t.getMonth() + 1) + '-' + t.getDate()
                                        }
                                        courseTable[2].items.push(course[i])
                                        break
                                    case 4:
                                        if (courseTable[3].date == '') {
                                            var t = new Date(+monday + 3 * 24 * 60 * 60 * 1000)
                                            courseTable[3].date = t.getFullYear() + '-' + (t.getMonth() + 1) + '-' + t.getDate()
                                        }
                                        courseTable[3].items.push(course[i])
                                        break
                                    case 5:
                                        if (courseTable[4].date == '') {
                                            var t = new Date(+monday + 4 * 24 * 60 * 60 * 1000)
                                            courseTable[4].date = t.getFullYear() + '-' + (t.getMonth() + 1) + '-' + t.getDate()
                                        }
                                        courseTable[4].items.push(course[i])
                                        break
                                }
                            }
                            proc({
                                containerId: 'day',
                                data: courseTable,
                                templateId: 'day-template',
                                secondBind: {
                                    extPoint: 'items',
                                    dataFieldName: 'items',
                                    templateId: 'item-template'
                                }
                            })
                        }
                    })

                    state.scheduler.isInit = true
                }
            },
            now: Date.now(),
            year: null,
            week: null,
            weekDay: null,
            weekElement: document.getElementById("week")
        },
        init: function() {
            var userId = g.getUrlParameter('userid')
            g.setCookie('userId', userId)

            $.ajax({
                type: 'get',
                url: '/api/subjects',
                dataType: 'json',
                success: function (ss) {
                    subjects = ss

                    state['main'].init()
                    history.pushState(null, null, '/videos.html#main')
                },
                error: function (xhr) {
                    alert('back-end not response, places retry')
                }
            })

            var switchTo = function(id) {
                state.currentArticle.style.display = 'none'
                state.currentArticle = document.getElementById(id)
                state.currentArticle.style.display = 'block'
                history.pushState(null, null, '/video.html#' + id)
                state[id].init()
            }

            $(document).on('click', '[data-article]', function(e) {
                var id = e.target.dataset.article
                switchTo(id)
            })

            window.addEventListener('hashchange', function(e) {
                var hashPos = e.newURL.indexOf('#')
                var hash = e.newURL.substring(hashPos + 1)
                switchTo(hash)
            })
        }
    }

    state.init()
</script>
</body>
</html>