<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Math Knowledge Point</title>
    <script src="jquery/jquery.min.js"></script>
</head>
<body>
<section>
    <h1 id="title1"></h1>
    <h2 id="title2"></h2>
</section>
<section>
    <h2>非常挑战</h2>
    <ul id="challenge"></ul>
</section>
<section>
    <h2>最强讲解</h2>
    <section id="content"></section>
</section>
<section id="video"></section>
<section>
    <h2>最强大脑</h2>
    <dl id="strongest-brain"></dl>
</section>
<section>
    <h2>脑力大PK</h2>
    <dl id="pk"></dl>
</section>
<section id="interaction"></section>
<section>
    <span>写留言<img src="pen.jpg" alt="写留言"/></span>
    <section id="comments"></section>
</section>
<template id="title1-template">
    <span>${title1}</span>
</template>
<template id="title2-template">
    <span>${title2}</span>
</template>
<template id="challenge-template">
    <section>${content}</section>
    <!-- ... -->
</template>
<template id="content-text-template">
    <p>${content}</p>
    <!-- ... -->
</template>
<template id="content-image-template">
    <p>
        <img src="${href}" alt="${description}"/>
        ${content}
    </p>
    <!-- ... -->
</template>
<template id="video-template">
    <span>
        <video src="${href}">
            <img src="${coverHref}" alt="${coverDescription}"/>
        </video>
    </span>
</template>
<template id="strongest-brain-option-template">
    <li>${option}</li>
</template>
<template id="strongest-brain-template">
    <div>
        <dt><span>${type}</span>${title}</dt>
        <dd>
            <ol type="A" data-ext-point="options"></ol>
            <div data-ext-point="explain"></div>
        </dd>
    </div>
    <!-- ... -->
</template>
<template id="pk-template">
    <div>
        <dt><span>${type}</span>${title}</dt>
        <dd>
            <ol type="A" data-ext-point="options"></ol>
            <span>将你得智慧结晶写在这里吧:</span><br/>
            <textarea></textarea>
        </dd>
    </div>
</template>
<template id="interaction-template">
    <div>
        <span>阅读</span><span>${readCount}</span>
        <span><img src="like.jpg" alt="like"/></span><span>${likeCount}</span>
        <a href="${previous}">previous</a><a href="${next}">next</a>
    </div>
</template>
<template id="comment-template">
    <article>
        <img src="${avatar}" alt=""/>
        <span>${name}</span>
        <span><img src="like.jpg" alt="like"/></span><span>${likeCount}</span>
        <section>${content}</section>
        <time>${time}</time>
    </article>
    <!-- ... -->
</template>
<script>
    $(function () {
        let data = {
            title1: '挑战三',
            title2: '找路线走一走',
            challenge: [
                {
                    content: '欢迎你加入奥妙数学战队，本期你将要挑战的是“认识位置中的上下左右、东西南北、东南、西南、东北、西北。在认识位置的基础上借助各自找路线。”赶紧开始吧！',
                }
            ],
            contents: [
                {
                    type: 'text',
                    content: '今天，我们教小朋友们学习辨认方向。'
                },
                {
                    type: 'image-text',
                    href: '',
                    description: 'directions',
                    content: '如图， 东东在正中间， 阿猫在东东的前面，阿狗在它后面，小猪在它左面，小牛在它右面。'
                },
                {
                    type: 'image-text',
                    href: '',
                    description: 'directions',
                    content: '小马在东东的左前方， 小兔在它的右前方， 大象在它的右后方，而小驴则在它的左后方。'
                },
                {
                    type: 'image-text',
                    href: '',
                    description: 'directions',
                    content: '从图中不难看出，东东脸朝的方向就是前，屁股朝的方向就是后，左手的方向就是左，右手的方向就是右。'
                },
                {
                    type: 'text',
                    content: '下面，我们发出指令，让小动物们向后转。'
                },
                {
                    type: 'image-text',
                    href: '',
                    description: 'directions',
                    content: '快看，东东周围的小动物的位置发生了很的变化。现在，它的前是阿狗，后面是阿猫，边是小牛，右边是小猪。'
                },
                {
                    type: 'text',
                    content: '第一段舞跳完了。在第二段舞中，它们手拉手围成了圈。'
                },
                {
                    type: 'image-text',
                    href: '',
                    description: 'directions',
                    content: '图中的位置关系可以直接用东东的左右手来区分。东东左手拉着的就在它左边，右手拉着的就在它右边。所以它的左边是阿狗，右边是小驴。'
                },
                {
                    type: 'text',
                    content: '判断位置时，关键是要认清东东的左右手，然后就能判断它的左边和右边分别是谁了。接下来，你可以继续发号指令，让小动物们向左转，或是向右转吧！'
                }
            ],
            video: {
                href: '',
                coverHref: '',
                coverDescription: '塞花飘客泪,边柳挂乡愁'
            },
            strongestBrains: [
                {
                    type: '单选题',
                    title: '红队队员杨杨站在队伍的最前面，下图中哪个是杨杨呢？',
                    options: [{option: '*'}, {option: '**'}, {option: '***'}, {option: '****'}],
                    video: {
                        href: '',
                        coverHref: '',
                        coverDescription: '塞花飘客泪,边柳挂乡愁'
                    }
                },
                {
                    type: '多选题',
                    title: '如下图所示，雷雷在山山的哪边？',
                    options: [{option: '****'}, {option: '***'}, {option: '**'}, {option: '*'}],
                    video: {
                        href: '',
                        coverHref: '',
                        coverDescription: '塞花飘客泪,边柳挂乡愁'
                    }
                }
            ],
            pk: {
                type: '多选题',
                title: '快和父母比比，看谁能先找出长颈鹿的左后腿吧！',
            },
            interaction: {
                readCount: 10000,
                likeCount: 3000,
                previous: '',
                next: ''
            },
            comments: [
                {
                    avatar: '',
                    name: '张三',
                    likeCount: 20,
                    content: 'so easy',
                    time: '一天前'
                },
                {
                    avatar: '',
                    name: '李四',
                    likeCount: 20,
                    content: 'so hard',
                    time: '三天前'
                }
            ]
        }

        let doc = document

        let getTemplate = function (templateId) {
            let result
            let template = doc.getElementById(templateId)
            if (template) {
                result = template.content.children[0]
            }
            return result
        }

        let bind = function (element, data) {
            element.innerHTML = element.innerHTML.replace('%7B', '{').replace('%7D', '}').replace(/\$\{(\w+)\}/g, function (all, variable) {
                let result = ''
                if (variable) {
                    result = data[variable]
                }
                return result
            })
        }

        let proc = function (option) {
            let template = option.template
            if (!template) {
                template = getTemplate(option.templateId)
            }
            let templates
            if (option.alterTemplates) {
                templates = []
                for (let i = 0; i < option.alterTemplates.length; ++i) {
                    let template = getTemplate(option.alterTemplates[i].templateId)
                    if (template) {
                        templates.push({type: option.alterTemplates[i].type, template: template})
                    }
                }
            }
            let container = option.container
            if (!container) {
                container = doc.getElementById(option.containerId)
            }
            if ((template || templates) && container) {
                if (Array.isArray(option.data)) {
                    let secondTemplates = []
                    if (option.secondBind) {
                        if (Array.isArray(option.secondBind)) {
                            for (let i = 0; i < option.secondBind.length; ++i) {
                                let secondTemplate = getTemplate(option.secondBind[i].templateId)
                                secondTemplates.push({
                                    extPoint: option.secondBind[i].extPoint,
                                    template: secondTemplate
                                })
                            }
                        } else {
                            let secondTemplate = getTemplate(option.secondBind.templateId)
                            secondTemplates.push({extPoint: option.secondBind.extPoint, template: secondTemplate})
                        }
                    }
                    for (let i = 0; i < option.data.length; ++i) {
                        let element
                        if (template) {
                            element = template.cloneNode(true)
                        } else if (templates) {
                            for (let j = 0; j < templates.length; ++j) {
                                if (option.data[i].type == templates[j].type) {
                                    element = templates[j].template.cloneNode(true)
                                    break
                                }
                            }
                        }
                        bind(element, option.data[i])
                        if (option.secondBind) {
                            let secondContainer
                            let secondIndex
                            if (Array.isArray(option.secondBind)) {
                                for (let j = 0; j < option.secondBind.length; ++j) {
                                    if (option.secondBind[j].extPoint == option.secondBind.extPoint) {
                                        secondIndex = j
                                        secondContainer = element.querySelector('*[data-ext-point="' + option.secondBind[j].extPoint + '"]')
                                        break
                                    }
                                }
                            } else {
                                secondContainer = element.querySelector('*[data-ext-point="' + option.secondBind.extPoint + '"]')
                            }
                            let secondTemplate
                            for (let j = 0; j < secondTemplates.length; ++j) {
                                if (secondTemplates[j].extPoint == option.secondBind.extPoint) {
                                    secondTemplate = secondTemplates[j].template
                                }
                            }
                            let secondData = option.data[i][option.secondBind.dataFieldName]
                            if (Array.isArray(option.secondBind)) {
                                secondData = option.data[i][option.secondBind[secondIndex].dataFieldName]
                            }
                            if (secondContainer && secondTemplate) {
                                proc({
                                    container: secondContainer,
                                    template: secondTemplate,
                                    data: secondData
                                })
                            }
                        }
                        container.appendChild(element)
                    }
                } else {
                    let element = template.cloneNode(true)
                    bind(element, option.data)
                    if (option.secondBind) {
                        let secondContainer
                        let secondIndex
                        if (Array.isArray(option.secondBind)) {
                            for (let j = 0; j < option.secondBind.length; ++j) {
                                if (option.secondBind[j].extPoint == option.secondBind.extPoint) {
                                    secondIndex = j
                                    secondContainer = element.querySelector('*[data-ext-point="' + option.secondBind[j].extPoint + '"]')
                                    break
                                }
                            }
                        } else {
                            secondContainer = element.querySelector('*[data-ext-point="' + option.secondBind.extPoint + '"]')
                        }
                        let secondTemplate
                        for (let j = 0; j < secondTemplates.length; ++j) {
                            if (secondTemplates[j].extPoint == option.secondBind.extPoint) {
                                secondTemplate = secondTemplates[j].template
                            }
                        }
                        let secondData = option.data[option.secondBind.dataFieldName]
                        if (Array.isArray(option.secondBind)) {
                            secondData = option.data[option.secondBind[secondIndex].dataFieldName]
                        }
                        if (secondContainer && secondTemplate) {
                            proc({
                                container: secondContainer,
                                template: secondTemplate,
                                data: secondData
                            })
                        }
                    }
                    container.appendChild(element)
                }
            }
        }

        proc({
            templateId: 'title1-template',
            data: data,
            containerId: 'title1'
        })

        proc({
            templateId: 'title2-template',
            data: data,
            containerId: 'title2'
        })

        proc({
            templateId: 'origin-template',
            data: data.origins,
            containerId: 'origin'
        })

        proc({
            data: data.contents,
            containerId: 'content',
            alterTemplates: [
                {type: 'text', templateId: 'content-text-template'},
                {type: 'image', templateId: 'content-image-template'}
            ]
        })

        proc({
            templateId: 'video-template',
            data: data.video,
            containerId: 'video'
        })

        proc({
            templateId: 'strongest-brain-template',
            data: data.strongestBrains,
            containerId: 'strongest-brain',
            secondBind: [
                {
                    extPoint: 'options',
                    dataFieldName: 'options',
                    templateId: 'strongest-brain-option-template'
                },
                {
                    extPoint: 'explain',
                    dataFieldName: 'video',
                    templateId: 'video-template'
                }
            ]
        })

        proc({
            templateId: 'pk-template',
            data: data.pk,
            containerId: 'pk'
        })

        proc({
            templateId: 'interaction-template',
            data: data.interaction,
            containerId: 'interaction'
        })

        proc({
            templateId: 'comment-template',
            data: data.comments,
            containerId: 'comments'
        })
    })
</script>
</body>
</html>