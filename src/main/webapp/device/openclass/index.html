<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>大屏-直播课</title>
</head>
<body>
<article id="main">
    <h1 class="logo_section">
        <a href="index.html" class="logo" title="小雨知时">小雨知时</a>
    </h1>
    <div class="today_live">
        <h3 class="today_live_title">今日直播</h3>
        <ul class="live_list"></ul>
    </div>
    <div class="review">
        <h3 class="today_live_title">往期回顾</h3>
        <ul class="subject_tab"></ul>
        <!-- 语文 -->
        <div class="subject_content cur">
            <ul class="review_list"></ul>
            <!-- 页码 -->
            <p class="page">
                <a href="javascript:;" class="page_next">上一页</a>
                <a href="javascript:;" class="page_num cur">1</a>
                <a href="javascript:;" class="page_num">2</a>
                <a href="javascript:;" class="page_num">3</a>
                <a href="javascript:;" class="page_num">4</a>
                <a href="javascript:;" class="page_num">5</a>
                <a href="javascript:;" class="page_spot">...</a>
                <a href="javascript:;" class="page_num">23</a>
                <a href="javascript:;" class="page_next">下一页</a>
            </p>
        </div>
        <!-- 数学 -->
        <div class="subject_content">
            <ul class="review_list"></ul>
            <!-- 页码 -->
            <p class="page">
                <a href="javascript:;" class="page_next">上一页</a>
                <a href="javascript:;" class="page_num cur">1</a>
                <a href="javascript:;" class="page_num">2</a>
                <a href="javascript:;" class="page_num">3</a>
                <a href="javascript:;" class="page_num">4</a>
                <a href="javascript:;" class="page_num">5</a>
                <a href="javascript:;" class="page_spot">...</a>
                <a href="javascript:;" class="page_num">23</a>
                <a href="javascript:;" class="page_next">下一页</a>
            </p>
        </div>
    </div>
</article>
<article id="detail"></article>
<article id="cover"></article>
<article id="content"></article>

<template id="live-template">
    <li class="live_item">
        <a href="play.html" class="live_video">
            <img src="images/live_in.png" alt="" class="live_state">
            <div class="bean_time">
                <div class="gold_bean"><span>150</span>金豆</div>
            </div>
            <div class="course_title">
                <div class="course_big_title">写人作文</div>
                <div class="course_small_title">写作手法+得分技巧</div>
            </div>
            <div class="grade_teacher">
                <span>一年级</span>
                <span class="split_line"></span>
                <span>刘志超</span>
            </div>
        </a>
        <div class="live_title_section">
            <span class="live_title">语文作文与写作手法语文作文与写作写</span>
            <a href="details.html" class="title_details">详情</a>
        </div>
    </li>
</template>
<template id="future-template">
    <li class="live_item">
        <a href="javascript:;" class="live_video">
            <img src="images/wait.png" alt="" class="live_state">
            <div class="bean_time">
                <div class="play_time">18:30开讲</div>
                <div class="gold_bean"><span>150</span>金豆</div>
            </div>
            <div class="course_title">
                <div class="course_big_title">汉字拼音</div>
                <div class="course_small_title">写作手法+得分技巧</div>
            </div>
            <div class="grade_teacher">
                <span>一年级</span>
                <span class="split_line"></span>
                <span>刘志超</span>
            </div>
            <div class="wait_cover"></div>
        </a>
        <div class="live_title_section">
            <span class="live_title">语文作文与写作手法语文作文与写作写</span>
            <a href="javascript:;" class="title_details">详情</a>
        </div>
    </li>
</template>
<template id="subject-tab-template">
    <li class="subject_math">数学(<span>2</span>)</li>
</template>
<template id="passed-chinese-template">
    <li class="live_item">
        <a href="javascript:;" class="live_video">
            <div class="bean_time">
                <div class="review_gold_bean"><span>20</span>金豆</div>
            </div>
            <div class="course_title">
                <div class="course_big_title">写人作文</div>
                <div class="course_small_title">写作手法+得分技巧</div>
            </div>
            <div class="grade_teacher">
                <span>一年级</span>
                <span class="split_line"></span>
                <span>刘志超</span>
                <span>2016-11-16</span>
            </div>
        </a>
        <div class="live_title_section">
            <span class="live_title">语文作文与写作手法语文作文与写作写</span>
            <a href="javascript:;" class="title_details">详情</a>
        </div>
    </li>
</template>
<template id="passed-math-template">
    <li class="live_item">
        <a href="javascript:;" class="review_math">
            <div class="bean_time">
                <div class="review_gold_bean"><span>20</span>金豆</div>
            </div>
            <div class="course_title">
                <div class="course_big_title">画图推理</div>
                <div class="course_small_title">加减乘除+寻找规律</div>
            </div>
            <div class="grade_teacher">
                <span>一年级</span>
                <span class="split_line"></span>
                <span>刘志超</span>
                <span>2016-11-16</span>
            </div>
        </a>
        <div class="live_title_section">
            <span class="live_title">掌握用凑十法计算20以内的加减法</span>
            <a href="javascript:;" class="title_details_math">详情</a>
        </div>
    </li>
</template>

<script src="/jquery/jquery-3.1.1.min.js"></script>
<script>
    var lives = []
    var futures = []
    var subjects = []
    var state = {
        init: function() {
            var now = Date.now()
            var getPassed = function() {
                $.ajax({
                    type: 'get',
                    url: '/api/subjects',
                    success: function(s) {
                        subjects = s
                        for (var i = 0; i < subjects.length; ++i) {
                            $.ajax({
                                type: 'get',
                                url: '/api/schedulers?filter=' + encodeURIComponent(JSON.stringify({
                                    subjectId: subjects[i].id,
                                    endTime: '< ' + now + '::timestamp'
                                })),
                                success: function (d) {
                                    for (var i = 0; i < d.length; ++i) {
                                        var item = d[i]
                                        item.startTime = Date.parse(item.startTime.replace(/-/g, '/'))
                                        item.endTime = Date.parse(item.endTime.replace(/-/g, '/'))
                                    }
                                    var s = state.getSubjectById(d[0].subjectId)
                                    s.passed = d
                                }
                            })
                        }
                        for (var i = 0; i < subjects.length; ++i) {
                            if (!subjects[i].passed) {
                                subjects.splice(i, 1)
                                --i
                            }
                        }
                    }
                })
            }
            $.ajax({
                type: 'get',
                url: '/api/schedulers?filter=' + encodeURIComponent(JSON.stringify({
                    endTime: '> ' + now + '::timestamp'
                })),
                success: function(d) {
                    for (var i = 0; i < d.length; ++i) {
                        var item = d[i]
                        item.startTime = Date.parse(item.startTime.replace(/-/g, '/'))
                        item.endTime = Date.parse(item.endTime.replace(/-/g, '/'))
                        if (+item.startTime < now) {
                            lives.push(item)
                        } else {
                            futures.push(item)
                        }
                    }
                    getPassed()
                },
                error: function(r) {
                    if (r.status == 404) {
                        getPassed()
                    }
                }
            })
        },
        getSubjectById: function(id) {
            var result = null;
            for (var i = 0; i < subjects.length; ++i) {
                if (subjects[i].id == id) {
                    result = subjects[i]
                    break
                }
            }
            return result
        },
        main: {},
        detail: {},
        cover: {},
        content: {}
    }

    state.init()
</script>
</body>
</html>