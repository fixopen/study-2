<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Active Card</title>

    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0,user-scalable=no"
          id="viewport"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="screen-orientation" content="portrait">

    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/index.css">

    <script type="text/javascript" src="zepto/zepto.min.js"></script>
    <script type="text/javascript" src="zepto/touch.js"></script>
    <script type="text/javascript" src="zepto/selector.js"></script>
    <script type="text/javascript" src="util.js"></script>
</head>
<body>
<div id="warp" class="wrap">
    <div class="set-main">
        <ul class="set-ul">
            <li class="set-li">
                <span class="set-span">卡号</span>
                <input type="text" placeholder="请输入卡号" id="cardCode" required pattern="\d+">
            </li>
            <li class="set-li">
                <span class="set-span">密码</span>
                <input type="password" placeholder="请输入密码" id="password" required>
            </li>
            <li class="set-li">
                <span class="set-span">手机号</span>
                <input type="tel" placeholder="请输入手机号" id="phoneNumber" required pattern="\d+">
                <input type="button" class="send-btn cur" value="获取手机验证码" id="activeCode">
            </li>
            <li class="set-li">
                <span class="set-span">验证码</span>
                <input type="text" placeholder="请输入验证码" id="validationCode" required pattern="\d{6}">
            </li>
        </ul>
        <div class="tip" id="tips">卡片验证码将发送至此手机!</div>
        <div id="save" class="btn-box save-btn">确 认</div>
    </div>
</div>
<script>
    let userId
    let openId = g.getUrlParameter('openid')

    $.ajax({
        type: 'get',
        url: 'api/wechat-users/' + openId + "/identities",
        dataType: 'json',
        success: function (ids) {
            userId = ids.userId
            g.setCookie('sessionId', ids.sessionId)
        }
    })

    $('#save').tap(function (e) {
        var data = {userId: userId}
        data.cardCode = document.getElementById('cardCode').value
        data.password = document.getElementById('password').value
        data.phonecode = document.getElementById('phoneNumber').value
        data.validationCode = document.getElementById('validationCode').value
        $.ajax({
            type: 'POST',
            url: 'api/users/cards',
            contentType: 'application/json',
            data: data,
            dataType: 'json',
            success: function (result) {
                window.location.href = 'Gold.html'
            },
            error: function (result) {
                let tips = document.getElementById("tips")
                switch (result.statusCode) {
                    case 500:
                        tips.innerHTML = "后台错误500，请联系程序猿叔叔。email：15210038357@163.com";
                        break;
                    case 412:
                        tips.innerHTML = "请返回的我的首页";
                        break;
                    case 520:
                        tips.innerHTML = "后台错误520，请联系程序猿叔叔。email：15210038357@163.com";
                        break;
                    case 404:
                        tips.innerHTML = "用户名或密码错误";
                        break;
                    case 405:
                        tips.innerHTML = "不可以重复激活";
                        break;
                    case 401:
                        tips.innerHTML = "手机号或验证码错误";
                        break;
                    case 410:
                        tips.innerHTML = "验证码超时";
                        break;
                    case 200:
                        window.location.href = 'Gold.html';
                        break;
                }
            }
        })
    })

    let timeoutId
    let timeoutCount = 60
    $('#activeCode').tap(function (e) {
        let proc = function () {
            e.target.value = " (" + timeoutCount + ") 秒后\n重新发送"
            --timeoutCount
            if (timeoutCount <= 0) {
                e.target.value = " 重新发送 "
                clearInterval(timeoutId)
            }
        }
        var phoneNumber = document.getElementById('phoneNumber').value
        $.ajax({
            type: 'GET',
            url: 'api/users/telephones/' + phoneNumber + '/code',
            dataType: 'json',
            success: function (data) {
                let tips = document.getElementById("tips")
                tips.innerHTML = "发送成功，请注意查收"
            },
            error: function (r) {
                let tips = document.getElementById("tips")
                tips.innerHTML = "发送失败，请重新获取验证码"
            }
        })
        timeoutId = setInterval(proc, 1000)
    })
</script>
</body>
</html>
<!--
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>validation code</title>
</head>
<body>
<h1>Hello, world</h1>
</body>
</html>
-->