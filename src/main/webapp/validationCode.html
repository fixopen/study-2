<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>W-我的-设置-添加新卡-发送后页面</title>
    <!-- 禁止拉伸和全屏设置 -->
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0,user-scalable=no"
          id="viewport"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="screen-orientation" content="portrait">
    <!-- 引入样式表 -->
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/index.css">
    <!--
    <script type="text/javascript" src="jquery/jquery.min.js"></script>
    -->
    <script type="text/javascript" src="zepto/zepto.min.js"></script>
</head>
<body>
<div id="warp" class="wrap">
    <!-- main -->
    <div class="set-main">
        <ul class="set-ul">
            <li class="set-li">
                <span class="set-span">卡号</span>
                <input type="text" placeholder="请输入卡号" id="cardCode" required pattern="\d+">
            </li>
            <li class="set-li">
                <span class="set-span">密码</span>
                <input type="password" placeholder="请输入密码" id="password" required>
            </li>
            <li class="set-li">
                <span class="set-span">手机号</span>
                <input type="tel" placeholder="请输入手机号" id="phonecode" required pattern="\d+">
                <input type="button" class="send-btn cur" value="获取手机验证码" id="phone_btn">
            </li>
            <li class="set-li">
                <span class="set-span">验证码</span>
                <input type="text" placeholder="请输入验证码" id="validationCode" required pattern="\d{6}">
            </li>
        </ul>
        <div class="tip" id="tipid">卡片验证码将发送至此手机!
        </div>
        <div id="save" class="btn-box save-btn">确 认</div>
    </div>
</div>
<script>
//    let userId
//    let getUrlParameter = function (name) {
//        var result = null
//        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)") //构造一个含有目标参数的正则表达式对象
//        var r = window.location.search.substr(1).match(reg) //匹配目标参数
//        if (r != null) {
//            result = decodeURI(r[2])
//        }
//        return result //返回参数值
//    }
//
//    let code = getUrlParameter('code')
//    let getTokenUrl = 'https://api.weixin.qq.com/sns/oauth2/access_token?appid=wx92dec5e98645bd1d&secret=d3b30c3ae79c322bc54c93d0ff75210b&code=' + code + '&grant_type=authorization_code'

    let ajax = function (method, url, headers, data, postProcess) {
        var xhr = new XMLHttpRequest()
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                var result = {meta: {code: xhr.status, text: xhr.statusText}, data: null}
                if (xhr.responseText[0] == '{' || xhr.responseText[0] == '[') {
                    result.data = JSON.parse(xhr.responseText)
                } else {
                    result.data = xhr.responseText
                }
                postProcess(result)
            }
        }
        xhr.open(method, url, false)
        for (var i = 0, c = headers.length; i < c; ++i) {
            xhr.setRequestHeader(headers[i].name, headers[i].value)
        }
        var sendContent = null
        if (data != null) {
            sendContent = JSON.stringify(data)
        }
        xhr.send(sendContent)
    }

    //document.getElementById("warp").style.visibility = "visible"

//    ajax('GET', getTokenUrl, [], null, function (tokenInfo) {
//        if (tokenInfo.meta.code < 400) {
//            ajax('PUT', 'api/wechat-users', [
//                {name: 'Content-Type', value: 'application/json;charset=utf-8'},
//                {name: 'Accept', value: 'application/json'},
//            ], tokenInfo, function (result) {
//                if (result.meta.code < 400) {
//                    userId = result.data.userId
//                    document.getElementById("warp").style.visibility = "visible" //显示
//                } else {
//                    alert(result.meta.code + result.data)
//                }
//            })
//        } else {
//            alert(tokenInfo.meta.code)
//        }
//    })

    let saveButton = document.getElementById('save')
    saveButton.addEventListener('click', function (e) {
        var data = {userId: userId}
        data.cardCode = document.getElementById('cardCode').value
        data.password = document.getElementById('password').value
        data.phonecode = document.getElementById('phonecode').value
        data.validationCode = document.getElementById('validationCode').value
        ajax('POST', 'api/users/cards', [{name: 'Content-Type', value: 'application/json'}], data, function (result) {
            if (result.meta.code < 400) {
                window.location.href = 'Gold.html'
            } else {
                switch (result.meta.code) {
                    case 500:
                        document.getElementById("tipid").innerHTML = "后台错误500，请联系程序猿叔叔。email：15210038357@163.com";
                        break;
                    case 412:
                        document.getElementById("tipid").innerHTML = "请返回的我的首页";
                        break;
                    case 520:
                        document.getElementById("tipid").innerHTML = "后台错误520，请联系程序猿叔叔。email：15210038357@163.com";
                        break;
                    case 404:
                        document.getElementById("tipid").innerHTML = "用户名或密码错误";
                        break;
                    case 405:
                        document.getElementById("tipid").innerHTML = "不可以重复激活";
                        break;
                    case 401:
                        document.getElementById("tipid").innerHTML = "手机号或验证码错误";
                        break;
                    case 410:
                        document.getElementById("tipid").innerHTML = "验证码超时";
                        break;
                    case 200:
                        window.location.href = 'Gold.html';
                        break;
                }
            }
        })
    }, false)


    let invoke = document.getElementById('phone_btn')
    if (invoke != null) {
        let timeoutId
        let printnr = 60
        invoke.addEventListener('click', function (e) {
            let proc = function () {
                e.target.value = " (" + printnr + ")秒后\n重新发送"
                --printnr
                if (printnr <= 0) {
                    e.target.value = " 重新发送 "
                    clearInterval(timeoutId)
                }
            }
            var phonecode = document.getElementById('phonecode').value
            ajax('GET', 'api/users/telephones/' + phonecode + '/code', [{
                name: 'Accept',
                value: 'application/json'
            }], function (r) {
                if (r.meta.code < 400) {
                    document.getElementById("tipid").innerHTML = "发送成功，请注意查收"
                } else {
                    document.getElementById("tipid").innerHTML = "发送失败，请重新获取验证码"
                }
            })
            timeoutId = setInterval(proc, 1000)
        }, false)
    }
</script>
</body>
</html>
