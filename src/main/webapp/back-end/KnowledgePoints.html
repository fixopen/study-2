<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>后台录入页面</title>
    <style>
        .active {
            background-color: yellow;
        }

        .saved {
            background-color: #b2b2b2;
        }
    </style>

    <script src="../util.js"></script>
    <script src="../jquery/jquery.min.js"></script>
</head>
<body>
<h1>后台录入页面</h1>
<table border="1">
    <tr>
        <th>科目</th>
        <th>年级</th>
        <th>标题</th>
        <th>操作</th>
        <th>知识点</th>
        <th>操作</th>
    </tr>
    <tr>
        <td><select id="subject"></select></td>
        <td><select id="grade">
            <option value="20">低年级</option>
            <option value="21">高年级</option>
        </select></td>
        <td><input type="text" id="volumeTitle"/> <select id="volumeTitleChoice"></select>
        </td>
        <td><input type="button" id="appendvolumeTitle" value="添加"/>
            <button id="updatevolumeTitle">修改</button>
        </td>
        <td><input type="text" id="knowledgePointTitle"/> <select id="knowledgePointTitleChoice"></select>
        </td>
        <td><input type="button" id="appendknowledgePointTitle" value="添加"/>
            <button id="updateknowledgePointTitle">修改</button>
        </td>
    </tr>
</table>
<div id="contents"></div>
<div id="buttons">
    <button id="appendText" data-type="text">append Text</button>
    <button id="appendImage" data-type="image">append image</button>
    <button id="appendVideo" data-type="video">append video</button>
    <button id="appendProblem" data-type="problem">append problem</button>
    <button id="appendImageText" data-type="imagetext">append imagetext</button>
    <button id="appendPinyinText" data-type="pinyintext">append pinyintext</button>
    <button id="appendQuote" data-type="quote">append quote</button>
    <button id="movePrevious">^</button>
    <button id="moveNext">V</button>
    <button id="submit">submit</button>
    <button id="save">save</button>
</div>
<div id="problems" style="hidden">

    <button id="appendProblemText" data-type="problemText">append problemText</button>
    <button id="appendProblemImage" data-type="problemImage">append problemImage</button>
    <button id="appendProblemImageText" data-type="problemImageText">append problemImageText</button>

</div>
<template id="problem-template">
    <div data-type="problem">
        问题<textarea data-type="title"></textarea>
        图片<input type="file" data-type="image"/>
        <input type="text" data-type="index"/>
        <br/>
        标准答案<input type="text" data-type="standardAnswers"/>
        <ol data-type="options"></ol>
        视频图片<input type="file" data-type="videoImg"/>
        视频路径(手动输入)<input type="text" data-type="video"/>
        <button data-type="append">append problem option</button>
    </div>
</template>
<template id="problem-option-template">
    <li data-type="option">
        <input type="file" data-type="imageo"/>
        <input type="text" data-type="content"/>
    </li>
</template>
<template id="imageText-template">
    <div data-type="imageText">
        图片<input type="file" data-type="image"/>
        文本<textarea data-type="content"></textarea>
    </div>
</template>
<template id="video-template">
    <div data-type="video">
        视频图片<input type="file" data-type="cover"/>
        视频路径<textarea data-type="storePath"></textarea>
    </div>
</template>
<template id="quote-template">
    <div data-type="quote">
        段落<textarea data-type="content"></textarea>
        出处<textarea data-type="source"></textarea>
    </div>
</template>
<template id="pinyinText-template">
    <div data-type="pinyinText">
        拼音<textarea data-type="pinyin"></textarea>
        文字<textarea data-type="content"></textarea>
    </div>
</template>
<script type="text/javascript">
    /* document.getElementById("buttons").style.visibility = "hidden";//隐藏*/
    document.getElementById("problems").style.visibility = "hidden";//隐藏
    let subjects = []
    let currentSubjectIndex = 0
    let currentSubject
    let currentGradeIndex = 0
    let currentGrade = 20
    let currentVolumeIndex = 0
    let currentVolume
    let currentKnowledgePointIndex = 0
    let currentKnowledgePoint

    $(function () {
        var problemIdDD
        $.ajax({
            type: "get",
            url: "/api/subjects",
            dataType: "json",
            async: false,
            success: function (subjectData) {
                subjects = subjectData;
                let subjectSelect = document.getElementById('subject')
                for (var i = 0; i < subjectData.length; ++i) {
                    subjects[i].low = []
                    subjects[i].high = []
                    let filter = {
                        subjectId: subjects[i].id,
                        grade: 20
                    };
                    $.ajax({
                        type: "get",
                        url: '/api/volumes?filter=' + JSON.stringify(filter),
                        async: false,
                        success: function (volumes) {
                            subjects[i].low = volumes
                            for (var j = 0; j < subjects[i].low.length; ++j) {
                                subjects[i].low[j].vsid = []
                                let filter = {
                                    subjectId: subjects[i].id,
                                    volumeId: subjects[i].low[j].id,
                                    grade: 20
                                };

                                $.ajax({
                                    type: "get",
                                    url: '/api/knowledge-points?filter=' + JSON.stringify(filter),
                                    dataType: 'json',
                                    async: false,
                                    success: function (knowledgePoint) {
                                        subjects[i].low[j].vsid = knowledgePoint
                                    }
                                })
                            }
                        }
                    });
                    filter.grade = 21;
                    $.ajax({
                        type: "get",
                        url: '/api/volumes?filter=' + JSON.stringify(filter),
                        async: false,
                        success: function (volumes) {
                            subjects[i].high = volumes
                            for (var j = 0; j < subjects[i].high.length; ++j) {
                                subjects[i].high[j].vsid = []
                                let filter = {
                                    subjectId: subjects[i].id,
                                    volumeId: subjects[i].high[j].id,
                                    grade: 21
                                };

                                $.ajax({
                                    type: "get",
                                    url: '/api/knowledge-points?filter=' + JSON.stringify(filter),
                                    dataType: 'json',
                                    async: false,
                                    success: function (knowledgePoint) {
                                        subjects[i].high[j].vsid = knowledgePoint
                                    }
                                })
                            }
                        }
                    })

                    let option = document.createElement('option')
                    option.setAttribute("value", subjects[i].id)
                    option.appendChild(document.createTextNode(subjects[i].name))
                    subjectSelect.appendChild(option)
                }

                currentSubjectIndex = 0
                subjectSelect.selectedIndex = currentSubjectIndex
                currentSubject = subjectSelect.value

                let gradeSelect = document.getElementById('grade')
                currentGradeIndex = 0
                gradeSelect.selectedIndex = currentGradeIndex
                currentGrade = gradeSelect.value

                let volumeSelect = document.getElementById('volumeTitleChoice')
                volumeSelect.innerHTML = ''
                let gradeName = 'low'
                switch (currentGrade) {
                    case 21:
                    case '21':
                        gradeName = 'high'
                        break
                    default:
                        break
                }
                for (let j = 0; j < subjects[currentSubjectIndex][gradeName].length; ++j) {
                    let option = document.createElement('option')
                    option.setAttribute("value", subjects[currentSubjectIndex][gradeName][j].id)
                    option.appendChild(document.createTextNode(subjects[currentSubjectIndex][gradeName][j].title))
                    volumeSelect.appendChild(option)
                }

                currentVolumeIndex = 0
                volumeSelect.selectedIndex = currentVolumeIndex
                currentVolume = volumeSelect.value

                let opt = volumeSelect.options.item(currentVolumeIndex)
                let volume = document.getElementById('volumeTitle')
                volume.value = opt.text

                let knowledgePointSelect = document.getElementById('knowledgePointTitleChoice')
                knowledgePointSelect.innerHTML = ''
                for (let j = 0; j < subjects[currentSubjectIndex][gradeName][currentVolumeIndex].vsid.length; ++j) {
                    let option = document.createElement('option')
                    option.setAttribute("value", subjects[currentSubjectIndex][gradeName][currentVolumeIndex].vsid[j].id)
                    option.appendChild(document.createTextNode(subjects[currentSubjectIndex][gradeName][currentVolumeIndex].vsid[j].title))
                    knowledgePointSelect.appendChild(option)
                }
                currentKnowledgePointIndex = 0
                knowledgePointSelect.selectedIndex = currentKnowledgePointIndex
                currentKnowledgePoint = knowledgePointSelect.value

                let knowledgePoint = document.getElementById('knowledgePointTitle')
                knowledgePoint.value = ''
                opt = knowledgePointSelect.options.item(currentKnowledgePointIndex)
                if (opt) {
                    knowledgePoint.value = opt.text
                }
            }

        });

        $('#subject').on('change', function (e) {
            currentSubjectIndex = e.target.selectedIndex
            currentSubject = e.target.value

            let gradeSelect = document.getElementById('grade')
            currentGradeIndex = 0
            gradeSelect.selectedIndex = currentGradeIndex
            currentGrade = gradeSelect.value

            let volumeSelect = document.getElementById('volumeTitleChoice')
            volumeSelect.innerHTML = ''
            let gradeName = 'low'
            switch (currentGrade) {
                case 21:
                case '21':
                    gradeName = 'high'
                    break
                default:
                    break
            }
            for (let i = 0; i < subjects[currentSubjectIndex][gradeName].length; ++i) {
                let option = document.createElement('option')
                option.setAttribute("value", subjects[currentSubjectIndex][gradeName][i].id)
                option.appendChild(document.createTextNode(subjects[currentSubjectIndex][gradeName][i].title))
                volumeSelect.appendChild(option)
            }

            currentVolumeIndex = 0
            volumeSelect.selectedIndex = currentVolumeIndex
            currentVolume = volumeSelect.value

            let volume = document.getElementById('volumeTitle')
            volume.value = ''
            let opt = volumeSelect.options.item(currentVolumeIndex)
            if (opt) {
                volume.value = opt.text
            }

            let knowledgePointSelect = document.getElementById('knowledgePointTitleChoice')
            knowledgePointSelect.innerHTML = ''
            for (let j = 0; j < subjects[currentSubjectIndex][gradeName][currentVolumeIndex].vsid.length; ++j) {
                let option = document.createElement('option')
                option.setAttribute("value", subjects[currentSubjectIndex][gradeName][currentVolumeIndex].vsid[j].id)
                option.appendChild(document.createTextNode(subjects[currentSubjectIndex][gradeName][currentVolumeIndex].vsid[j].title))
                knowledgePointSelect.appendChild(option)
            }
            currentKnowledgePointIndex = 0
            knowledgePointSelect.selectedIndex = currentKnowledgePointIndex
            currentKnowledgePoint = knowledgePointSelect.value

            let knowledgePoint = document.getElementById('knowledgePointTitle')
            knowledgePoint.value = ''
            opt = knowledgePointSelect.options.item(currentKnowledgePointIndex)
            if (opt) {
                knowledgePoint.value = opt.text
            }
        })

        $('#grade').on('change', function (e) {
            currentGradeIndex = e.target.selectedIndex
            currentGrade = e.target.value

            let volumeSelect = document.getElementById('volumeTitleChoice')
            volumeSelect.innerHTML = ''

            let gradeName = 'low'
            switch (currentGrade) {
                case 21:
                case '21':
                    gradeName = 'high'
                    break
                default:
                    break
            }

            for (let i = 0; i < subjects[currentSubjectIndex][gradeName].length; ++i) {
                let option = document.createElement('option')
                option.setAttribute("value", subjects[currentSubjectIndex][gradeName][i].id)
                option.appendChild(document.createTextNode(subjects[currentSubjectIndex][gradeName][i].title))
                volumeSelect.appendChild(option)
            }

            currentVolumeIndex = 0
            volumeSelect.selectedIndex = currentVolumeIndex
            currentVolume = volumeSelect.value

            let volume = document.getElementById('volumeTitle')
            volume.value = ''
            let opt = volumeSelect.options.item(currentVolumeIndex)
            if (opt) {
                volume.value = opt.text
            }

            let knowledgePointSelect = document.getElementById('knowledgePointTitleChoice')
            knowledgePointSelect.innerHTML = ''
            for (let j = 0; j < subjects[currentSubjectIndex][gradeName][currentVolumeIndex].vsid.length; ++j) {
                let option = document.createElement('option')
                option.setAttribute("value", subjects[currentSubjectIndex][gradeName][currentVolumeIndex].vsid[j].id)
                option.appendChild(document.createTextNode(subjects[currentSubjectIndex][gradeName][currentVolumeIndex].vsid[j].title))
                knowledgePointSelect.appendChild(option)
            }
            currentKnowledgePointIndex = 0
            knowledgePointSelect.selectedIndex = currentKnowledgePointIndex
            currentKnowledgePoint = knowledgePointSelect.value

            let knowledgePoint = document.getElementById('knowledgePointTitle')
            knowledgePoint.value = ''
            opt = knowledgePointSelect.options.item(currentKnowledgePointIndex)
            if (opt) {
                knowledgePoint.value = opt.text
            }

        })

        $('#volumeTitleChoice').on('change', function (e) {
            let volumeSelect = e.target
            currentVolumeIndex = volumeSelect.selectedIndex
            currentVolume = volumeSelect.value

            let volume = document.getElementById('volumeTitle')
            volume.value = ''
            let opt = volumeSelect.options.item(currentVolumeIndex)
            if (opt) {
                volume.value = opt.text
            }

            let gradeName = 'low'
            switch (currentGrade) {
                case 21:
                case '21':
                    gradeName = 'high'
                    break
                default:
                    break
            }

            let knowledgePointSelect = document.getElementById('knowledgePointTitleChoice')
            knowledgePointSelect.innerHTML = ''
            for (let j = 0; j < subjects[currentSubjectIndex][gradeName][currentVolumeIndex].vsid.length; ++j) {
                let option = document.createElement('option')
                option.setAttribute("value", subjects[currentSubjectIndex][gradeName][currentVolumeIndex].vsid[j].id)
                option.appendChild(document.createTextNode(subjects[currentSubjectIndex][gradeName][currentVolumeIndex].vsid[j].title))
                knowledgePointSelect.appendChild(option)
            }
            currentKnowledgePointIndex = 0
            knowledgePointSelect.selectedIndex = currentKnowledgePointIndex
            currentKnowledgePoint = knowledgePointSelect.value

            let knowledgePoint = document.getElementById('knowledgePointTitle')
            knowledgePoint.value = ''
            opt = knowledgePointSelect.options.item(currentKnowledgePointIndex)
            if (opt) {
                knowledgePoint.value = opt.text
            }

        })

        $('#knowledgePointTitleChoice').on('change', function (e) {
            currentKnowledgePointIndex = e.target.selectedIndex
            currentKnowledgePoint = e.target.value

            let knowledgePoint = document.getElementById('knowledgePointTitle')
            knowledgePoint.value = ''
            opt = e.target.options.item(currentKnowledgePointIndex)
            if (opt) {
                knowledgePoint.value = opt.text
            }
            /*document.getElementById("buttons").style.visibility = "hidden";//隐藏*/
            contents.innerHTML = ''
        })

        $('#appendvolumeTitle').on('click', function (e) {
            let volumeTitle = document.getElementById('volumeTitle')

            let gradeName = 'low'
            switch (currentGrade) {
                case 21:
                case '21':
                    gradeName = 'high'
                    break
                default:
                    break
            }
            let cs = subjects[currentSubjectIndex][gradeName]
            let order = 1
            if (cs.length != 0) {
                order = cs[cs.length - 1].order + 1
            }


            let data = {
                subjectId: currentSubject,
                grade: currentGrade,
                title: volumeTitle.value,
                order: order
            }
            $.ajax({
                type: "post",
                url: "/api/volumes",
                data: JSON.stringify(data),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (volume) {
                    currentVolume = volume.id
                    let gradeName = 'low'
                    switch (currentGrade) {
                        case 21:
                        case '21':
                            gradeName = 'high'
                            break
                        default:
                            break
                    }
                    volume.vsid = []
                    subjects[currentSubjectIndex][gradeName].push(volume)
                    let volumeSelect = document.getElementById('volumeTitleChoice')
                    let option = document.createElement('option')
                    option.setAttribute("value", currentVolume)
                    option.appendChild(document.createTextNode(volume.title))
                    volumeSelect.appendChild(option)
                    volumeSelect.selectedIndex = volumeSelect.options.length - 1
                    alert("添加成功")
                },
                error: function (volumeData) {
                    alert("添加失败")
                }
            })
        })

        $('#updatevolumeTitle').on('click', function (e) {
            let volumeTitle = document.getElementById('volumeTitle')
            let volumeData = {
                subjectId: currentSubject,
                grade: currentGrade,
                title: volumeTitle.value
            }
            $.ajax({
                type: "put",
                url: "/api/volumes/" + currentVolume,
                data: JSON.stringify(volumeData),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (volumeData) {
                    let gradeName = 'low'
                    switch (currentGrade) {
                        case 21:
                        case '21':
                            gradeName = 'high'
                            break
                        default:
                            break
                    }
                    volumeData.vsid = subjects[currentSubjectIndex][gradeName][currentVolumeIndex].vsid
                    subjects[currentSubjectIndex][gradeName][currentVolumeIndex] = volumeData
                    let volumeSelect = document.getElementById('volumeTitleChoice')
                    let opt = volumeSelect.options.item(currentVolumeIndex)
                    let volume = document.getElementById('volumeTitle')
                    opt.innerText = volume.value
                    alert("修改成功")
                },
                error: function (volumeData) {
                    alert("修改失败")
                }
            })
        })

        $('#appendknowledgePointTitle').on('click', function (e) {
            let knowledgePointTitle = document.getElementById('knowledgePointTitle')
            let gradeName = 'low'
            switch (currentGrade) {
                case 21:
                case '21':
                    gradeName = 'high'
                    break
                default:
                    break
            }
            let kps = subjects[currentSubjectIndex][gradeName][currentVolumeIndex].vsid
            let order = 1
            if (kps.length != 0) {
                order = kps[kps.length - 1].order + 1
            }

            let data = {
                subjectId: currentSubject,
                grade: currentGrade,
                volumeId: currentVolume,
                title: knowledgePointTitle.value,
                order: order
            }

            $.ajax({
                type: "post",
                url: "/api/knowledge-points",
                data: JSON.stringify(data),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (knowledgePoint) {
                    currentKnowledgePoint = knowledgePoint.id
                    let gradeName = 'low'
                    switch (currentGrade) {
                        case 21:
                        case '21':
                            gradeName = 'high'
                            break
                        default:
                            break
                    }
                    subjects[currentSubjectIndex][gradeName][currentVolumeIndex].vsid.push(knowledgePoint)
                    let knowledgePointSelect = document.getElementById('knowledgePointTitleChoice')
                    let option = document.createElement('option')
                    option.setAttribute("value", currentKnowledgePoint)
                    option.appendChild(document.createTextNode(knowledgePoint.title))
                    knowledgePointSelect.appendChild(option)
                    knowledgePointSelect.selectedIndex = knowledgePointSelect.options.length - 1
                    alert("添加成功")
                    /*  document.getElementById("buttons").style.visibility = "visible" //显示*/
                    problemIdDD == ""
                },
                error: function (knowledgePoint) {
                    alert("添加失败")
                    alert(JSON.stringify(knowledgePoint))
                }
            })
        })

        $('#updateknowledgePointTitle').on('click', function (e) {
            let knowledgePointTitle = document.getElementById('knowledgePointTitle')
            let knowledgePointData = {
                subjectId: currentSubject,
                grade: currentGrade,
                volumeId: currentVolume,
                title: knowledgePointTitle.value
            }
            $.ajax({
                type: "put",
                url: "/api/knowledge-points/" + currentKnowledgePoint,
                data: JSON.stringify(knowledgePointData),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (knowledgePointData) {
                    let gradeName = 'low'
                    switch (currentGrade) {
                        case 21:
                        case '21':
                            gradeName = 'high'
                            break
                        default:
                            break
                    }
                    subjects[currentSubjectIndex][gradeName][currentVolumeIndex][currentKnowledgePointIndex] = knowledgePointData
                    let knowledgePointSelect = document.getElementById('knowledgePointTitleChoice')
                    let opt = knowledgePointSelect.options.item(currentKnowledgePointIndex)
                    let knowledgePoints = document.getElementById('knowledgePointTitle')
                    alert(knowledgePoints.value)
                    opt.innerText = knowledgePoints.value
                    alert("修改成功")
                },
                error: function (knowledgePoint) {
                    alert("修改失败")
                }
            })
        })

        let currentSelectedElement

        let contents = document.getElementById('contents')
        contents.addEventListener('click', function (e) {
            let elm = e.target
            for (; ;) {
                if (elm.parentNode == e.currentTarget) {
                    break
                }
                elm = elm.parentNode
            }
            if (elm != currentSelectedElement) {
                if (currentSelectedElement) {
                    currentSelectedElement.removeClass('active')
                }
                currentSelectedElement = elm
                currentSelectedElement.addClass('active')
            }

        }, false)

        let movePrevious = document.getElementById('movePrevious')
        movePrevious.addEventListener('click', function (e) {
            let c = currentSelectedElement.parentNode
            let previousSibling = currentSelectedElement.previousElementSibling
            c.removeChild(currentSelectedElement)
            c.insertBefore(currentSelectedElement, previousSibling)
        }, false)

        let moveNext = document.getElementById('moveNext')
        moveNext.addEventListener('click', function (e) {
            let c = currentSelectedElement.parentNode
            let nextNextSibling = currentSelectedElement.nextElementSibling.nextElementSibling
            c.removeChild(currentSelectedElement)
            c.insertBefore(currentSelectedElement, nextNextSibling)
        }, false)

        let appendText = document.getElementById('appendText')
        appendText.addEventListener('click', function (e) {
            let textArea = document.createElement('textarea')
            let orderValue = 1
            textArea.setAttribute('data-identity', orderValue)
            textArea.setAttribute("data-id", '')
            textArea.setAttribute("data-type", 'text')
            contents.appendChild(textArea)
            currentSelectedElement = textArea
        }, false)

        let appendImage = document.getElementById('appendImage')
        appendImage.addEventListener('click', function (e) {
            let ImageArea = document.createElement('input')
            let orderValue = 1
            ImageArea.setAttribute('data-identity', orderValue)
            ImageArea.setAttribute("data-id", '')
            ImageArea.setAttribute("data-type", 'image')
            ImageArea.setAttribute("name", 'file')
            ImageArea.setAttribute("type", 'file')
            contents.appendChild(ImageArea)
            currentSelectedElement = ImageArea
        }, false)

        let appendProblem = document.getElementById('appendProblem')
        appendProblem.addEventListener('click', function (e) {
            let i = 0;
            let pt = document.getElementById('problem-template')
            let p = pt.content.children[0].cloneNode(true)
            let append = p.querySelector('[data-type="append"]')
            append.addEventListener('click', function (e) {
                let pot = document.getElementById('problem-option-template')
                let po = pot.content.children[0].cloneNode(true)
                i = i + 1;
                let options = e.target.parentNode.querySelector('[data-type="options"]')
                po.setAttribute("data-li", i);
                options.appendChild(po)

            }, false)
            contents.appendChild(p)
            currentSelectedElement = p
        }, false)

        let appendPinyinText = document.getElementById('appendPinyinText')
        appendPinyinText.addEventListener('click', function (e) {
            let py = document.getElementById('pinyinText-template')
            let p = py.content.children[0].cloneNode(true)
            contents.appendChild(p)
            currentSelectedElement = p
        }, false)

        let appendVideo = document.getElementById('appendVideo')
        appendVideo.addEventListener('click', function (e) {
            let video = document.getElementById('video-template')
            let p = video.content.children[0].cloneNode(true)
            contents.appendChild(p)
            currentSelectedElement = p
        }, false)

        let appendImageText = document.getElementById('appendImageText')
        appendImageText.addEventListener('click', function (e) {
            let pt = document.getElementById('imageText-template')
            let p = pt.content.children[0].cloneNode(true)
            contents.appendChild(p)
            currentSelectedElement = p
        }, false)

        let appendQuote = document.getElementById('appendQuote')
        appendQuote.addEventListener('click', function (e) {
            let pt = document.getElementById('quote-template')
            let p = pt.content.children[0].cloneNode(true)
            contents.appendChild(p)
            currentSelectedElement = p
        }, false)

        let submitFile = function (typeName, postProcess) {
            var formData = new FormData();
            formData.append("file", currentSelectedElement.querySelector('[data-type="' + typeName + '"]').files[0]);
            var request = new XMLHttpRequest();
            request.onreadystatechange = function () {
                if (request.readyState === 4) {
                    if (request.status == 200) {
                        returndata = JSON.parse(request.responseText)
                        postProcess(returndata)
                    }
                }
            }
            request.open("POST", "/api/medias");
            request.send(formData);
        }
        let imageId = null;
        let problemProcess = function (returndata, imagePath) {
            var data = {
                videoUrl: currentSelectedElement.querySelector('[data-type="video"]').value,
                title: currentSelectedElement.querySelector('[data-type="title"]').value,
                knowledgePointId: parseInt(currentKnowledgePoint),
                volumeId: parseInt(currentVolume),
                subjectId: parseInt(currentSubject),
                videoImage: returndata ? returndata.id : null,
                storePath: imagePath,
                index: currentSelectedElement.querySelector('[data-type="index"]').value
            }
            $.ajax({
                type: "post",
                url: "/api/problems",
                data: JSON.stringify(data),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (problem) {
                    problemIdDD = problem.id
                    currentSelectedElement.dataset.id = problem.id
                    let standardAnswer = currentSelectedElement.querySelector('[data-type="standardAnswers"]').value
                    let sas = standardAnswer.split(',')
                    for (let i = 0; i < sas.length; ++i) {
                        let answerItem = {
                            problemId: problem.id,
                            name: parseInt(sas[i]) - 1
                        }
                        $.ajax({
                            type: "post",
                            url: "/api/problem-standard-answers",
                            data: JSON.stringify(answerItem),
                            dataType: "json",
                            async: false,
                            contentType: "application/json; charset=utf-8"

                        })

                        let a = currentSelectedElement.querySelectorAll('[data-type="option"]')
                        a = JSON.stringify(a.length)

                        for (let i = 0; i < a; ++i) {
                            let li = i + 1;
                            var options = currentSelectedElement.querySelector('[data-type="options"]')
                            var option1 = options.querySelector('[data-li="' + li + '"]')
                            var option1content = option1.querySelector('[data-type="content"]').value
                            var option1image = option1.querySelector('[data-type="imageo"]')
                            if(option1image.files.length != 0){
                                var formData = new FormData();
                                formData.append("file", option1image.files[0]);
                                var request = new XMLHttpRequest();
                                request.onreadystatechange = function () {
                                    if (request.readyState === 4) {
                                        if (request.status == 200) {
                                            returndata = JSON.parse(request.responseText)
                                            imageId = returndata.id
                                            alert("执行图片块")
                                            let option = {
                                                problemId: problemIdDD,
                                                imageId: imageId,
                                                name: option1content
                                            }

                                            $.ajax({
                                                type: "post",
                                                url: "/api/problem-options",
                                                data: JSON.stringify(option),
                                                dataType: "json",
                                                async: false,
                                                contentType: "application/json; charset=utf-8",
                                                success: function(data){
                                                    alert("添加成功")
                                                    /*currentSelectedElement.dataset.id = returndata.id
                                                     alert(JSON.stringify(option))*/

                                                },
                                                error: function(data){
                                                    alert(JSON.stringify(data))
                                                    alert("添加失败")
                                                }
                                            })
                                        }
                                    }
                                }
                                request.open("POST", "/api/medias");
                                request.send(formData);
                            }else{
                                imageId = null;
                                alert("执行字体块")
                                let option = {
                                    problemId: problemIdDD,
                                    imageId: imageId,
                                    name: option1content
                                }

                                $.ajax({
                                    type: "post",
                                    url: "/api/problem-options",
                                    data: JSON.stringify(option),
                                    dataType: "json",
                                    async: false,
                                    contentType: "application/json; charset=utf-8",
                                    success: function(data){
                                        alert("添加成功")
                                        /*currentSelectedElement.dataset.id = returndata.id
                                         alert(JSON.stringify(option))*/

                                    },
                                    error: function(data){
                                        alert(JSON.stringify(data))
                                        alert("添加失败")
                                    }
                                })
                            }


                        }


                    }
                }
            })

        }
        /*let optionProcess = function(problemIdDD,iId, postProcess){
         let option = {}
         let name = currentSelectedElement.querySelector('[data-type="content"]').value
         option.problemId=problemIdDD,
         option.name = name,
         option.imageId = iId

         }*/
        let imageTextProcess = function (typeName, typevalue, postProcess) {
            var formData = new FormData();
            formData.append("file", currentSelectedElement.querySelector('[data-type="image"]').files[0]);
            formData.append("content", currentSelectedElement.querySelector('[data-type="content"]').value);
            var request = new XMLHttpRequest();
            request.onreadystatechange = function () {
                if (request.readyState === 4) {
                    if (request.status == 200) {
                        returndata = JSON.parse(request.responseText)
                        postProcess(returndata)
                    }
                }
            }
            request.open("POST", "/api/image-texts");
            request.send(formData);
        }
        let submit = document.getElementById('submit')
        submit.addEventListener('click', function (e) {
            switch (currentSelectedElement.dataset.type) {
                case 'text':
                    if (currentSelectedElement.dataset.id && (currentSelectedElement.dataset.id != '')) {
                        //put
                        currentId = currentSelectedElement.dataset.id
                        var data = {};
                        data.content = currentSelectedElement.value
                        $.ajax({
                            type: "put",
                            url: "/api/texts/" + currentId,
                            data: JSON.stringify(data),
                            dataType: "json",
                            contentType: "application/json; charset=utf-8",
                            success: function (volumeData) {
                                alert("修改成功")
                            },
                            error: function (volumeData) {
                                alert("修改失败")
                            }
                        })
                    } else {
                        //post
                        var data = {};
                        data.content = currentSelectedElement.value
                        $.ajax({
                            type: "post",
                            url: "/api/texts",
                            data: JSON.stringify(data),
                            dataType: "json",
                            contentType: "application/json; charset=utf-8",
                            success: function (text) {
                                currentSelectedElement.dataset.id = text.id
                                alert("添加成功")
                            },
                            error: function (text) {
                                alert("添加失败")
                            }
                        })
                    }
                    break;
                case 'image':
                    var formData = new FormData();
                    formData.append("file", currentSelectedElement.files[0]);
                    var request = new XMLHttpRequest();
                    request.onreadystatechange = function () {
                        if (request.readyState === 4) {
                            if (request.status == 200) {
                                returndata = JSON.parse(request.responseText)
                                currentSelectedElement.dataset.id = returndata.id
                            }
                        }
                    }
                    request.open("POST", "/api/medias");
                    request.send(formData);
                    alert("添加成功")
                    break;
                    /*case 'option':
                     if(problemIdDD == undefined || problemIdDD == ""){
                     alert("请先提交问题后，才能提交选项！")
                     }else{
                     let iId = null;
                     if(currentSelectedElement.querySelector('[data-type="imageo"]').files.length == 0){
                     optionProcess(problemIdDD,iId)
                     }else{
                     var formData = new FormData();
                     formData.append("file", currentSelectedElement.querySelector('[data-type="imageo"]').files[0]);
                     var request = new XMLHttpRequest();
                     request.onreadystatechange = function () {
                     if (request.readyState === 4) {
                     if (request.status == 200) {
                     returndata = JSON.parse(request.responseText)
                     /!*postProcess(returndata)*!/
                     iId = returndata.id
                     optionProcess(problemIdDD,iId)
                     }
                     }
                     }
                     request.open("POST", "/api/medias");
                     request.send(formData);
                     }
                     }
                     break;*/

                case'problem':
                    if (currentSelectedElement.dataset.id && (currentSelectedElement.dataset.id != '')) {
                        alert("问题不提供修改功能")
                    } else {
                        if (confirm("请检查问题内容是否有误，问题不提供修改功能！")) {
                            if (currentSelectedElement.querySelector('[data-type="image"]').files.length == 0) {
                                if (currentSelectedElement.querySelector('[data-type="videoImg"]').files.length == 0) {
                                    problemProcess()
                                } else {
                                    submitFile('videoImg', function (returndata) {
                                        problemProcess(returndata)
                                    })
                                }
                            } else {
                                submitFile('image', function (returndata) {
                                    if (currentSelectedElement.querySelector('[data-type="videoImg"]').files.length == 0) {
                                        problemProcess()
                                    } else {
                                        submitFile('videoImg', function (rd) {
                                            problemProcess(rd, returndata.storePath)
                                        })
                                    }
                                })
                            }
                        }
                    }
                    break
                case 'imageText':
                    if (currentSelectedElement.dataset.id && (currentSelectedElement.dataset.id != '')) {
                        delete currentSelectedElement.dataset.id
                        imageTextProcess("image", "content", function (returndata) {
                            currentSelectedElement.dataset.id = returndata.id
                            alert("修改成功")
                        })
                    } else {
                        imageTextProcess("image", "content", function (returndata) {
                            currentSelectedElement.dataset.id = returndata.id
                            alert("添加成功")
                        })
                    }
                    break;
                case 'video':
                    if (currentSelectedElement.dataset.id && (currentSelectedElement.dataset.id != '')) {
                        alert("视频不支持修改")
                    } else {
                        var storePath
                        var cover
                        submitFile("cover", function (returndata) {
                            storePath = currentSelectedElement.querySelector('[data-type="storePath"]').value,
                                    cover = returndata.id
                            var data = {};
                            data.cover = cover,
                                    data.storePath = storePath
                            $.ajax({
                                type: "post",
                                url: "/api/videos",
                                data: JSON.stringify(data),
                                dataType: "json",
                                contentType: "application/json; charset=utf-8",
                                success: function (videos) {
                                    alert(JSON.stringify(videos))
                                    alert("添加成功")
                                    currentSelectedElement.dataset.id = videos.id
                                },
                                error: function (videos) {
                                    alert(JSON.stringify(videos))
                                    alert("添加失败")
                                }
                            })
                        })
                    }
                    break;
                case 'quote':
                    if (currentSelectedElement.dataset.id && (currentSelectedElement.dataset.id != '')) {
                        currentId = currentSelectedElement.dataset.id
                        let data = {
                            content: currentSelectedElement.querySelector('[data-type="content"]').value,
                            source: currentSelectedElement.querySelector('[data-type="source"]').value
                        }
                        $.ajax({
                            type: "put",
                            url: "/api/quotes/" + currentId,
                            data: JSON.stringify(data),
                            dataType: "json",
                            contentType: "application/json; charset=utf-8",
                            success: function (quote) {
                                currentSelectedElement.dataset.id = quote.id
                                alert("修改成功")
                            },
                            error: function (quote) {
                                alert("修改失败")
                            }
                        })
                    } else {
                        let data = {
                            content: currentSelectedElement.querySelector('[data-type="content"]').value,
                            source: currentSelectedElement.querySelector('[data-type="source"]').value
                        }
                        alert(JSON.stringify(data))
                        //{"content":"第一的腰包","source":"——礼拜"}
                        $.ajax({
                            type: "post",
                            url: "/api/quotes",
                            data: JSON.stringify(data),
                            dataType: "json",
                            contentType: "application/json; charset=utf-8",
                            success: function (quote) {
                                alert("添加成功")
                                currentSelectedElement.dataset.id = quote.id
                            },
                            error: function (quote) {
                                alert("修改失败")
                            }
                        })
                    }
                    break;
                case 'pinyinText':
                    if (currentSelectedElement.dataset.id && (currentSelectedElement.dataset.id != '')) {
                        currentId = currentSelectedElement.dataset.id
                        let data = {
                            pinyin: currentSelectedElement.querySelector('[data-type="pinyin"]').value,
                            content: currentSelectedElement.querySelector('[data-type="content"]').value
                        }
                        $.ajax({
                            type: "put",
                            url: "/api/pinyin-texts/" + currentId,
                            data: JSON.stringify(data),
                            dataType: "json",
                            contentType: "application/json; charset=utf-8",
                            success: function (pinyin) {
                                alert("修改成功")
                                currentSelectedElement.dataset.id = pinyin.id
                            },
                            error: function (pinyin) {
                                alert("修改失败")
                            }
                        })
                    } else {
                        let data = {
                            pinyin: currentSelectedElement.querySelector('[data-type="pinyin"]').value,
                            content: currentSelectedElement.querySelector('[data-type="content"]').value
                        }
                        /* alert(JSON.stringify(data))*/
                        //{"content":"第一的腰包","source":"——礼拜"}
                        $.ajax({
                            type: "post",
                            url: "/api/pinyin-texts",
                            data: JSON.stringify(data),
                            dataType: "json",
                            contentType: "application/json; charset=utf-8",
                            success: function (pinyin) {
                                alert("添加成功")
                                currentSelectedElement.dataset.id = pinyin.id
                            },
                            error: function (pinyin) {
                                /*alert(JSON.stringify(pinyin))*/
                                alert("修改失败")
                            }
                        })
                    }
                    break
            }
            currentSelectedElement.removeClass('active')
            currentSelectedElement.addClass('saved')
            //currentSelectedElement.querySelector('[data-type="text"]').setAttribute('readonly', 'readonly')
        }, false)
        let save = document.getElementById('save')
        save.addEventListener('click', function (e) {
            let children = contents.children
            for (let i = 0; i < children.length; ++i) {
                //id, knowledge_point_id, volume_id, type, text_id|image_id|problem_id|video_id, order
                let data = {
                    knowledgePointId: parseInt(currentKnowledgePoint),
                    volumeId: parseInt(currentVolume),
                    grade: parseInt(currentGrade),
                    subjectId: parseInt(currentSubject),
                    type: children[i].dataset.type,
                    order: i + 1,
                    objectId: children[i].dataset.id
                }

                $.ajax({
                    type: "post",
                    url: "/api/knowledge-point-content-maps",
                    data: JSON.stringify(data),
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    async: false,
                    success: function (kpcm) {

                        /*let kpcm = JSON.stringify(kpcm);*/
                        /* if(kpcm.type == "option"){
                         let id = kpcm.id
                         $.ajax({
                         type:"delete",
                         url:"/api/knowledge-point-content-maps/" + id,
                         })
                         }*/

                    }
                })
            }
            /*document.getElementById("buttons").style.visibility = "hidden";//隐藏*/
            contents.innerHTML = ''
            alert("添加成功")
        }, false)
    })
</script>
</body>
</html>
