<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>激活卡</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0,user-scalable=no"
          id="viewport"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="screen-orientation" content="portrait"/>
    <link rel="stylesheet" href="common.css"/>
    <link rel="stylesheet" href="active-card.css"/>
    <script>
        var getUrlParameter = function (name) {
            var result = null;
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) {
                result = decodeURI(r[2]);
            }
            return result;
        }

        var ajax = function (method, url, headers, data, postProcess) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    var result = {meta: {code: xhr.status, text: xhr.statusText}, data: null};
                    if (xhr.responseText[0] == '{' || xhr.responseText[0] == '[') {
                        result.data = JSON.parse(xhr.responseText);
                    } else {
                        result.data = xhr.responseText;
                    }
                    postProcess(result);
                }
            }
            xhr.open(method, url, false);
            for (var i = 0, c = headers.length; i < c; ++i) {
                xhr.setRequestHeader(headers[i].name, headers[i].value);
            }
            var sendContent = null;
            if (data != null) {
                sendContent = JSON.stringify(data);
            }
            xhr.send(sendContent);
        }
    </script>
</head>
<body>
<div style="padding-top: 0.625rem;" class="common-margin-padding">
    <section style="overflow: hidden; background-color: #fff; border-top: 1px solid #e5e5e5;">
        <div>
            <span class="common-font common-line-height title">卡号</span>
            <input type="text" id="cardCode" class="common-font common-line-height common-border-style value" placeholder="请输入卡号" required pattern="\d+"/>
        </div>
        <div>
            <span class="common-font common-line-height title">密码</span>
            <input type="password" id="password" class="common-font common-line-height common-border-style value" placeholder="请输入密码" required/>
        </div>
        <div>
            <span class="common-font common-line-height title">手机号</span>
            <input type="tel" id="phoneNumber" class="common-font common-line-height common-border-style value" style="width: 30%" placeholder="请输入手机号" required pattern="\d+"/>
            <input type="button" id="activeCode" class="common-font common-line-height common-border-style validButton" value="获取手机验证码"/>
        </div>
        <div>
            <span class="common-font common-line-height title">验证码</span>
            <input type="text" id="validationCode" class="common-font common-line-height common-border-style value" placeholder="请输入验证码" required pattern="\d{6}"/>
        </div>
    </section>
    <div id="tips" class="common-font common-line-height common-border-style tips">卡片验证码将发送至此手机!</div>
    <input type="button" id="save" class="common-font common-line-height common-border-style save" value="确 认"/>
</div>
<script>
    var userId;

    var openId = getUrlParameter('openid');

    ajax('GET', 'api/wechat-users/' + openId + "/identities", [
        {name: 'Accept', value: 'application/json'}
    ], null, function (ids) {
        if (ids.meta.code < 400) {
            userId = ids.data.userId
            //g.setCookie('sessionId', ids.data.sessionId)
        } else {
            var tips = document.getElementById("tips")
            tips.innerHTML = "Initialize error，place refresh this page"
        }
    })

    var timeoutId;
    var timeoutCount = 60;
    var activeCode = function (e) {
        //alert('active code');

        var phoneNumber = document.getElementById('phoneNumber').value;
        ajax('GET', 'api/users/telephones/' + phoneNumber + '/code', [
            {name: 'Accept', value: 'application/json'}
        ], null, function (r) {
            if (r.meta.code < 400) {
                var tips = document.getElementById("tips");
                tips.innerHTML = "发送成功，请注意查收";
            } else {
                var tips = document.getElementById("tips");
                tips.innerHTML = "发送失败，请重新获取验证码";
            }
        })

//            $.ajax({
//                type: 'get',
//                url: 'api/users/telephones/' + phoneNumber + '/code',
//                dataType: 'json',
//                success: function (data) {
//                    var tips = document.getElementById("tips")
//                    tips.innerHTML = "发送成功，请注意查收"
//                },
//                error: function (r) {
//                    var tips = document.getElementById("tips")
//                    tips.innerHTML = "发送失败，请重新获取验证码"
//                }
//            })
        var proc = function () {
            e.target.value = " (" + timeoutCount + ") 秒后\n重新发送";
            --timeoutCount;
            if (timeoutCount <= 0) {
                e.target.value = " 重新发送 ";
                clearInterval(timeoutId);
            }
        }

        timeoutId = setInterval(proc, 1000);
    }

    var save = function (e) {
        //alert('save');
        var data = {};
        data.cardNo = document.getElementById('cardCode').value;
        data.password = document.getElementById('password').value;
        data.phoneNumber = document.getElementById('phoneNumber').value;
        data.validCode = document.getElementById('validationCode').value;
        ajax('POST', 'api/users/' + userId + '/cards', [
            {name: 'Content-Type', value: 'application/json'},
            {name: 'Accept', value: 'application/json'}
        ], data, function (r) {
            if (r.meta.code < 400) {
                location.href = 'Gold.html';
            } else {
                //alert('save error');
                var tips = document.getElementById("tips");
                //alert('get tips');
                switch (r.meta.code) {
                    case 500:
                        tips.innerHTML = "后台错误500，请联系程序猿叔叔。email：15210038357@163.com";
                        break;
                    case 412:
                        tips.innerHTML = "请返回的我的首页";
                        break;
                    case 520:
                        tips.innerHTML = "后台错误520，请联系程序猿叔叔。email：15210038357@163.com";
                        break;
                    case 404:
                        tips.innerHTML = "用户名或密码错误";
                        break;
                    case 405:
                        tips.innerHTML = "不可以重复激活";
                        break;
                    case 401:
                        tips.innerHTML = "手机号或验证码错误";
                        break;
                    case 410:
                        tips.innerHTML = "验证码超时";
                        break;
                    case 200:
                        window.location.href = 'Gold.html';
                        break;
                }
            }
        })

//            $.ajax({
//                type: 'post',
//                url: 'api/users/cards',
//                contentType: 'application/json',
//                data: data,
//                dataType: 'json',
//                success: function (result) {
//                    window.location.href = 'Gold.html'
//                },
//                error: function (result) {
//                    var tips = document.getElementById("tips")
//                    switch (result.statusCode) {
//                        case 500:
//                            tips.innerHTML = "后台错误500，请联系程序猿叔叔。email：15210038357@163.com";
//                            break;
//                        case 412:
//                            tips.innerHTML = "请返回的我的首页";
//                            break;
//                        case 520:
//                            tips.innerHTML = "后台错误520，请联系程序猿叔叔。email：15210038357@163.com";
//                            break;
//                        case 404:
//                            tips.innerHTML = "用户名或密码错误";
//                            break;
//                        case 405:
//                            tips.innerHTML = "不可以重复激活";
//                            break;
//                        case 401:
//                            tips.innerHTML = "手机号或验证码错误";
//                            break;
//                        case 410:
//                            tips.innerHTML = "验证码超时";
//                            break;
//                        case 200:
//                            window.location.href = 'Gold.html';
//                            break;
//                    }
//                }
//            })
    }
</script>
</body>
</html>