<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>小雨知时</title>
    <script src="jquery/jquery-3.1.1.js"></script>
    <script src="basic.js"></script>
    <link rel="stylesheet" href="myUser/css/Popup.css">
    <link rel="stylesheet" href="myUser/css/global.css">

</head>
<body>
<article id="knowledgePoints">

</article>
<article id="selectCard" style="display: none">

</article>
<article id="selectOneCard" style="display: none">

</article>
<template id="selectCard-template">
    <div class="wrap">
        <ul class="mine_baodiv">
            <li>
                <a class="mine_zuli" href="#" data-id="${id}">
                    <img class="mine_img1" src="${image}" alt="">
                    <div class="mine_leftdiv">
                        <span class="mine_leftsp">${subjectId}</span>
                        <span class="mine_leftsp">${no}</span>
                        <br>
                        <span class="uli_span">余<i class="uli_spani">${amount}</i>金豆</span>
                    </div>
                    <img src="" id="${id}" src="" class="mine_img2"/>
                    <!---->
                </a>
            </li>
        </ul>
    </div>

</template>
<template id="selectOneCard-template">
    <div class="wrap">
        <ul class="mine_baodiv">
            <li>
                <a class="mine_zuli" href="javascript:void(0)">
                    <img class="mine_img1" src="myUser/image/keBiao.png" alt="">
                    <div class="mine_leftdiv">
                        <span class="mine_leftsp">${subjectId}</span>
                        <span class="mine_leftsp">${no}</span>
                        <br>
                        <span class="uli_span">余<i class="uli_spani">${amount}</i>金豆</span>
                    </div>
                </a>
            </li>
        </ul>
        <ul class="mine_baodiv">
            <li class="mine_liname">
                <div class="mine_leftdiv">
                    <p class="mine_zhaunc">转出金豆数量</p>
                    <span class="mine_leftsp">金豆：</span>
                    <input class="mine_zhauncIn" type="text" id="Number">
                </div>
            </li>
        </ul>
        <p class="turnOut_note">
            最多可转出到卡
            <span class="note_number" id="tishi"></span>
        </p>
        <div class="zhaunc_btn">
            <!--确认转出-->
            <a class="zhaunc_a" href="#" id="submitTransfer">确认转出</a>

        </div>
    </div>
</template>
<template id="knowledgePoint-template">
    <ul class="public_ul_css" id="knowledgePoint">
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">Id</span>
            <span class="public_input_css">${id}</span>
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">科目</span>
            <span class="public_input_css">${subjectId}</span>
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">册名</span>
            <span class="public_input_css">${volumeId}</span>
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">年级</span>
            <span class="public_input_css">${grade}</span>
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">知识点名称</span>
            <span class="public_input_css">${name}</span>
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">展示时间</span>
            <span class="public_input_css">${showTime}</span>
        </li>
    </ul>
</template>
<!--<button id="submit">提交</button>-->
<!-- 弹窗开始 -->
<div id="Popup" style="display: none;">
    <div class="tan" style="display: block;"></div>

    <div class="window1" style="display: block;"><!-- 无此卡扣豆提醒 -->
        <a class="windowClose" href="JavaScript:void(0)" id="close"></a>
        <div class="win_neir koudou_win">
            <p class="neir_ptxt" id="p1"></p>
            <p class="neir_ptxt" id="p2"></p>
            <!--//<span class="ptxt_span" id="jin"></span>-->
            <p class="neir_ptiX" id="p3"><input name="" type="checkbox">下次不提醒</p>
            <p class="neir_pBtn kou_dou">
                <a class="p_btn" href="JavaScript:;" id="a1"></a>
            </p>
            <p class="neir_pBtn2">
                <a class="p_buyka" href="JavaScript:;" id="a2"></a>
            </p>
        </div>
    </div>
</div>
<!-- 弹窗结束-->
</body>
<script>

    var card_evolution = [];
    var card_evolution_subject = [];
    var cards;
    var user_amount;
    var Consumption_amount;
    var transfer;
    $.ajax({
        type: "get",
        url: "/api/volumes/" + 1 + "/knowledge-points",
        dataType: "json",
        success: function (e) {
            proc({
                containerId: 'knowledgePoints',
                data: e,
                templateId: 'knowledgePoint-template'
            })
        }
    })

    var knowledgePoints = document.getElementById("knowledgePoints");
    knowledgePoints.addEventListener('click', function (e) {
        // alert("来了")
        notice("knowledgePoint", 2, 3);
    }, false)


    //只要给我你的消费类型如知识点、直播等，返回账户余额、所有的卡号余额和需要消费的金豆数
    function notice(objectType, subjectId, objectId) {
        var notice = {
            objectType: objectType,
            objectId: objectId
        }

        $.ajax({
            type: "Put",
            url: "/api/users/notice",
            data: JSON.stringify(notice),
            dataType: "JSON",
            contentType: "application/json; charset=utf-8",
            success: function (e) {
                cards = e.cards;
                user_amount = e.account;
                Consumption_amount = e.amount;
                for (var i = 0; i < cards.length; i++) {
                    if (cards[i].subjectId == subjectId) {
                        if (cards[i].amount > Consumption_amount) {
                            card_evolution.push(cards[i]);//得到符合科目并符合余额大于最低消费金额的所有卡（直接是不是扣钱）
                        }
                    } else {
                        if (cards[i].amount > Consumption_amount) {
                            card_evolution_subject.push(cards[i]);//得到不符合科目并符合余额大于最低消费金额的所有卡（直接是不是扣钱）
                        }
                    }
                }
                if (card_evolution.length != 0) {
                    var s = subject(card_evolution[0].subjectId)
                    document.getElementById("p1").innerHTML = "<br/>"
                    document.getElementById("p2").innerHTML = "您确定扣除" + s + "卡" + Consumption_amount + "金豆吗?"
                    document.getElementById("a1").innerHTML = "确认"
                    document.getElementById("a1").value = "submit"
                    document.getElementById("a2").innerHTML = "充值"
                    document.getElementById("a2").value = "chong"
                    document.getElementById("Popup").style.display = "block"
                    /*  // 直接扣除该科目的卡金额

                     document.getElementById("Popup").style.display="block"*/
                    // alert("是否扣除语文卡"+Consumption_amount+"金豆？");
                } else if (card_evolution_subject.length != 0) {
                    var s = subject(subjectId)
                    document.getElementById("p1").innerHTML = "您没有" + s + "卡"
                    var ss = subject(card_evolution_subject[0].subjectId)
                    document.getElementById("p2").innerHTML = "您确定扣" + ss + "卡" + Consumption_amount + "金豆吗?"
                    document.getElementById("a1").innerHTML = "确认"
                    document.getElementById("a1").value = "save"

                    document.getElementById("a2").innerHTML = "购买" + s + "卡"
                    document.getElementById("a2").value = "shop"

                    document.getElementById("Popup").style.display = "block"
                    //直接扣除不同科目的卡金额
                    /*document.getElementById("Popup").style.display="block"
                     alert("你没有语文卡，是否扣除数学卡"+Consumption_amount+"金豆？");*/
                } else if (user_amount > Consumption_amount) {
                    document.getElementById("p1").innerHTML = "<br/>"
                    document.getElementById("p2").innerHTML = "您确定扣除账户" + Consumption_amount + "金豆吗?"
                    document.getElementById("a1").innerHTML = "确认"
                    document.getElementById("a1").value = "user_save"
                    document.getElementById("a2").innerHTML = "转出"
                    document.getElementById("a2").value = "turnOut"
                    document.getElementById("Popup").style.display = "block"
                } else if (card_evolution.length == 0 && card_evolution_subject.length == 0 && user_amount < Consumption_amount) {
                    document.getElementById("a1").innerHTML = "充值"
                    document.getElementById("a1").value = "chong"
                    document.getElementById("Popup").style.display = "block"
                }
            }
        })

        var a2 = document.getElementById("a2");
        a2.addEventListener('click', function (e) {
            if (a2.value == "chong") {
                alert("跳转到充值页面")
            }
            if (a2.value == "shop") {
                alert("跳转到购买页面")
            }
            if (a2.value == "turnOut") {
                TurnOut(cards)
            }
        })

        var filter = {}
        var a1 = document.getElementById("a1");
        a1.addEventListener('click', function (e) {
            if (a1.value == "submit") {
                filter = {
                    subjectId: card_evolution[0].id,
                    objectType: objectType,
                    objectId: objectId,
                }
                save(filter)
                //alert("提交"++objectType
            }
            if (a1.value == "save") {
                /*filter = {
                 subjectId:card_evolution_subject[0].id,
                 objectType:objectType,
                 objectId:objectId,
                 }
                 save(filter)*/
                //alert("提交没有"+card_evolution_subject[0].id+objectType)
                alert("扣没有语文卡的数学卡的钱")
            }
            if (a1.value == "user_save") {
                /*filter = {
                 subjectId:card_evolution_subject[0].id,
                 objectType:objectType,
                 objectId:objectId,
                 }*/
                alert("扣账户钱")
                //  alert("提账户user"+objectType)
            }
            if (a1.value == "chong") {
                alert("充值")
            }
        })

        function save(filter) {
            $.ajax({
                type: "put",
                url: "/api/users/deductMoney",
                data: JSON.stringify(filter),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (e) {
                    if (e == "200") {
                        document.getElementById("Popup").style.display = "none"
                        alert("购买成功，点击观看")
                    }

                },
                error: function (e) {
                    alert(e)
                }
            })
        }

        var close = document.getElementById("close");
        close.addEventListener('click', function (e) {
            document.getElementById("Popup").style.display = "none"
        })

    }

    function transfers(cardId, money) {
        var filter = {
            target: {
                objectId: 0,
                amount: money,
                subjectId: cardId,
            }


        }
        $.ajax({
            type: "put",
            url: "/api/users/transfer/transfer",
            dataType: "json",
            data: JSON.stringify(filter),
            contentType: "application/json; charset=utf-8",
            error: function (e) {
                if (e.status == 408) {
                    alert("余额不足")
                } else {
                    alert("转账成功")
                    document.getElementById("selectOneCard").style.display = "none"
                    document.getElementById("knowledgePoints").style.display = "block"
                    notice("knowledgePoint", 2);
                }

            }
        })
    }

    function TurnOut(cards) {
        if (cards.length > 1) {
            for (var i = 0; i < cards.length; i++) {
                if (cards[i].subjectId == 1) {
                    cards[i].image = "keBiao.png"
                    //.push("image","myUser/image/true.png");
                }
                if (cards[i].subjectId == 2) {
                    cards[i].image = "mathBiao.png"
                    //.push("image","myUser/image/true.png");
                }
                cards[i].subjectId = subject(cards[i].subjectId)
                if (cards[i].amount == 0) {
                    cards[i].amount = "0"
                }
            }
            proc({
                containerId: 'selectCard',
                data: cards,
                templateId: 'selectCard-template'
            })
            document.getElementById("knowledgePoints").style.display = "none"
            document.getElementById("Popup").style.display = "none"
            document.getElementById("selectCard").style.display = "block"

            $('.mine_zuli').on('click', function (e) {
                var id = e.target.dataset.id
                document.getElementById(id).src = "true.png";
                setTimeout(function () {
                    duo(id)
                }, 1000)

                //duo(id)
            })
            // alert("到多个卡选择页面")
        } else if (cards.length == 1) {
            dan(cards);
        }

        function duo(id) {
            var w = 1;
            w = id;
            $.ajax({
                type: "get",
                url: "/api/cards/" + w,
                dataType: "json",
                success: function (e) {
                    var arrList = [];
                    arrList.push(e);
                    dan(arrList)
                }
            })
        }

        function dan(cards) {
            var a = cards[0].subjectId
            cards[0].subjectId = subject(a)
            if (cards[0].amount == 0) {
                cards[0].amount = "0"
            }
            proc({
                containerId: 'selectOneCard',
                data: cards,
                templateId: 'selectOneCard-template'
            })
            transfer = cards;
            document.getElementById("selectCard").style.display = "none"
            document.getElementById("knowledgePoints").style.display = "none"
            document.getElementById("tishi").innerHTML = "" + user_amount + " 金豆"


            document.getElementById("Popup").style.display = "none"
            document.getElementById("selectOneCard").style.display = "block"
            var submitTransfer = document.getElementById("submitTransfer")
            submitTransfer.addEventListener('click', function (e) {
                transfers(transfer[0].id, $("#Number").val())
            })
        }
    }

    function subject(sex) {
        var result;
        if (sex == 1) {
            result = "语文"
        }
        if (sex == 2) {
            result = "数学"
        }
        return result;
    }

</script>
</html>