<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>用户信息</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0,user-scalable=no"
          id="viewport"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="screen-orientation" content="portrait"/>

    <!-- 引入样式表 -->
    <link rel="stylesheet" href="myUser/css/common.css"/>
    <link rel="stylesheet" href="myUser/css/global.css">
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <link rel="stylesheet" href="myUser/css/user.css">
    <script src="dao.js"></script>
</head>
<body>
<article id="sign" style="display: none">
    <div class="wrap">
        <div class="header">
            <div class="avatar"></div>
            <div class="touImg">
                <img src="myUser/image/login_tou.png" class="avatarImg"/>
            </div>
            <ul class="tab_switch">
                <li class="tab_swli cur">
                    <a class="tab_mima" href="JavaScript:;" id="pass">密码登录</a>
                    <span class="now_sanjiao"></span>
                </li>
                <li class="tab_swli">
                    <a class="tab_duanx" href="JavaScript:;" id="shortMessage">短信登录</a>
                    <span class="now_sanjiao sanJer"></span>
                </li>
            </ul>
        </div>
        <div class="mine_zilo">
            <div class="mine_table cur" id="username">
                <ul class="mine_zUl">
                    <li class="mine_zuli">
                        <span class="mine_leftsp">账号</span>
                        <input class="mine_rightip" type="number" id="Number" placeholder="请输入已激活手机号">
                        <i class="errorTs" id="errorNumber">
                            <!--该手机号尚未绑卡激活，请重新输入-->
                        </i>
                    </li>
                    <li class="mine_zuli">
                        <span class="mine_leftsp">密码</span>
                        <input class="mine_rightip" type="password" id="Dense" placeholder="请输入6-16位密码">
                        <a class="eye" href="#"></a>
                        <i class="errorTs" id="errorpassword1">
                            <!--密码错误-->
                        </i>
                    </li>
                    <li class="mine_zuli zuli_yzm" style="display: none;" id="tu">
                        <span class="mine_leftsp">验证码</span>
                        <input class="mine_rightip" type="password" id="Verification" placeholder="请输入验证码">
                        <button class="yanZma" id="huan">点击换一张</button>
                        <i class="errorTs">
                            <!--验证码错误-->
                        </i>
                    </li>
                    <span id="zhanghaoerror"></span>
                </ul>
            </div>
            <div class="mine_table" id="short">
                <ul class="mine_zUl">
                    <li class="mine_zuli">
                        <span class="mine_leftsp">账号</span>
                        <input class="mine_rightip" type="number" id="duanNumber" placeholder="请输入已激活手机号">
                    </li>
                    <li class="mine_zuli">
                        <span class="mine_leftsp">密码</span>
                        <input class="mine_rightip" type="password" id="duanDense" placeholder="请输入短信密码">
                        <!--<a class="famima" href="JavaScript:;" id="fapassword">发送密码</a>-->
                        <input type="button" id="fapassword" class="famima" value="发送密码">
                    </li>
                </ul>
                <span class="mine_tishi" id="errorfamima"></span>
            </div>
            <div class="bottom_bdiv">
                <a class="bottom_btn" href="JavaScript:;" id="signSubmit">登 录</a>
            </div>
            <div class="bottom_txt" data-article="firstActiveCard"><span class="leftLine">——</span>还没有账号？先去“填加卡号”<span
                    class="leftLine">——</span></div>
        </div>
    </div>
</article>
<article id="firstActiveCard" style="display: none;">
    <div class="wrap">
        <section style="overflow: hidden; background-color: #fff; border-top: 1px solid #e5e5e5;">
            <div class="firstActiveCard_li_css public_li_css">
                <span class="public_span_css changePassword_interval_width_css">卡号</span>
                <input class="firstActiveCard_input_css" type="text" placeholder="请输入卡号" id="cardNo"
                       style="height:20px; font-size:18px;"
                       required pattern="\d+">
                <!--onkeyup="test()"-->
            </div>
            <div class="firstActiveCard_li_css public_li_css">
                <span class="public_span_css changePassword_interval_width_css">密码</span>
                <input class="firstActiveCard_input_css" type="password" placeholder="请输入密码" id="password"
                       style="height:20px; font-size:18px;" required>
            </div>
            <div class="firstActiveCard_li_css public_li_css">
                <span class="public_span_css changePassword_interval_width_css">手机号</span>
                <input class="firstActiveCard_input_css" type="tel" id="phoneNumber" placeholder="请输入手机号" required
                       pattern="\d+"
                       style="height:20px; width: 115px; font-size:16px;">
                <input type="button" id="activeCode" style="display: inline-block; font-size:14px;" value="获取验证码"
                       class="send-btn cur">
            </div>
            <div class="firstActiveCard_li_css public_li_css">
                <span class="public_span_css changePassword_interval_width_css">验证码</span>
                <input class="firstActiveCard_input_css" type="text" placeholder="请输入验证码" id="validCode"
                       style="height:20px; font-size:18px;" required
                       pattern="\d{6}">
            </div>
        </section>
        <br/>
        <div style="font-size: 0.875rem; color: #fe6568; padding-left: 0.875rem; box-sizing: border-box; line-height: 1.375rem;"
             id="tips">
            欢迎来到激活卡页面!
        </div>
        <br/>
        <button id="save" style="text-decoration: none; color: #fff; height: 3.75rem;  width: 90%; text-align: center; display: block; font-size: 18px;  margin-left: 5%;
    margin-right: 5%; background-color: #fe6568; border: none">确 认
        </button>
        <br/>
        <!--  <button onclick="back()" style="text-decoration: none; color: #fff; height: 3.75rem;  width: 90%; text-align: center; display: block; font-size: 18px;  margin-left: 5%;
      margin-right: 5%; background-color: #fe6568; border: none">返回上一页
          </button>-->
    </div>
</article>

<article id="gold" style="display: none">
    <!--<div class="goldwrap"></div>
    <div class="goldbgImg">
        <div class="goldcloud1"></div>
        <div class="goldblue-bg"></div>
        <div class="goldbtm-img">
            <a href="javascript:;" onclick="kai()">完善资料</a>
        </div>
    </div>
    <div class="goldcloud2"></div>
    <div class="goldwords">
        <div class="goldtac">
            <img src="myUser/image/gx.png" height="43" width="296" alt=""/><br>
            <img class="goldtac_erimg"  src="myUser/image/wanshan.png" height="43" width="183" alt=""/><br>
            <img src="myUser/image/cg.png" height="88" width="457"/>
        </div>
    </div>-->
    <div class="goldwrap"></div>
    <div class="goldbgImg">
        <div class="goldcloud1"></div>
        <div class="goldblue-bg"></div>
        <div class="goldbtm-img">
            <a href="JavaScript:;" data-article="info">完善资料</a>
        </div>
    </div>
    <div class="goldcloud2"></div>
    <div class="goldwords">
        <div class="goldtac">
            <img src="images/gx.png" alt=""><br>
            <img class="goldtac_erimg" src="images/wanshan.png" alt=""><br>
            <img src="images/cg.png" alt="">
        </div>
    </div>
</article>

<article id="info" style="display: none;"></article>
<article id="changePassword" style="display: none;">
    <div class="wrap">
        <!-- main -->
        <ul class="changePassword_ul_css">
            <li class="changePassword_li_css public_li_css">
                <span class="public_span_css changePassword_interval_width_css">原密码</span>
                <input class="firstActiveCard_input_css" type="password" id="oldpwd" placeholder="请输入原密码">
            </li>
            <li class="changePassword_li_css public_li_css">
                <span class="public_span_css changePassword_interval_width_css">新密码</span>
                <input class="firstActiveCard_input_css" type="password" id="newpwd1" placeholder="请输入新密码">
            </li>
            <li class="changePassword_li_css public_li_css">
                <span class="public_span_css changePassword_interval_width_css">确认新密码</span>
                <input class="firstActiveCard_input_css" type="password" id="newpwd2" placeholder="请确认新密码">
            </li>
            <div id="error"></div>
        </ul>

        <div class="changePassword_box_css">
            <a href="javascript:void(0)" class="changePassword_button_css" id="pwd_save">保 存</a>
            <a href="javascript:void(0)" id="quxiao" class="changePassword_save_css">取 消</a>
        </div>
    </div>
</article>

<article id="user"></article>
<article id="nickname" style="display: none">
    <div class="wrap">
        <div class="mine_zilo">
            <ul class="mine_zUl">
                <li class="mine_zuli">
                    <span class="mine_leftsp">昵称</span>
                    <input class="mine_rightip" type="text" value="小雨知时" id="nicknameval">
                    <a class="chahao" href="JavaScript:;" id="nicehng"></a>
                </li>
            </ul>
        </div>
    </div>
</article>
<article id="cards" style="display: none;">
    <!--<div class="user_div_css">-->
    <div id="card"></div>
    <!--<div class="card_button_div_css">-->
    <a class="card_button_css " href="JavaScript:;">充值</a>
    <a class="card_button_css card_button_background_css" href="JavaScript:;" data-article="firstActiveCard">添加卡号</a>
    <!--<a class="bottom_btn Btn02" href="JavaScript:;" onclick="back()">返回上一页</a>-->
    <!--</div>-->
    <!--</div>-->
</article>
<article id="head" style="display: none;"></article>
<article id="consumes" style="display: none;"></article>
<article id="study" style="display: none;"></article>
<article id="score" style="display: none;"></article>
<article id="activeCard" style="display: none;">
    <section style="overflow: hidden; background-color: #fff; border-top: 1px solid #e5e5e5;">
        <div>
            <span class="common-font common-line-height title">卡号</span>
            <input type="text" id="cardNumber" class="common-font common-line-height common-border-style value"
                   placeholder="请输入卡号" required pattern="\d+"/>
        </div>
        <div>
            <span class="common-font common-line-height title">密码</span>
            <input type="password" id="cardPassword" class="common-font common-line-height common-border-style value"
                   placeholder="请输入密码" required/>
        </div>
    </section>
    <div id="activeTips" class="common-font common-line-height common-border-style tips">欢迎来到激活卡页面!</div>
    <input type="button" id="submit" class="common-font common-line-height common-border-style save" value="确 认"/>
</article>
<article id="settings" style="display: none;">
    <div class="wrap">
        <!-- main -->

        <div class="changePassword_div_css">
            <ul class="changePassword_ul_css">
                <li class="firstActiveCard_li_css public_li_css">
                    <a href="javascript:void(0)" data-article="changePassword">修改密码 <span class="next-btn"></span></a>
                </li>
                <li class="firstActiveCard_li_css public_li_css">
                    <a href="javascript:void(0)" data-article="info">修改个人信息 <span class="next-btn"></span></a>
                </li>
                <li class="firstActiveCard_li_css public_li_css">
                    <a href="javascript:void(0)" data-article="firstActiveCard">添加新卡 <span class="next-btn"></span></a>
                </li>
                <!--<li class="set-li">
                    <a href="javascript:void(0)" onclick="back()">返回上一页 <span class="next-btn"></span></a>

                </li>-->
            </ul>
        </div>

    </div>
</article>
<article id="help" style="display: none;">
    <div class="wrap">
        <div class="userTou">
            三味学堂用户操作流程
        </div>
        <div class="rain-main">
            <ul>
                <li class="daEr_li">
                    <div class="daYi">1.新书扫一扫</div>
                    <ul class="daEr">
                        <li class="daEr_li">①您购买了三味学堂的图书，可以扫一扫图书的二维码，进入“三味学堂”。</li>
                        <li class="daEr_li">②在页面下方“活动公告”栏中选“账号管理”，进入页面，点击“注册”，注册成为我们的会员。</li>
                        <li class="daEr_li">③注册完成后，点击“登录”，登录自己的账号，进行学习。</li>
                        <li class="daEr_li">④之后可以选择“我的账号信息”，完善自己的资料。</li>
                        <li class="daEr_li">注意：每本新书只可以扫描一次哦。您若购买了多本图书，可以多次扫描，但只需注册一次就可以了。</li>
                    </ul>
                </li>
                <li class="daEr_li">
                    <div class="daYi">2.新用户注册</div>
                    <ul class="daEr">
                        <li class="daEr_li">①您若是扫描了“三味学堂”的二维码或是加微信关注了“三味学堂”，可以进入“三味学堂”进行体验。</li>
                        <li class="daEr_li">②若想观看更多精彩内容，可以在首页下方“活动公告”栏中选“账号管理”，进入页面，点击“注册”，注册成为我们的会员。</li>
                        <li class="daEr_li">③注册完成后，点击“登录”，登录自己的账号，点击“我的充值”进行充值。</li>
                        <li class="daEr_li">④之后可以选择“我的账号信息”，完善自己的资料。</li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</article>

<template id="user-template">
    <!--<div class="user_div_css">-->
    <ul class="public_ul_css">
        <li class="user_li_css public_li_css" data-article="head">
            <span class="public_span_css">我的头像</span>
            <img class="user_head_css" src="${head}" alt="">
        </li>
        <li class="user_li_css public_li_css" data-article="nickname">
            <span class="public_span_css">昵称</span>
            <input class="user_input_css public_input_css" type="text" value="${name}" readonly>
        </li>
        <li class="user_li_css public_li_css">
            <span class="public_span_css">账号</span>
            <input class="user_input_css public_input_css" type="text" value="${telephone}" readonly>
        </li>
        <li>
            <ul class="user_li_css public_li_css" data-article="info">个人资料</ul>
        </li>
        <br/>

        <li>
            <ul class="user_li_css public_li_css" data-article="cards">我的学习卡</ul>
        </li>
        <li>
            <ul class="user_li_css public_li_css">学习记录</ul>
        </li>
        <br/>
        <li>
            <ul class="user_li_css public_li_css">账户余额</ul>
        </li>
        <li>
            <ul class="user_li_css public_li_css">充值</ul>
        </li>
        <li>
            <ul class="user_li_css public_li_css">我的积分</ul>
        </li>
        <br/>
        <li class="user_li_css public_li_css" data-article="settings">设置</li>
        <li class="user_li_css public_li_css" data-article="help">帮助</li>
    </ul>
    <!--</div>-->
</template>
<template id="info-template">
    <ul class="public_ul_css">
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">真实姓名</span>
            <input class="info_input_width_css public_input_css" type="text" placeholder="请输入真实姓名" value="${name}"
                   id="info_name">
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">手机号</span>
            <input class="info_input_width_css public_input_css" type="tel" value="${telephone}" id="info_telephone">
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">性别</span>
            <input class="info_input_width_css public_input_css" type="text" value="${sex}" id="info_sex">
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">出生年月</span>
            <input id="date" class="info_input_width_css public_input_css" type="date" value="${birthday}">
            <!--value="${birthday}"  placeholder="请选择出生日期" style="height:41px;overflow: hidden;"  style="height:41px;overflow: hidden;"-->
            <!--<input class="infomine_rightip" type="date" value="${birthday}" placeholder="请选择出生日期" style="height:41px;overflow: hidden;" id="info_birthday">-->
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">收货地址</span>
            <input class="info_input_width_css public_input_css" type="text" placeholder="请输入收货地址" value="${location}"
                   id="info_location">
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">就读学校</span>
            <input class="info_input_width_css public_input_css" type="text" value="${school}" id="info_school">
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">所在班级</span>
            <input class="info_input_width_css public_input_css" type="text" value="${classname}" id="info_class">
        </li>
        <li>
            <span class="public_span_css info_interval_width_css"></span>
            <button id="save_info" style="text-decoration: none; color: #fff; height: 3.75rem;  width: 90%; text-align: center; display: block; font-size: 18px;  margin-left: 5%;
    margin-right: 5%; background-color: #fe6568; border: none">确 认
            </button>
        </li>
    </ul>
</template>
<template id="card-template">
    <ul class="public_ul_css">
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">卡号</span>
            <span class="public_input_css">${no}</span>
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">学习类型</span>
            <span class="public_input_css">${subject}</span>
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">激活时间</span>
            <span class="public_input_css">${activeTime}</span>
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">剩余雨点</span>
            <span class="public_input_css">${amount}</span>
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">有效期</span>
            <span class="public_input_css">${endTime}</span>
        </li>
    </ul>
</template>
<template id="consume-template">
    <li>
        <p>${time}</p>
        <p>${direction}</p>
        <p><span>${amount}</span>金豆</p>
    </li>
</template>
<template id="study-template">

</template>
<template id="settings-template">

</template>


<!--<dialog>添加成功啦！<br>请到我的学习卡里~</dialog>-->

<!-- 引入js -->
<script src="/jquery/jquery-3.1.1.min.js"></script>
<!--<script type="text/javascript" src="/zepto/zepto.min.js"></script>-->
<!--<script type="text/javascript" src="/zepto/touch.js"></script>-->
<!--<script type="text/javascript" src="/zepto/selector.js"></script>-->
<script src="/util.js"></script>
<script src="/basic.js"></script>
<script>

    var user = null;
    var sessionId;
    //var userId;
   // var pan;
    //var duan;
    var array = [];
    //var count =0;
  //  var oppid;
    var state = {
        appId: null,
       // duan: null,
        pan: null,
        switchTo: function (id) {
            state.currentArticle.style.display = 'none'
            state.currentArticle = document.getElementById(id)
            history.pushState(null, null, '/user.html#' + id)
            state.currentArticle.style.display = 'block'
            state[id].init()
        },
        currentArticle: document.getElementById('sign'),
        init: function () {
            sessionId = g.getUrlParameter('sessionId')
            g.setCookie('sessionId', sessionId, '/api')
            appId = g.getUrlParameter("oppid");
            alert(appId)
            $(document).on('click', '[data-article]', function (e) {
                var id = e.target.dataset.article
                state.switchTo(id)
            })
            if (appId != null) {
                state.switchTo("user")
            } else {
                state.switchTo("sign")
            }
            //  state['sign'].init()
            history.pushState(null, null, '/user.html#user');
            window.addEventListener('hashchange', function (e) {
                var hashPos = e.newURL.indexOf('#')
                var hash = e.newURL.substring(hashPos + 1)
                state.switchTo(hash)
            }, false)
        },
        getSubjectNameById: function (subjects) {
            var result = ''
            if (subjects == 1) {
                result = "语文"
            }
            if (subjects == 2) {
                result = "数学"
            }
            if (subjects == 3) {
                result = "英语"
            }
            return result
        },
        getSexNameById: function (sex) {
            var result = 0
            if (sex == 1) {
                result = "男"
            }
            if (sex == 2) {
                result = "女"
            }
            if (sex == "男") {
                result = 1
            }
            if (sex == "女") {
                result = 2
            }

            return result
        },
        sign: {

            init: function () {
                document.getElementById("sign").style.display = "block"
                var biaoji = 1;
                var shortMessage = document.getElementById("shortMessage");
                shortMessage.addEventListener('click', function (e) {
                    document.getElementById("username").style.display = "none";
                    document.getElementById("short").style.display = "block";
                    biaoji = 0;
                })
                var pass = document.getElementById("pass");
                pass.addEventListener('click', function (e) {
                    document.getElementById("username").style.display = "block";
                    document.getElementById("short").style.display = "none";
                    biaoji = 1;
                })
                var deviceType;
                var fapassword = document.getElementById('fapassword');
                fapassword.addEventListener('click', function () {
                    //count = 0;
                    state.firstActiveCard.activeCode(0)
                }, false);

                var signSubmit = document.getElementById("signSubmit");
                signSubmit.addEventListener('click', function (e) {
                    var browser = {
                        versions: function () {
                            var u = navigator.userAgent, app = navigator.appVersion;
                            var yng =
                            {//移动终端浏览器版本信息
                                trident: u.indexOf('Trident') > -1, //IE内核
                                presto: u.indexOf('Presto') > -1, //opera内核
                                webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
                                gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
                                mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
                                ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
                                android: u.indexOf('Android') > -1, //android终端
                                iPhone: u.indexOf('iPhone') > -1, //是否为iPhone
                                iPad: u.indexOf('iPad') > -1, //是否iPad
                                webApp: u.indexOf('Safari') == -1 //是否web应该程序，没有头部与底部
                            };

                            if (yng.mobile == true) {
                                if (yng.ios == true) {
                                    deviceType = "ios";
                                }
                                if (yng.android == true) {
                                    deviceType = "android";
                                }
                                if (yng.iPhone == true) {
                                    deviceType = "iPhone";
                                }
                                if (yng.iPad == true) {
                                    deviceType = "iPad";
                                }
                            } else {
                                if (yng.trident == true) {
                                    deviceType = "IE内核";
                                }
                                if (yng.presto == true) {
                                    deviceType = "opera内核";
                                }
                                if (yng.webKit == true) {
                                    deviceType = "苹果/谷歌内核";
                                }
                                if (yng.gecko == true) {
                                    deviceType = "火狐内核";
                                }
                            }
                            return yng;
                        }(),
                        // language: (navigator.browserLanguage || navigator.language).toLowerCase()
                    }
                   // alert(deviceType)
                    // alert(JSON.stringify(deviceType))
                    var loginInfo = {};
                    var nub = $("#Number").val();
                    var dnub = $("#duanNumber").val();

                    if (biaoji == 1) {
                        loginInfo = {
                            info: nub,
                            key: $("#Dense").val(),
                            type: "telephone",
                            deviceType: deviceType,
                            deviceNo: nub,
                            openId: g.getUrlParameter('openId'),
                        }
                        var dense = $("#Dense").val();
                        if (dense.length >= 6 && dense.length <= 16) {
                            document.getElementById("errorpassword1").style.display = "none";
                            document.getElementById("errorpassword1").innerHTML = ""
                            pan = 0
                        } else {
                            document.getElementById("errorpassword1").style.display = "block";
                            document.getElementById("errorpassword1").innerHTML = "请输入6-16位密码";
                            pan = 1
                        }

                       /* var ber = $("#Number").val();
                        if (ber.length != 11) {
                            document.getElementById("errorNumber").style.display = "block";
                            document.getElementById("errorNumber").innerHTML = "请输入正确的手机格式";
                            duan = 1
                        } else {
                            document.getElementById("errorNumber").style.display = "none";
                            document.getElementById("errorNumber").innerHTML = ""
                            duan = 0
                        }*/
                        if (pan == 0) {
                            send(loginInfo)
                        }
                    } else {
                        loginInfo = {
                            info: dnub,
                            key: $("#duanDense").val(),
                            type: "validationCode",
                            deviceType: deviceType,
                            deviceNo: dnub,
                            openId: g.getUrlParameter('openId'),
                        }
                        send(loginInfo)
                    }


                    function send(loginInfo) {
                        $.ajax({
                            type: "PUT",
                            url: "/api/sessions",
                            data: JSON.stringify(loginInfo),
                            dataType: "json",
                            contentType: "application/json; charset=utf-8",
                            success: function (a) {
                                alert("登录成功")
                                state.switchTo('user')
                            },
                            error: function (e) {
                                switch (e.status){
                                    case 406:
                                        document.getElementById("errorfamima").innerHTML = "手机号或密码错误，请重新输入！"
                                        break;
                                    case 405:
                                        document.getElementById("errorfamima").innerHTML = "密码过期，请重新输入！"
                                        break;
                                    case 404:
                                        document.getElementById("zhanghaoerror").innerHTML = "账号或密码错误，请重新输入！"
                                        break;
                                    case 410:
                                        //超过五次了
                                        document.getElementById("tu").style.display="block"
                                        document.getElementById("zhanghaoerror").innerHTML = "错误次数超过五次，请输入验证码！"
                                        break;
                                    case 412:
                                        document.getElementById("zhanghaoerror").innerHTML = "手机号未激活 ！"
                                        break;
                                    case 407:
                                        document.getElementById("zhanghaoerror").innerHTML = "验证码错误 ！"
                                        break;
                                }
                            }
                        })
                    }
                })
            },
            huan: function () {
                
            }

        },
        user: {
            init: function () {
                if (user == null) {
                    $.ajax({
                        type: 'get',
                        url: '/api/users/self',
                        dataType: 'json',
                        success: function (u) {
                            if(u.birthday != null){
                                u.birthday = u.birthday.substr(0, 10)
                            }
                          if(u.sex != null){
                              u.sex = state.getSexNameById(u.sex);
                          }
                            user = u;
                            proc({
                                containerId: 'user',
                                data: user,
                                templateId: 'user-template'
                            })
                        }
                    })
                }else{
                    proc({
                        containerId: 'user',
                        data: user,
                        templateId: 'user-template'
                    })
                }
            },

        },
        cards: {
            isCards: false,
            init: function () {
                if (!state.cards.isCards) {
                    if (!user.cards) {
                        $.ajax({
                            type: 'get',
                            url: '/api/users/self/cards',
                            dataType: 'json',
                            success: function (cs) {
                                for (var i = 0; i < cs.length; ++i) {

                                    var a = state.getSubjectNameById(cs[i].subject);

                                    cs[i].subject = a;
                                }
                                user.cards = cs
                                proc({
                                    containerId: 'card',
                                    data: user.cards,
                                    templateId: 'card-template'
                                })
                            }
                        })
                    } else {
                        document.getElementById("card").innerHTML = "";
                        proc({
                            containerId: 'card',
                            data: user.cards,
                            templateId: 'card-template'
                        })
                    }
                    state.cards.isCards = true
                }
            }
        },
        info: {
            isInit: false,
            init: function () {
                if (!state.info.isInit) {
                    //document.getElementById("info").innerHTML=""
                    proc({
                        containerId: 'info',
                        data: user,
                        templateId: 'info-template'
                    })
                    state.info.isInit = true
                }
                var save_info = document.getElementById('save_info')
                save_info.addEventListener('click', saveInfo, false)

                function saveInfo() {
                    var se = $("#info_sex").val();
                    var sex = state.getSexNameById(se);
                    var b = $("#info_birthday").val();
                    b += "T00:00:00+08:00";
                    var data = {
                        name: $("#info_name").val(),
                        sex: sex,
                        telephone: $("#info_telephone").val(),
                        location: $("#info_location").val(),
                        birthday: b,
                        school: $("#info_school").val(),
                        classname: $("#info_class").val(),
                    }

                    $.ajax({
                        type: "put",
                        url: "/api/users/" + sessionId,
                        data: JSON.stringify(data),
                        dataType: "json",
                        contentType: "application/json; charset=utf-8",
                        success: function (e) {
                            //alert("成功")
                            history.back();
                        },
                        error: function (e) {
                            alert('修改用户信息失败，请刷新以重试')
                        }
                    })
                }
            }
        },
        logs: {
            init: function () {
            }
        },
        gold: {
            init: function () {

            },
        },
        consumes: {
            init: function () {
            }
        },
        head: {
            init: function () {

                var url = window.location.href;
                url = url.replace(/[/]/g, ',')
                $.ajax({
                    type: "get",
                    url: "/api/public-account/config/" + url,
                    dataType: "json",
                    success: function (e) {
                        alert(JSON.stringify(e));
                        wechat(e.appId, e.timestamp, e.nonceStr, e.signature)
                    }, error: function (e) {
                        alert(JSON.stringify(e));
                        wechat(e.appId, e.timestamp, e.nonceStr, e.signature)
                    }
                })
                function wechat(appId, timestamp, nonceStr, signature) {
                    wx.config({
                        debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                        appId: appId, // 必填，公众号的唯一标识
                        timestamp: timestamp, // 必填，生成签名的时间戳
                        nonceStr: nonceStr, // 必填，生成签名的随机串
                        signature: signature,// 必填，签名，见附录1
                        jsApiList: ['chooseImage', 'uploadImage', 'downloadImage']  // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
                    });
                    wx.error(function (res) {
                        // config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
                        gettick();
                        alert("服务器繁忙，请刷新！")
                    });
                    wx.ready(function () {
                        wx.chooseImage({
                            count: 1,
                            needResult: 1,
                            sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
                            sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
                            success: function (res) {
                                var localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                                //上传图片接口
                                wx.uploadImage({
                                    localId: localIds.toString(), // 需要上传的图片的本地ID，由chooseImage接口获得
                                    isShowProgressTips: 1, // 默认为1，显示进度提示
                                    success: function (res) {
                                        var mediaId = res.serverId; // 返回图片的服务器端ID
                                        //alert("返回图片的服务器端ID=="+mediaId)
                                        libai(mediaId)
                                    }
                                });
                            }
                        });
                    })
                }

                function gettick() {
                    $.ajax({
                        type: "get",
                        url: "/api/public-account/ticket/",
                        dataType: "json",
                        success: function (e) {
                            //alert(JSON.stringify(e))
                        },
                        error: function (e) {
                            //alert(JSON.stringify(e))
                        }
                    })
                }

                /*var sdakfjlasf = "6GMxwySqgrQCtgcw0M-FcFQH6OUG0JgGPypedTaFJntlEwzAlB4BnGajCeiifCUB";
                 libai(sdakfjlasf);
                 function libai(mediaId) {
                 alert("李白来了" + mediaId)
                 $.ajax({
                 type: "GET",
                 url: "/api/public-account/weChat/Head/" + mediaId,
                 dataType: "json",
                 success: function (e) {
                 alert("成功" + JSON.stringify(e))
                 user.head=e.head;
                 state.user.isCards = false
                 history.back();
                 },
                 error: function (e) {
                 alert(JSON.stringify(e))
                 }
                 })
                 }*/
            }
        },
        study: {
            init: function () {
            }
        },
        score: {
            init: function () {
            }
        },
        changePassword: {
            init: function () {
            }
        },
        activeCard: {
            init: function () {
            }
        },
        firstActiveCard: {
            // var timeoutId;
            init: function () {
                var timeoutId;
                var cardNo = document.getElementById("cardNo");
                cardNo.addEventListener('keyup', function (e) {
                    e.target.value = e.target.value.replace(/\s/g, '').replace(/\D/g, '').replace(/(\d{4})(?=\d)/g, "$1 ");
                }, false);
                var ajax = function (method, url, headers, data, postProcess) {
                    //alert('enter');
                    var xhr = new XMLHttpRequest();
                    //alert('new xhr');
                    xhr.onreadystatechange = function () {
                        //alert('enter callback');
                        if (xhr.readyState === 4) {
                            //alert('xhr state is 4');
                            var result = {meta: {code: xhr.status, text: xhr.statusText}, data: null};
                            if (xhr.responseText[0] == '{' || xhr.responseText[0] == '[') {
                                //alert('xhr success');
                                result.data = JSON.parse(xhr.responseText);
                            } else {
                                //alert('xhr failure');
                                result.data = xhr.responseText;
                            }
                            postProcess(result);
                        }
                    }
                    //alert('set callback');
                    xhr.open(method, url, false);
                    //alert('open');
                    for (var i = 0, c = headers.length; i < c; ++i) {
                        xhr.setRequestHeader(headers[i].name, headers[i].value);
                    }
                    //alert('set headers');
                    var sendContent = null;
                    if (data != null) {
                        sendContent = JSON.stringify(data);
                    }
                    xhr.send(sendContent);
                    //alert('send content');
                }

                var o = 0

                var save = function (e) {
                    if (o == 1) {
                        var tips = document.getElementById("tips");
                        tips.innerHTML = "不可以重复激活,请填写新的卡号并激活";
                        return
                    }
                    if (document.getElementById('cardNo').value == "" || document.getElementById('password').value == "" || document.getElementById('phoneNumber').value == "" || document.getElementById('validCode').value == "") {
                        alert("输入框不能为空")
                    } else {
                        var data = {};
                        var code = document.getElementById('cardNo').value
                        data.cardNo = code.replace(/\s/ig, '');
                        data.password = document.getElementById('password').value;
                        data.phoneNumber = document.getElementById('phoneNumber').value;
                        data.validCode = document.getElementById('validCode').value;
                        var url = 'api/users/cards'
                        /* if (userId) {
                         url = 'api/users/' + userId + '/cards'
                         }*/
                        ajax('POST', url, [
                            {name: 'Content-Type', value: 'application/json'},
                            {name: 'Accept', value: 'application/json'}
                        ], data, function (r) {
                            if (r.meta.code < 400) {
                                r.data.subject = state.getSubjectNameById(r.data.subject);

                                array.push(r.data);
                                //alert(JSON.stringify(array))
                             //   if(array[0].no.replace())
                                state.switchTo('gold')
                                diao();
                                // state.cards.isCards = false

                            } else {
                                //alert('save error');
                                var tips = document.getElementById("tips");
                                //alert('get tips');
                                switch (r.meta.code) {
                                    case 500:
                                        tips.innerHTML = "你的手机号跟别人重复啦";
                                        break;
                                    case 412:
                                        tips.innerHTML = "请返回的我的首页";
                                        break;
                                    case 520:
                                        tips.innerHTML = "后台错误520";
                                        break;
                                    case 404:
                                        tips.innerHTML = "卡号或密码错误";
                                        break;
                                    case 405:
                                        tips.innerHTML = "不可以重复激活,请填写新的卡号并激活";
                                        o = 1;
                                        break;
                                    case 401:
                                        tips.innerHTML = "手机号或验证码错误";
                                        break;
                                    case 410:
                                        tips.innerHTML = "验证码超时";
                                        break;
                                    case 200:
                                        r.data.subject = state.getSubjectNameById(e.subject)
                                        user.cards.push(r.data);
                                        alert(user.cards)
                                        state.cards.isCards = false
                                        break;
                                }
                            }
                        })
                        // document.getElementById("gold").style.display="block";
                    }
                }
                //var timeoutId;
                var enableActive = function (e) {
                    clearInterval(timeoutId);
                    var activeCodeButton = document.getElementById('activeCode');
                    activeCodeButton.disabled = false
                    activeCodeButton.value = '发送验证码'
                }

                var activeCodeButton = document.getElementById('activeCode');
                activeCodeButton.addEventListener('click', function () {
                    // count = 1;
                    state.firstActiveCard.activeCode(1)
                    //state.firstActiveCard.activeCode
                }, false);

                var saveButton = document.getElementById('save');
                saveButton.addEventListener('click', save, false);

                var validCode = document.getElementById('validCode')

                validCode.addEventListener('change', enableActive, false)

                var phoneNumber = document.getElementById('phoneNumber')
                phoneNumber.addEventListener('change', enableActive, false)

                var cardNo = document.getElementById('cardNo')
                cardNo.addEventListener('change', function (e) {
                    o = 0
                }, false)
            },

            activeCode: function (e) {
                var timeoutId;
                var an;
                var error;
                //var asfdf = "phoneNumber";
                if (e == 1) {
                    var phoneNumber = document.getElementById("phoneNumber").value
                    an = "activeCode";
                    error = "tips";
                } else {
                    var phoneNumber = document.getElementById("duanNumber").value
                    an = "fapassword";
                    error = "errorfamima";
                }
                //e = document.getElementById("activeCode")
                if (phoneNumber != "") {
                    $.ajax({
                        type: "get",
                        url: "/api/users/telephones/" + phoneNumber + "/code",
                        dataType: "json",
                        error: function (r) {
                            var tips = document.getElementById(error);
                            //alert(JSON.stringify(r))
                            if (r.status < 400) {
                                tips.innerHTML = '短信已发送至手机，3分钟内有效'
                            } else {
                                tips.innerHTML = '发送失败，请重新获取验证码'
                            }
                            var timeoutCount = 180;
                            var proc = function () {
                                document.getElementById(an).value = ' (' + timeoutCount + ')  秒后\n重新发送';
                                --timeoutCount;
                                document.getElementById(an).disabled = true
                                if (timeoutCount <= 0) {
                                    document.getElementById(an).value = ' 重新发送 ';
                                    clearInterval(timeoutId);
                                    document.getElementById(an).disabled = false
                                }
                            }
                            timeoutId = setInterval(proc, 1000);
                        }
                    })
                    /*ajax('GET', '/api/users/telephones/' + phoneNumber + '/code', [
                     {name: 'Accept', value: 'application/json'}
                     ], null, function (r) {
                     var tips = document.getElementById("tips")
                     if (r.meta.code < 400) {
                     tips.innerHTML = '发送成功，请注意查收'
                     } else {
                     tips.innerHTML = '发送失败，请重新获取验证码'
                     }
                     })*/


                } else {
                    alert('手机号不能为空')
                }
            }

        },
        login: {
            init: function () {
            }
        },
        phoneLogin: {
            init: function () {
            }
        },
        settings: {
            init: function () {
                var i;
                var j;
                var x;
                var p1 = document.getElementById("newpwd1");
                p1.addEventListener('blur', function () {
                    validatePWD1(newpwd1, error);
                })
                var p2 = document.getElementById("newpwd2");
                p2.addEventListener('blur', function () {
                    validatePWD2();
                })
                var p3 = document.getElementById("oldpwd");
                p3.addEventListener('blur', function () {
                    validatePWD3(oldpwd, error);
                })

                function validatePWD1(id, error) {
                    var pwd1 = $("#" + id + "").val();
                    if (pwd1.length >= 6 && pwd1.length <= 16) {
                        document.getElementById("" + error + "").innerHTML = ""
                        j = 1;
                    } else {
                        document.getElementById("" + error + "").innerHTML = "请输入6-16位密码"
                        j = 0;
                    }
                }

                function validatePWD3(id, error) {
                    var pwd3 = $("#" + id + "").val();
                    if (pwd3.length >= 6 && pwd3.length <= 16) {
                        document.getElementById("" + error + "").innerHTML = ""
                        x = 1;
                    } else {
                        document.getElementById("" + error + "").innerHTML = "请输入6-16位密码"
                        x = 0;
                    }
                }

                function validatePWD2() {
                    var pwd1 = $("#newpwd1").val();
                    var pwd2 = $("#newpwd2").val();
                    if (pwd1 != pwd2) {
                        document.getElementById("error").innerHTML = "密码输入不一致，请重新输入"
                        i = 0;
                    } else {
                        document.getElementById("error").innerHTML = ""
                        i = 1;
                    }
                }

                var pwdSave = document.getElementById("pwd_save");
                var quxiao = document.getElementById("quxiao");
                quxiao.addEventListener('click', function () {
                    history.back();
                })
                pwdSave.addEventListener('click', function () {
                    if (i == 1 && j == 1 && x == 1) {
                        var filter = {
                            password: $("#oldpwd").val()
                        }
                        $.ajax({
                            type: 'get',
                            url: "/api/users?filter=" + JSON.stringify(filter),
                            dataType: "json",
                            success: function (e) {
                                //alert("原密码正确")
                                var data = {
                                    password: $("#newpwd2").val()
                                }
                                $.ajax({
                                    type: "put",
                                    url: "/api/users/" + sessionId,
                                    data: JSON.stringify(data),
                                    dataType: "json",
                                    contentType: "application/json; charset=utf-8",
                                    success: function (a) {
                                        alert("修改密码成功")
                                        history.back();
                                    },
                                    error: function (a) {
                                        alert(JSON.stringify(a))
                                    }
                                })
                            },
                            error: function (e) {
                                document.getElementById("error").innerHTML = "原密码错误，请重新输入"
                            }
                        })
                    }
                }, false);
                /* function back() {
                 history.back();
                 }*/
            }
        },
        help: {
            init: function () {
            }
        },
        nickname: {
            init: function () {
                $("#nicehng").on('click', function () {
                    $("#nicknameval").val("")
                })
            }
        }
    }

    state.init()


</script>
</body>
</html>