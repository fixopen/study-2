<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>用户信息</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0,user-scalable=no"
          id="viewport"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="screen-orientation" content="portrait"/>
    <!-- 引入样式表 -->
    <link rel="stylesheet" href="global.css">
    <link rel="stylesheet" href="common.css">
    <link rel="stylesheet" href="user/basic-info.css">
    <link rel="stylesheet" href="user/cards.css">
    <link rel="stylesheet" href="css/setting1.css">
    <link rel="stylesheet" href="validationCode.css">
    <link rel="stylesheet" href="css/chagePassword.css">
    <link rel="stylesheet" href="css/infostyle.css">
    <link rel="stylesheet" href="css/helpstyle.css">
    <link rel="stylesheet" href="css/Gold.css">
</head>
<body>
<article id="user">
    <dl>
        <dt>name</dt>
        <dd><input type="text"></dd>
        <dt>avatar</dt>
        <dd><input type="text"></dd>
        <dt>nickname</dt>
        <dd><input type="text"></dd>
        <dt>account</dt>
        <dd><input type="text"></dd>
        <dt>password</dt>
        <dd><input type="text"></dd>
        <dt>real-name</dt>
        <dd><input type="text"></dd>
        <dt>phone</dt>
        <dd><input type="text"></dd>
        <dt>sex</dt>
        <dd><input type="text"></dd>
        <dt>birthday</dt>
        <dd><input type="button" value="details"></dd>
        <dt>location(address)</dt>
        <dd><input type="button" value="details"></dd>
        <dt>school</dt>
        <dd><input type="text"></dd>
        <dt>grade</dt>
        <dd><input type="text"></dd>
        <dt>class</dt>
        <dd><input type="text"></dd>
        <dt>sex</dt>
        <dd><input type="text"></dd>
        <dt>cards</dt>
        <dd><input type="button" value="details"></dd>
        <dt>logs</dt>
        <dd><input type="button" value="details"></dd>
        <dt>study</dt>
        <dd><input type="button" value="details"></dd>
        <dt>views</dt>
        <dd><input type="button" value="details"></dd>
        <dt>likes</dt>
        <dd><input type="button" value="details"></dd>
        <dt>knowledge</dt>
        <dd><input type="button" value="details"></dd>
        <dt>payment</dt>
        <dd><input type="button" value="details"></dd>
        <dt>help</dt>
        <dd><input type="button" value="details"></dd>
    </dl>
</article>
<article id="cards" style="display: none;">
    <ul id="active-cards"></ul>
    <button id="recharge" data-article="accountRecharge">充值</button>
    <button id="append-card" data-article="activeCard">添加卡</button>
</article>
<article id="info" style="display: none;"></article>
<article id="logs" style="display: none;"></article>
<article id="consumes" style="display: none;"></article>
<article id="study" style="display: none;"></article>
<article id="accountRecharge" style="display: none;"></article>
<article id="score" style="display: none;"></article>
<article id="changePassword" style="display: none;">
    <div class="wrap">
        <!-- main -->
        <div class="cpset-main">
            <ul class="cpset-ul">
                <li class="cpset-li">
                    <span class="cpset-span">原密码</span>
                    <input class="cpset-input" type="password" id="oldpwd" placeholder="请输入原密码">
                </li>
                <li class="cpset-li">
                    <span class="cpset-span">新密码</span>
                    <input class="cpset-input" type="password" id="newpwd1" placeholder="请输入新密码">
                </li>
                <li class="cpset-li">
                    <span class="cpset-span">确认新密码</span>
                    <input class="cpset-input" type="password" id="newpwd2" placeholder="请确认新密码">
                </li>
                <div id="error"></div>
            </ul>

            <div class="cpbtn-box">
                <a href="javascript:void(0)" class="cpsave-btn" id="pwd_save">保 存</a>
                <a href="javascript:void(0)" onclick="back()" class="cancel-btn">取 消</a>
            </div>
        </div>
    </div>
</article>
<article id="changeAvatar" style="display: none;"></article>
<article id="activeCard" style="display: none;">
    <section style="overflow: hidden; background-color: #fff; border-top: 1px solid #e5e5e5;">
        <div>
            <span class="common-font common-line-height title">卡号</span>
            <input type="text" id="cardNo" class="common-font common-line-height common-border-style value"
                   placeholder="请输入卡号" required pattern="\d+"/>
        </div>
        <div>
            <span class="common-font common-line-height title">密码</span>
            <input type="password" id="password" class="common-font common-line-height common-border-style value"
                   placeholder="请输入密码" required/>
        </div>
    </section>
    <div id="tips" class="common-font common-line-height common-border-style tips">欢迎来到激活卡页面!</div>
    <input type="button" id="save" class="common-font common-line-height common-border-style save" value="确 认"/>
</article>
<article id="firstActiveCard" style="display: none;">
    <section style="overflow: hidden; background-color: #fff; border-top: 1px solid #e5e5e5;">
        <div>
            <span class="common-font common-line-height title">卡号</span>
            <input type="text" id="first-cardNo" class="common-font common-line-height common-border-style value"
                   placeholder="请输入卡号" required pattern="\d+"/>
        </div>
        <div>
            <span class="common-font common-line-height title">密码</span>
            <input type="password" id="first-password" class="common-font common-line-height common-border-style value"
                   placeholder="请输入密码" required/>
        </div>
        <div>
            <span class="common-font common-line-height title">手机号</span>
            <input type="tel" id="phoneNumber" class="common-font common-line-height common-border-style value"
                   placeholder="请输入手机号" required pattern="\d+"/>
            <input type="button" id="activeCode" class="common-font common-border-style validButton" value="获取手机验证码"/>
        </div>
        <div>
            <span class="common-font common-line-height title">验证码</span>
            <input type="text" id="validCode" class="common-font common-line-height common-border-style value"
                   placeholder="请输入验证码" required pattern="\d{6}"/>
        </div>
    </section>
    <div id="first-tips" class="common-font common-line-height common-border-style tips">欢迎来到激活卡页面!</div>
    <input type="button" id="first-save" class="common-font common-line-height common-border-style save" value="确 认"/>
</article>
<article id="activeCardFinally" style="display: none;">
    <div class="wrap"></div>
    <div class="bgImg">
        <div class="cloud1"></div>
        <div class="blue-bg"></div>
        <div class="btm-img">
            <a href="javascript:void(0)" id="closeWindow">返回首页学习</a>
        </div>
    </div>
    <div class="cloud2"></div>
    <div class="words">
        <div class="tac">
            <img src="images/gx.png" alt=""><br>
            <img src="images/cg.png" alt="">
        </div>
    </div>
</article>
<article id="login" style="display: none;">
    <div>
        <span class="common-font common-line-height title">手机号</span>
        <input type="tel" id="login-account" class="common-font common-line-height common-border-style value"
               placeholder="请输入手机号" required pattern="\d+"/>
    </div>
    <div>
        <span class="common-font common-line-height title">密码</span>
        <input type="text" id="login-password" class="common-font common-line-height common-border-style value"
               placeholder="请输入验证码" required pattern="\d{6}"/>
    </div>
</article>
<article id="phoneLogin" style="display: none;">
    <div>
        <span class="common-font common-line-height title">手机号</span>
        <input type="tel" id="login-phoneNumber" class="common-font common-line-height common-border-style value"
               placeholder="请输入手机号" required pattern="\d+"/>
        <input type="button" id="login-activeCode" class="common-font common-border-style validButton" value="获取手机验证码"/>
    </div>
    <div>
        <span class="common-font common-line-height title">验证码</span>
        <input type="text" id="login-validCode" class="common-font common-line-height common-border-style value"
               placeholder="请输入验证码" required pattern="\d{6}"/>
    </div>
</article>
<article id="settings" style="display: none;">
    <div class="wrap">
        <!-- main -->
        <div class="set-main">
            <ul class="set-ul">
                <li class="set-li">
                    <a href="javascript:void(0)" data-article="change-password">修改密码 <span class="next-btn"></span></a>
                </li>
                <li class="set-li">
                    <a href="javascript:void(0)" data-article="info">修改个人信息 <span class="next-btn"></span></a>
                </li>
                <li class="set-li">
                    <a href="javascript:void(0)" data-article="firstActiveCard">添加新卡 <span class="next-btn"></span></a>
                </li>
                <!--<li class="set-li">
                    <a href="javascript:void(0)" onclick="back()">返回上一页 <span class="next-btn"></span></a>

                </li>-->
            </ul>
        </div>
    </div>
</article>
<article id="help" style="display: none;">
    <div class="wrap">
        <div class="userTou">
            三味学堂用户操作流程
        </div>
        <div class="rain-main">
            <ul>
                <li class="daEr_li">
                    <div class="daYi">1.新书扫一扫</div>
                    <ul class="daEr">
                        <li class="daEr_li">①您购买了三味学堂的图书，可以扫一扫图书的二维码，进入“三味学堂”。</li>
                        <li class="daEr_li">②在页面下方“活动公告”栏中选“账号管理”，进入页面，点击“注册”，注册成为我们的会员。</li>
                        <li class="daEr_li">③注册完成后，点击“登录”，登录自己的账号，进行学习。</li>
                        <li class="daEr_li">④之后可以选择“我的账号信息”，完善自己的资料。</li>
                        <li class="daEr_li">注意：每本新书只可以扫描一次哦。您若购买了多本图书，可以多次扫描，但只需注册一次就可以了。</li>
                    </ul>
                </li>
                <li class="daEr_li">
                    <div class="daYi">2.新用户注册</div>
                    <ul class="daEr">
                        <li class="daEr_li">①您若是扫描了“三味学堂”的二维码或是加微信关注了“三味学堂”，可以进入“三味学堂”进行体验。</li>
                        <li class="daEr_li">②若想观看更多精彩内容，可以在首页下方“活动公告”栏中选“账号管理”，进入页面，点击“注册”，注册成为我们的会员。</li>
                        <li class="daEr_li">③注册完成后，点击“登录”，登录自己的账号，点击“我的充值”进行充值。</li>
                        <li class="daEr_li">④之后可以选择“我的账号信息”，完善自己的资料。</li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</article>

<template id="user-template">
    <div class="mine_zilo">
        <ul class="mine_zUl">
            <li class="mine_zuli" data-article="head">
                <span class="mine_leftsp">我的头像</span>
                <img class="mine_touimg" src="${head}" alt="">
            </li>
            <li class="mine_zuli">
                <span class="mine_leftsp">昵称</span>
                <input class="mine_rightip" type="text" value="${name}" readonly>
            </li>
            <li class="mine_zuli">
                <span class="mine_leftsp">账号</span>
                <input class="mine_rightip" type="text" value="${telephone}" readonly>
            </li>
            <li>
                <ul class="mine_zuli" data-article="info">我的资料</ul>
            </li>
        </ul>
        <ul class="mine_zUl">
            <li>
                <ul class="mine_zuli" data-article="cards">我的学习卡</ul>
            </li>
        </ul>
        <ul class="mine_zUl">
            <li class="mine_zuli" data-article="settings">设置</li>
            <li class="mine_zuli" data-article="help">帮助</li>
        </ul>
    </div>

    <section>
        <span>我的头像</span>
        <img src="${head}" alt="">
    </section>
    <section>
        <span>昵称</span>
        <input type="text" value="${name}" readonly>
    </section>
    <section>
        <span>账号</span>
        <input type="text" value="${telephone}" readonly>
    </section>
    <section>
        <a href="#">我的资料</a>
    </section>
    <section>
        <a href="#">我的学习卡</a>
    </section>
    <section>
        <a href="#">设置</a>
    </section>
    <section>
        <a href="#">帮助</a>
    </section>
</template>
<template id="info-template">
    <ul class="infomine_zUl">
        <li class="infomine_zuli">
            <span class="infomine_leftsp">真实姓名</span>
            <input class="infomine_rightip" type="text" placeholder="请输入真实姓名" value="${name}" id="info_name">
        </li>
        <li class="infomine_zuli">
            <span class="infomine_leftsp">手机号</span>
            <input class="infomine_rightip" type="tel" value="${telephone}" id="info_telephone">
        </li>
        <li class="infomine_zuli">
            <span class="infomine_leftsp">性别</span>
            <input class="infomine_rightip" type="text" value="${sex}" id="info_sex">
        </li>
        <li class="infomine_zuli">
            <span class="infomine_leftsp">出生年月</span>
            <input id="date" class="weui_input" type="date" value="${birthday}" placeholder="请选择出生日期"
                   style="height:41px;overflow: hidden;">
            <!--value="${birthday}"  placeholder="请选择出生日期" style="height:41px;overflow: hidden;"-->
            <!--<input class="infomine_rightip" type="date" value="${birthday}" placeholder="请选择出生日期" style="height:41px;overflow: hidden;" id="info_birthday">-->
        </li>
        <li class="infomine_zuli">
            <span class="infomine_leftsp">收货地址</span>
            <input class="infomine_rightip" type="text" placeholder="请输入收货地址" value="${location}" id="info_location">
        </li>
        <li class="infomine_zuli">
            <span class="infomine_leftsp">就读学校</span>
            <input class="infomine_rightip" type="text" value="${school}" id="info_school">
        </li>
        <li class="infomine_zuli">
            <span class="infomine_leftsp">所在班级</span>
            <input class="infomine_rightip" type="text" value="${classname}" id="info_class">
        </li>
        <li>
            <span class="infomine_leftsp"></span>
            <button id="save_info" onclick="saveInfo()" style="text-decoration: none; color: #fff; height: 3.75rem;  width: 90%; text-align: center; display: block; font-size: 18px;  margin-left: 5%;
    margin-right: 5%; background-color: #fe6568; border: none">确 认
            </button>
        </li>
        <!-- <li>
             <span class="mine_leftsp"></span>
             <button onclick="back()" style="text-decoration: none; color: #fff; height: 3.75rem;  width: 90%; text-align: center; display: block; font-size: 18px;  margin-left: 5%;
     margin-right: 5%; background-color: #fe6568; border: none">回到上一页
             </button>
         </li>-->
    </ul>
    <article>
        <section>
            <span>真实姓名</span>
            <input type="text" placeholder="请输入真实姓名" value="${name}">
        </section>
        <section>
            <span>手机号</span>
            <input type="tel" value="${telephone}">
        </section>
        <section>
            <span>性别</span>
            <input type="text" value="${sexName}">
        </section>
        <section>
            <span>出生年月</span>
            <input type="date" value="${birthday}">
        </section>
        <section>
            <span>收货地址</span>
            <input type="text" placeholder="请输入收货地址" value="${location}">
        </section>
        <section>
            <span class="mine_leftsp">就读学校</span>
            <input class="mine_rightip" type="text" value="${school}">
        </section>
        <section>
            <span>所在班级</span>
            <input type="text" value="${grade} ${classname}">
        </section>
    </article>
</template>
<template id="card-template">
    <ul class="codemine_zUl">
        <li class="codemine_zuli">
            <span class="codemine_leftsp">卡号</span>
            <span class="codemine_rightip">${no}</span>
        </li>
        <li class="codemine_zuli">
            <span class="codemine_leftsp">学习类型</span>
            <span class="codemine_rightip">${subject}</span>
        </li>
        <li class="codemine_zuli">
            <span class="codemine_leftsp">激活时间</span>
            <span class="codemine_rightip">${activeTime}</span>
        </li>
        <li class="codemine_zuli">
            <span class="codemine_leftsp">剩余雨点</span>
            <span class="codemine_rightip">${amount}</span>
        </li>
        <li class="codemine_zuli">
            <span class="codemine_leftsp">有效期</span>
            <span class="codemine_rightip">${endTime}</span>
        </li>
    </ul>
    <article>
        <section>
            <span>卡号</span>
            <span>${no}</span>
        </section>
        <section>
            <span>学习类型</span>
            <span>${subjectName}</span>
        </section>
        <section>
            <span>激活时间</span>
            <span>${activeTime}</span>
        </section>
        <section>
            <span>剩余雨点</span>
            <span>${amount}</span>
        </section>
        <section>
            <span>有效期</span>
            <span>${endTime}</span>
        </section>
    </article>
</template>
<template id="consume-template">
    <li>
        <p>${time}</p>
        <p>${direction}</p>
        <p><span>${amount}</span>金豆</p>
    </li>
</template>
<template id="study-template"></template>

<dialog>添加成功啦！<br>请到我的学习卡里~</dialog>

<script src="/jquery/jquery-3.1.1.min.js"></script>
<script src="/weui/jweixin-1.0.0.js"></script>
<script src="/util.js"></script>
<script src="/basic.js"></script>
<!-- Load Babel -->
<script src="/babel.min.js"></script>
<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
<!-- Your custom script here -->
<script type="text/babel">
    const getMessage = () => "Hello World";
    document.getElementById('output').innerHTML = getMessage();
</script>
<script>
    var user = null
    var subjects = []

    var state = {
        currentArticle: document.getElementById('user'),
        init: function () {
            var userId = g.getUrlParameter('userid')
            if (userId) {
                g.setCookie("userId", userId)
            }

            var switchTo = function (id) {
                state.currentArticle.style.display = 'none'
                state.currentArticle = document.getElementById(id)
                state.currentArticle.style.display = 'block'
                history.pushState(null, null, '/user.html#' + id)
                state[id].init()
            }

            $(document).on('click', '[data-article]', function (e) {
                var id = e.target.dataset.article
                switchTo(id)
            })

            $.ajax({
                type: 'get',
                url: '/api/subjects',
                success: function(ss) {
                    subjects = ss
                    state['user'].init()
                    history.pushState(null, null, '/user.html#user')
                }
            })

            window.addEventListener('hashchange', function (e) {
                var hashPos = e.newURL.indexOf('#')
                var hash = e.newURL.substring(hashPos + 1)
                switchTo(hash)
            })
        },
        user: {
            init: function () {
                if (user == null) {
                    $.ajax({
                        type: 'get',
                        url: '/api/users/self',
                        dataType: 'json',
                        success: function (u) {
                            u.birthday = u.birthday.substr(0, 10)
                            u.sex = state.user.getSexNameById(u.sex)
                            user = u
                            proc({
                                containerId: 'user',
                                data: user,
                                templateId: 'user-template'
                            })
                            proc({
                                template: state.user.template,
                                data: user,
                                container: state.user.container
                            })
                        }
                    })
                } else {
                    proc({
                        templateId: state.user.template,
                        data: user,
                        container: state.user.container
                    })
                }
            },
            container: document.getElementById(''),
            template: getTemplate(''),
            getSexNameById: function (sex) {
                var result = ''
                switch (sex) {
                    case 0:
                        break
                    case 1:
                        result = '男'
                        break
                    case 2:
                        result = '女'
                        break
                }
                return result
            },
            getSexIdByName: function (sex) {
                var result = 0
                switch (sex) {
                    case '男':
                        result = 1
                        break
                    case '女':
                        result = 2
                        break
                }
                return result
            }
        },
        cards: {
            isInit: false,
            init: function () {
                if (!state.cards.isInit) {
                    if (!user.cards) {
                        $.ajax({
                            type: 'get',
                            url: '/api/users/self/cards',
                            dataType: 'json',
                            success: function (cs) {
                                for (var i = 0; i < cs.length; ++i) {
                                    var a =
                                            cs[i].subject = state.cards.getSubjectNameById(cs[i].subjectId)
                                }
                                user.cards = cs
                                proc({
                                    containerId: 'card',
                                    data: user.cards,
                                    templateId: 'card-template'
                                })
                            }
                        })
                    } else {
                        state.cards.container.innerHTML = ''
                        proc({
                            containerId: 'card',
                            data: user.cards,
                            templateId: 'card-template'
                        })
                    }
                    state.cards.isInit = true
                }
            },
            getSubjectNameById: function (id) {
                var result = ''
                for (var i = 0; i < subjects.length; ++i) {
                    if (subjects[i].id == id) {
                        result = subjects[i].name
                        break
                    }
                }
                return result
            }
        },
        info: {
            isInit: false,
            init: function () {
                var saveInfo = function () {
                    var se = $('#info_sex').val();
                    var sex = state.user.getSexIdByName(se);
                    var b = $('#info_birthday').val();
                    b += 'T00:00:00+08:00';
                    var data = {
                        name: $('#info_name').val(),
                        sex: sex,
                        telephone: $('#info_telephone').val(),
                        location: $('#info_location').val(),
                        birthday: b,
                        school: $('#info_school').val(),
                        classname: $('#info_class').val(),
                    }

                    $.ajax({
                        type: 'put',
                        url: '/api/users/self',
                        data: JSON.stringify(data),
                        dataType: 'json',
                        contentType: 'application/json; charset=utf-8',
                        success: function (e) {
                            alert('成功')
                            history.back();
                        },
                        error: function (e) {
                            alert('修改用户信息失败，请刷新以重试')
                        }
                    })
                }
                if (!state.info.isInit) {
                    state.info.container.innerHTML = ''
                    proc({
                        containerId: 'info',
                        data: user,
                        templateId: 'info-template'
                    })
                    state.info.isInit = true
                }
            }
        },
        logs: {
            init: function () {
            }
        },
        consumes: {
            init: function () {
            }
        },
        study: {
            init: function () {
            }
        },
        score: {
            init: function () {
            }
        },
        changePassword: {
            init: function () {
                var p1 = document.getElementById("newpwd1");
                p1.addEventListener('blur', function () {
                    validatePWD1();
                })
                var p2 = document.getElementById("newpwd2");
                p2.addEventListener('blur', function () {
                    validatePWD2();
                })
                var p3 = document.getElementById("oldpwd");
                p3.addEventListener('blur', function () {
                    validatePWD3();
                })

                function validatePWD1() {
                    var pwd1 = $("#newpwd1").val();
                    if (pwd1.length >= 6 && pwd1.length <= 16) {
                        document.getElementById("error").innerHTML = ""
                        j = 1;
                    } else {
                        document.getElementById("error").innerHTML = "请输入6-16位密码"
                        j = 0;
                    }
                }

                function validatePWD3() {
                    var pwd3 = $("#oldpwd").val();
                    if (pwd3.length >= 6 && pwd3.length <= 16) {
                        document.getElementById("error").innerHTML = ""
                        x = 1;
                    } else {
                        document.getElementById("error").innerHTML = "请输入6-16位密码"
                        x = 0;
                    }
                }

                function validatePWD2() {
                    var pwd1 = $("#newpwd1").val();
                    var pwd2 = $("#newpwd2").val();
                    if (pwd1 != pwd2) {
                        document.getElementById("error").innerHTML = "密码输入不一致，请重新输入"
                        i = 0;
                    } else {
                        document.getElementById("error").innerHTML = ""
                        i = 1;
                    }
                }

                var pwdSave = document.getElementById("pwd_save");
                pwdSave.addEventListener('click', function () {
                    if (i == 1 && j == 1 && x == 1) {
                        var filter = {
                            password: $("#oldpwd").val()
                        }
                        $.ajax({
                            type: 'get',
                            url: "/api/users?filter=" + JSON.stringify(filter),
                            dataType: "json",
                            success: function (e) {
                                //alert("原密码正确")
                                var data = {
                                    password: $("#newpwd2").val()
                                }
                                $.ajax({
                                    type: "put",
                                    url: "/api/users/" + userId,
                                    data: JSON.stringify(data),
                                    dataType: "json",
                                    contentType: "application/json; charset=utf-8",
                                    success: function (a) {
                                        alert("修改密码成功")
                                        back();
                                    },
                                    error: function (a) {
                                        alert(JSON.stringify(a))
                                    }
                                })
                            },
                            error: function (e) {
                                document.getElementById("error").innerHTML = "原密码错误，请重新输入"
                            }
                        })
                    }
                }, false);

                var yanz = function () {
                    alert("调用了")
                    if (i == 1 && j == 1 && x == 1) {
                        var filter = {
                            password: $("#oldpwd").val()
                        }
                        $.ajax({
                            type: 'get',
                            url: "/api/users?filter=" + JSON.stringify(filter),
                            dataType: "json",
                            success: function (e) {
                                alert("原密码正确")
                                var data = {
                                    password: $("#newpwd2").val()
                                }
                                $.ajax({
                                    type: "put",
                                    url: "/api/users/" + userId,
                                    data: JSON.stringify(data),
                                    dataType: "json",
                                    contentType: "application/json; charset=utf-8",
                                    success: function (a) {
                                        alert("成功")
                                    },
                                    error: function (a) {
                                        alert(JSON.stringify(a))
                                    }
                                })
                            },
                            error: function (e) {
                                document.getElementById("error").innerHTML = "原密码错误，请重新输入"
                            }
                        })
                    }
                }
            }
        },
        changeAvatar: {
            init: function () {
                wx.config({
                    debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                    appId: "wx92dec5e98645bd1d", // 必填，公众号的唯一标识
                    timestamp: "1479085147", // 必填，生成签名的时间戳
                    nonceStr: "1qauihewukdsfa", // 必填，生成签名的随机串
                    signature: "f18d6a4a248efdcff07ef7b7551ecee6e0b60309",// 必填，签名，见附录1
                    jsApiList: ['chooseImage', 'uploadImage', 'downloadImage']  // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
                });
                wx.error(function (res) {
                    // config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
                    // alert("权限验证失败"+res)
                    alert("权限验证失败" + JSON.stringify(res))
                    //getticket();
                });
                wx.ready(function () {
                    wx.chooseImage({
                        count: 1,
                        needResult: 1,
                        sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
                        sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
                        success: function (data) {
                            alert("调用选图接口成功")
                            var localIds = data.localIds[0].toString(); // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                            if (rh.tostr(localIds)) {
                                wxUploadImage(localIds);
                            }
                        },
                        fail: function (res) {
                            alterShowMessage("操作提示", JSON.stringify(res), "1", "确定", "", "", "");
                        }
                    });
                    alert("成功")
                });
                var src = user.head;
                $("#myimg").attr("src", src);

                var url = window.location.href;
                url = url.replace(/[/]/g, ',')
                // alert(url)
                $.ajax({
                    type: "get",
                    url: "/api/public-account/config/" + url,
                    dataType: "json",
                    success: function (e) {
                    },
                    error: function (e) {
                        alert("签名失败" + JSON.stringify(e))
                        getticket();
                    }
                })

                wx.ready(function () {
                    wx.chooseImage({
                        count: 1,
                        needResult: 1,
                        sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
                        sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
                        success: function (data) {
                            alert("调用选图接口成功")
                            var localIds = data.localIds[0].toString(); // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                            if (rh.tostr(localIds)) {
                                wxuploadImage(localIds);
                            }
                        },
                        fail: function (res) {
                            alterShowMessage("操作提示", JSON.stringify(res), "1", "确定", "", "", "");
                        }

                    });
                    alert("成功")
                });
                wx.error(function (res) {
                    // config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
                    // alert("权限验证失败"+res)
                    alert("权限验证失败" + JSON.stringify(res))
                    //getticket();
                });
            }
        },
        activeCard: {
            isInit: false,
            init: function () {
                if (!state.activeCard.isInit) {
                    var cardNo = document.getElementById("cardNo")
                    cardNo.addEventListener('keyup', function (e) {
                        e.target.value = e.target.value.replace(/\s/g, '').replace(/\D/g, '').replace(/(\d{4})(?=\d)/g, "$1 ")
                    }, false)
                    state.activeCard.submitButton.addEventListener('click', function(e) {
                        state.activeCard.submit()
                    }, false)
                }
            },
            submit: function() {
                $.ajax({
                    type: 'post',
                    url: '/api/users/self/cards',
                    success: function(card) {
                        user.cards.push(card)
                        state.cards.isInit = false
                        state.activeCard.isInit = true
                    }
                })
            },
            submitButton: document.getElementById('submit')
        },
        firstActiveCard: {
            init: function () {
                var timeoutId;
                var activeCode = function (e) {
                    //alert('active code')
                    var phoneNumber = document.getElementById('phoneNumber').value
                    if (phoneNumber != "") {
                        ajax('GET', 'api/users/telephones/' + phoneNumber + '/code', [
                            {name: 'Accept', value: 'application/json'}
                        ], null, function (r) {
                            var tips = document.getElementById("tips")
                            if (r.meta.code < 400) {
                                tips.innerHTML = '发送成功，请注意查收'
                            } else {
                                tips.innerHTML = '发送失败，请重新获取验证码'
                            }
                        })

                        var timeoutCount = 180;
                        var proc = function () {
                            e.target.value = ' (' + timeoutCount + ')  秒后\n重新发送';
                            --timeoutCount;
                            e.target.disabled = true
                            if (timeoutCount <= 0) {
                                e.target.value = ' 重新发送 ';
                                clearInterval(timeoutId);
                                e.target.disabled = false
                            }
                        }
                        timeoutId = setInterval(proc, 1000);
                    } else {
                        alert('手机号不能为空')
                    }
                }

                var o = 0

                var save = function (e) {
                    if (o == 1) {
                        var tips = document.getElementById("tips");
                        tips.innerHTML = "不可以重复激活,请填写新的卡号并激活";
                        return
                    }
                    if (document.getElementById('cardNo').value == "" || document.getElementById('password').value == "" || document.getElementById('phoneNumber').value == "" || document.getElementById('validCode').value == "") {
                        alert("输入框不能为空")
                    } else {

                        var data = {};
                        var code = document.getElementById('cardNo').value
                        data.cardNo = code.replace(/\s/ig, '');
                        data.password = document.getElementById('password').value;
                        data.phoneNumber = document.getElementById('phoneNumber').value;
                        data.validCode = document.getElementById('validCode').value;
                        var url = 'api/users/self/cards'
                        if (userId) {
                            url = 'api/users/' + userId + '/cards'
                        }
                        ajax('POST', url, [
                            {name: 'Content-Type', value: 'application/json'},
                            {name: 'Accept', value: 'application/json'}
                        ], data, function (r) {
                            if (r.meta.code < 400) {
                                $.ajax({
                                    type: "get",
                                    url: "/api/users/cards/" + data.cardNo,
                                    dataType: "json",
                                    success: function (e) {
                                        alert("激活成功")
                                        e.subject = getSubjectNameById(e.subject)
                                        user.cards.push(e);
                                        alert(user.cards)
                                        state.cards.isCards = false
                                        back();
                                    },
                                    error: function (e) {
                                        alert(JSON.stringify(e));
                                    }
                                })
                            } else {
                                //alert('save error');
                                var tips = document.getElementById("tips");
                                //alert('get tips');
                                switch (r.meta.code) {
                                    case 500:
                                        tips.innerHTML = "你的手机号跟别人重复啦";
                                        break;
                                    case 412:
                                        tips.innerHTML = "请返回的我的首页";
                                        break;
                                    case 520:
                                        tips.innerHTML = "后台错误520";
                                        break;
                                    case 404:
                                        tips.innerHTML = "卡号或密码错误";
                                        break;
                                    case 405:
                                        tips.innerHTML = "不可以重复激活,请填写新的卡号并激活";
                                        o = 1;
                                        break;
                                    case 401:
                                        tips.innerHTML = "手机号或验证码错误";
                                        break;
                                    case 410:
                                        tips.innerHTML = "验证码超时";
                                        break;
                                    case 200:
                                        $.ajax({
                                            type: "get",
                                            url: "/api/users/cards/" + data.cardNo,
                                            dataType: "json",
                                            success: function (e) {
                                                alert("激活成功")
                                                e.subject = getSubjectNameById(e.subject)
                                                user.cards.push(e);
                                                alert(user.cards)
                                                state.cards.isCards = false
                                                back();
                                            },
                                            error: function (e) {
                                                alert(JSON.stringify(e));
                                            }
                                        })
                                        break;
                                }
                            }
                        })
                    }
                }

                var enableActive = function (e) {
                    clearInterval(timeoutId);
                    var activeCodeButton = document.getElementById('activeCode');
                    activeCodeButton.disabled = false
                    activeCodeButton.value = '发送验证码'
                }

                var activeCodeButton = document.getElementById('activeCode');
                activeCodeButton.addEventListener('click', activeCode, false);

                var saveButton = document.getElementById('save');
                saveButton.addEventListener('click', save, false);

                var validCode = document.getElementById('validCode')

                validCode.addEventListener('change', enableActive, false)

                var phoneNumber = document.getElementById('phoneNumber')
                phoneNumber.addEventListener('change', enableActive, false)

                var save_info = document.getElementById('save_info')
                save_info.addEventListener('click', saveInfo, false)

                var cardNo = document.getElementById('cardNo')
                cardNo.addEventListener('change', function (e) {
                    o = 0
                }, false)
            }
        },
        login: {
            init: function () {
            }
        },
        phoneLogin: {
            init: function () {
            }
        },
        settings: {
            init: function () {
            }
        },
        help: {
            init: function () {
            }
        }
    }

    state.init()
</script>
</body>
</html>
