<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>用户信息</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0,user-scalable=no"
          id="viewport"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="screen-orientation" content="portrait"/>
    <link rel="stylesheet" href="common.css"/>

    <!-- 引入样式表 -->
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="user/basic-info.css">
    <link rel="stylesheet" href="css/setting1.css">
    <link rel="stylesheet" href="user/cards.css">
    <link rel="stylesheet" href="validationCode.css">
    <link rel="stylesheet" href="css/chagePassword.css">
    <!--<link rel="stylesheet" href="css/Cold.css">-->
    <!--<style>
        input[type="date"]:before{
            color:#A9A9A9;
            content:attr(placeholder);
        }


        input[type="date"].full:before {
            color:black;
            content:""!important;
        }
    </style>
      -->


</head>
<body>
<article id="user">

</article>
<article id="cards" style="display: none;">
    <div class="wrap">
        <div class="mine_zilo">
            <div id="card"></div>
            <div class="bottom_bdiv">
                <a class="bottom_btn Btn01" click="curseDetailTap();" href="#">充值</a>
                <a class="bottom_btn Btn02" href="JavaScript:;" data-article="firstActiveCard">添加卡号</a>
                <!--<a class="bottom_btn Btn02" href="JavaScript:;" onclick="back()">返回上一页</a>-->
            </div>
        </div>
    </div>
</article>
<article id="info" style="display: none;"></article>
<!--<article id="gold" style="display: none;">
    <div class="wrap"></div>
    <div class="bgImg">
        <div class="cloud1"></div>
        <div class="blue-bg"></div>
        <div class="btm-img">
            <a href="javascript:void(0)" id="closeWindow">返回首页学习</a>
        </div>
    </div>
    <div class="cloud2"></div>
    <div class="words">
        <div class="tac">
            <img src="images/gx.png" alt=""><br>
            <img src="images/cg.png" alt="">
        </div>
    </div>
</article>-->
<article id="logs" style="display: none;"></article>
<article id="consumes" style="display: none;"></article>
<article id="study" style="display: none;"></article>
<article id="score" style="display: none;"></article>
<article id="change-password" style="display: none;">
    <div class="wrap">
        <!-- main -->
        <div class="cpset-main">
            <ul class="cpset-ul">
                <li class="cpset-li">
                    <span class="cpset-span">原密码</span>
                    <input class="cpset-input" type="password" id="oldpwd" placeholder="请输入原密码">
                </li>
                <li class="cpset-li">
                    <span class="cpset-span">新密码</span>
                    <input class="cpset-input" type="password" id="newpwd1" placeholder="请输入新密码">
                </li>
                <li class="cpset-li">
                    <span class="cpset-span">确认新密码</span>
                    <input class="cpset-input" type="password" id="newpwd2" placeholder="请确认新密码">
                </li>
                <div id="error"></div>
            </ul>

            <div class="cpbtn-box">
                <a href="javascript:void(0)" class="cpsave-btn" id="pwd_save">保 存</a>
                <a href="javascript:void(0)" onclick="back()" class="cancel-btn">取 消</a>
            </div>
        </div>

    </div>
</article>
<!--<article id="activeCard" style="display: none;">
    <section style="overflow: hidden; background-color: #fff; border-top: 1px solid #e5e5e5;">
        <div>
            <span class="common-font common-line-height title">卡号</span>
            <input type="text" id="cardNo" class="common-font common-line-height common-border-style value"
                   placeholder="请输入卡号" required pattern="\d+"/>
        </div>
        <div>
            <span class="common-font common-line-height title">密码</span>
            <input type="password" id="password" class="common-font common-line-height common-border-style value"
                   placeholder="请输入密码" required/>
        </div>
    </section>
    <div id="tips" class="common-font common-line-height common-border-style tips">欢迎来到激活卡页面!</div>
    <input type="button" id="save" class="common-font common-line-height common-border-style save" value="确 认"/>
</article>-->
<article id="firstActiveCard" style="display: none;">
    <!--<section style="overflow: hidden; background-color: #fff; border-top: 1px solid #e5e5e5;">
        <div>
            <span class="common-font common-line-height title">卡号</span>
            <input type="text" id="first-cardNo" class="common-font common-line-height common-border-style value"
                   placeholder="请输入卡号" required pattern="\d+"/>
        </div>
        <div>
            <span class="common-font common-line-height title">密码</span>
            <input type="password" id="first-password" class="common-font common-line-height common-border-style value"
                   placeholder="请输入密码" required/>
        </div>
        <div>
            <span class="common-font common-line-height title">手机号</span>
            <input type="tel" id="phoneNumber" class="common-font common-line-height common-border-style value"
                   placeholder="请输入手机号" required pattern="\d+"/>
            <input type="button" id="activeCode" class="common-font common-border-style validButton" value="获取手机验证码"/>
        </div>
        <div>
            <span class="common-font common-line-height title">验证码</span>
            <input type="text" id="validCode" class="common-font common-line-height common-border-style value"
                   placeholder="请输入验证码" required pattern="\d{6}"/>
        </div>
    </section>
    <div id="first-tips" class="common-font common-line-height common-border-style tips">欢迎来到激活卡页面!</div>
    <input type="button" id="first-save" class="common-font common-line-height common-border-style save" value="确 认"/>-->
    <div style="padding-top: 0.625rem;" class="wrap">
        <section style="overflow: hidden; background-color: #fff; border-top: 1px solid #e5e5e5;">
            <div class="set-li">
                <span class="set-span">卡号</span>
                <input class="set-input" type="text" placeholder="请输入卡号" id="cardNo"
                       style="height:20px; font-size:18px;"
                       onkeyup="test()"
                       required pattern="\d+">
            </div>
            <div class="set-li">
                <span class="set-span">密码</span>
                <input class="set-input" type="password" placeholder="请输入密码" id="password"
                       style="height:20px; font-size:18px;" required>
            </div>
            <div class="set-li">
                <span class="set-span">手机号</span>
                <input class="set-input" type="tel" id="phoneNumber" placeholder="请输入手机号" required pattern="\d+"
                       style="height:20px; width: 115px; font-size:16px;">
                <input type="button" id="activeCode" style="display: inline-block; font-size:14px;" value="获取验证码"
                       class="send-btn cur">
            </div>
            <div class="set-li">
                <span class="set-span">验证码</span>
                <input class="set-input" type="text" placeholder="请输入验证码" id="validCode"
                       style="height:20px; font-size:18px;" required
                       pattern="\d{6}">
            </div>
        </section>
        <br/>
        <div style="font-size: 0.875rem; color: #fe6568; padding-left: 0.875rem; box-sizing: border-box; line-height: 1.375rem;"
             id="tips">
            欢迎来到激活卡页面!
        </div>
        <br/>
        <button id="save" style="text-decoration: none; color: #fff; height: 3.75rem;  width: 90%; text-align: center; display: block; font-size: 18px;  margin-left: 5%;
    margin-right: 5%; background-color: #fe6568; border: none">确 认
        </button>
        <br/>
      <!--  <button onclick="back()" style="text-decoration: none; color: #fff; height: 3.75rem;  width: 90%; text-align: center; display: block; font-size: 18px;  margin-left: 5%;
    margin-right: 5%; background-color: #fe6568; border: none">返回上一页
        </button>-->
    </div>
</article>
<article id="login" style="display: none;">
    <div>
        <span class="common-font common-line-height title">手机号</span>
        <input type="tel" id="login-account" class="common-font common-line-height common-border-style value"
               placeholder="请输入手机号" required pattern="\d+"/>
    </div>
    <div>
        <span class="common-font common-line-height title">密码</span>
        <input type="text" id="login-password" class="common-font common-line-height common-border-style value"
               placeholder="请输入验证码" required pattern="\d{6}"/>
    </div>
</article>
<article id="phone-login" style="display: none;">
    <div>
        <span class="common-font common-line-height title">手机号</span>
        <input type="tel" id="login-phoneNumber" class="common-font common-line-height common-border-style value"
               placeholder="请输入手机号" required pattern="\d+"/>
        <input type="button" id="login-activeCode" class="common-font common-border-style validButton" value="获取手机验证码"/>
    </div>
    <div>
        <span class="common-font common-line-height title">验证码</span>
        <input type="text" id="login-validCode" class="common-font common-line-height common-border-style value"
               placeholder="请输入验证码" required pattern="\d{6}"/>
    </div>
</article>
<article id="settings" style="display: none;">
    <div class="wrap">
        <!-- main -->
        <div class="set-main">
            <ul class="set-ul">
                <li class="set-li">
                    <a href="javascript:void(0)" data-article="change-password">修改密码 <span class="next-btn"></span></a>
                </li>
                <li class="set-li">
                    <a href="javascript:void(0)" data-article="info">修改个人信息 <span class="next-btn"></span></a>
                </li>
                <li class="set-li">
                    <a href="javascript:void(0)" data-article="firstActiveCard">添加新卡 <span class="next-btn"></span></a>
                </li>
                <!--<li class="set-li">
                    <a href="javascript:void(0)" onclick="back()">返回上一页 <span class="next-btn"></span></a>

                </li>-->
            </ul>
        </div>
    </div>
</article>
<article id="help" style="display: none;">

    <span class="mine_leftsp"></span>
   <!-- <button onclick="back()" style="text-decoration: none; color: #fff; height: 3.75rem;  width: 90%; text-align: center; display: block; font-size: 18px;  margin-left: 5%;
    margin-right: 5%; background-color: #fe6568; border: none">回到上一页
    </button>-->

    <h1>帮助</h1>
</article>

<template id="user-template">
    <div class="mine_zilo">
        <ul class="mine_zUl">
            <li class="mine_zuli">
                <span class="mine_leftsp">我的头像</span>
                <img class="mine_touimg" src="${head}" alt="">
            </li>
            <li class="mine_zuli">
                <span class="mine_leftsp">昵称</span>
                <input class="mine_rightip" type="text" value="${name}" readonly>
            </li>
            <li class="mine_zuli">
                <span class="mine_leftsp">账号</span>
                <input class="mine_rightip" type="text" value="${telephone}" readonly>
            </li>
            <li>
                <ul class="mine_zuli" data-article="info">我的资料</ul>
            </li>
        </ul>
        <ul class="mine_zUl">
            <li>
                <ul class="mine_zuli" data-article="cards">我的学习卡</ul>
            </li>
        </ul>
        <ul class="mine_zUl">
            <li class="mine_zuli" data-article="settings">设置</li>
            <li class="mine_zuli" data-article="help">帮助</li>
        </ul>
    </div>
</template>
<template id="info-template">
    <!-- <article>
         <section>
             <span>真实姓名</span>
             <input type="text" placeholder="请输入真实姓名" value="${name}">
         </section>
         <section>
             <span>手机号</span>
             <input type="tel" value="${telephone}">
         </section>
         <section>
             <span>性别</span>
             <input type="text" value="${sex}">
         </section>
         <section>
             <span>出生年月</span>
             <input type="date" value="${birthday}">
         </section>
         <section>
             <span>收货地址</span>
             <input type="text" placeholder="请输入收货地址" value="${location}">
         </section>
         <section >
             <span class="mine_leftsp">就读学校</span>
             <input class="mine_rightip" type="text" value="${school}">
         </section>
         <section>
             <span>所在班级</span>
             <input type="text" value="${grade} ${classname}">
         </section>
     </article>-->
    <ul class="mine_zUl">
        <li class="mine_zuli">
            <span class="mine_leftsp">真实姓名</span>
            <input class="mine_rightip" type="text" placeholder="请输入真实姓名" value="${name}" id="info_name">
        </li>
        <li class="mine_zuli">
            <span class="mine_leftsp">手机号</span>
            <input class="mine_rightip" type="tel" value="${telephone}" id="info_telephone">
        </li>
        <li class="mine_zuli">
            <span class="mine_leftsp">性别</span>
            <input class="mine_rightip" type="text" value="${sex}" id="info_sex">
        </li>
        <li class="mine_zuli">
            <span class="mine_leftsp">出生年月</span>
            <!--<input id="date" class="weui_input" type="date" placeholder="请选择出生日期" style="height:41px;overflow: hidden;"> value="${birthday}"  placeholder="请选择出生日期" style="height:41px;overflow: hidden;"-->
            <input class="mine_rightip" type="date" value="${birthday}" id="info_birthday">
        </li>
        <li class="mine_zuli">
            <span class="mine_leftsp">收货地址</span>
            <input class="mine_rightip" type="text" placeholder="请输入收货地址" value="${location}" id="info_location">
        </li>
        <li class="mine_zuli">
            <span class="mine_leftsp">就读学校</span>
            <input class="mine_rightip" type="text" value="${school}" id="info_school">
        </li>
        <li class="mine_zuli">
            <span class="mine_leftsp">所在班级</span>
            <input class="mine_rightip" type="text" value="${grade} ${classname}" id="info_class">
        </li>
        <li>
            <span class="mine_leftsp"></span>
            <button id="save_info" onclick="saveInfo()" style="text-decoration: none; color: #fff; height: 3.75rem;  width: 90%; text-align: center; display: block; font-size: 18px;  margin-left: 5%;
    margin-right: 5%; background-color: #fe6568; border: none">确 认
            </button>
        </li>
       <!-- <li>
            <span class="mine_leftsp"></span>
            <button onclick="back()" style="text-decoration: none; color: #fff; height: 3.75rem;  width: 90%; text-align: center; display: block; font-size: 18px;  margin-left: 5%;
    margin-right: 5%; background-color: #fe6568; border: none">回到上一页
            </button>
        </li>-->
    </ul>

</template>
<template id="card-template">
    <!--<article>
        <section>
            <span>卡号</span>
            <span>${no}</span>
        </section>
        <section>
            <span>学习类型</span>
            <span>${subjectName}</span>
        </section>
        <section>
            <span>激活时间</span>
            <span>${activeTime}</span>
        </section>
        <section>
            <span>剩余雨点</span>
            <span>${amount}</span>
        </section>
        <section>
            <span>有效期</span>
            <span>${endTime}</span>
        </section>
    </article>-->
    <ul class="mine_zUl">
        <li class="mine_zuli">
            <span class="mine_leftsp">卡号</span>
            <span class="mine_rightip">${no}</span>
        </li>
        <li class="mine_zuli">
            <span class="mine_leftsp">学习类型</span>
            <span class="mine_rightip">${subject}</span>
        </li>
        <li class="mine_zuli">
            <span class="mine_leftsp">激活时间</span>
            <span class="mine_rightip">${activeTime}</span>
        </li>
        <li class="mine_zuli">
            <span class="mine_leftsp">剩余雨点</span>
            <span class="mine_rightip">${amount}</span>
        </li>
        <li class="mine_zuli">
            <span class="mine_leftsp">有效期</span>
            <span class="mine_rightip">${endTime}</span>
        </li>
    </ul>
</template>
<template id="consume-template">
    <li>
        <p>${time}</p>
        <p>${direction}</p>
        <p><span>${amount}</span>金豆</p>
    </li>
</template>
<template id="study-template"></template>

<template id="settings-template">

</template>

<!--<dialog>添加成功啦！<br>请到我的学习卡里~</dialog>-->

<!-- 引入js -->
<script src="/jquery/jquery-3.1.1.min.js"></script>
<!--<script type="text/javascript" src="/zepto/zepto.min.js"></script>-->
<!--<script type="text/javascript" src="/zepto/touch.js"></script>-->
<!--<script type="text/javascript" src="/zepto/selector.js"></script>-->
<script src="/util.js"></script>
<script src="/basic.js"></script>
<script>
    function back() {
        history.back();
    }


    var i;
    var j;
    var x;
    var p1 = document.getElementById("newpwd1");
    p1.addEventListener('blur', function () {
        validatePWD1();
    })
    var p2 = document.getElementById("newpwd2");
    p2.addEventListener('blur', function () {
        validatePWD2();
    })
    var p3 = document.getElementById("oldpwd");
    p3.addEventListener('blur', function () {
        validatePWD3();
    })

    function validatePWD1() {
        var pwd1 = $("#newpwd1").val();
        if (pwd1.length >= 6 && pwd1.length <= 16) {
            document.getElementById("error").innerHTML = ""
            j = 1;
        } else {
            document.getElementById("error").innerHTML = "请输入6-16位密码"
            j = 0;
        }
    }
    function validatePWD3() {
        var pwd3 = $("#oldpwd").val();
        if (pwd3.length >= 6 && pwd3.length <= 16) {
            document.getElementById("error").innerHTML = ""
            x = 1;
        } else {
            document.getElementById("error").innerHTML = "请输入6-16位密码"
            x = 0;
        }
    }
    function validatePWD2() {
        var pwd1 = $("#newpwd1").val();
        var pwd2 = $("#newpwd2").val();
        if (pwd1 != pwd2) {
            document.getElementById("error").innerHTML = "密码输入不一致，请重新输入"
            i = 0;
        } else {
            document.getElementById("error").innerHTML = ""
            i = 1;
        }
    }

    var pwdSave = document.getElementById("pwd_save");
    pwdSave.addEventListener('click', function(){
        if (i == 1 && j == 1 && x == 1) {
            var filter = {
                password: $("#oldpwd").val()
            }
            $.ajax({
                type: 'get',
                url: "/api/users?filter=" + JSON.stringify(filter),
                dataType: "json",
                success: function (e) {
                    //alert("原密码正确")
                    var data = {
                        password: $("#newpwd2").val()
                    }
                    $.ajax({
                        type: "put",
                        url: "/api/users/" + userId,
                        data: JSON.stringify(data),
                        dataType: "json",
                        contentType: "application/json; charset=utf-8",
                        success: function (a) {
                            alert("修改密码成功")
                            back();
                        },
                        error: function (a) {
                            alert(JSON.stringify(a))
                        }
                    })
                },
                error: function (e) {
                document.getElementById("error").innerHTML = "原密码错误，请重新输入"
                 }
            })
        }
    }, false);
    /*var yanz = function () {
        alert("调用了"
        if (i == 1 && j == 1 && x == 1) {
            var filter = {
                password: $("#oldpwd").val()
            }
            $.ajax({
                type: 'get',
                url: "/api/users?filter=" + JSON.stringify(filter),
                dataType: "json",
                success: function (e) {
                    alert("原密码正确")
                   /!* var data = {
                        password: $("#newpwd2").val()
                    }
                    $.ajax({
                        type: "put",
                        url: "/api/users/" + userId,
                        data: JSON.stringify(data),
                        dataType: "json",
                        contentType: "application/json; charset=utf-8",
                        success: function (a) {
                            alert("成功")
                        },
                        error: function (a) {
                            alert(JSON.stringify(a))
                        }
                    })*!/
                },
                error: function (e) {
                    document.getElementById("error").innerHTML = "原密码错误，请重新输入"
                }
            })
        }
}*/
        var user = null
        var userId;
        var getSubjectNameById = function (subjects) {
            var result = ''
            if (subjects == 1) {
                result = "语文"
            }
            if (subjects == 2) {
                result = "数学"
            }
            if (subjects == 3) {
                result = "英语"
            }
            return result
        }
        var getSexNameById = function (sex) {
            var result = 0
            if (sex == 1) {
                result = "男"
            }
            if (sex == 2) {
                result = "女"
            }
            if (sex == "男") {
                result = 1
            }
            if (sex == "女") {
                result = 2
            }

            return result
        }
        var state = {
            currentArticle: document.getElementById('user'),
            init: function () {
                userId = g.getUrlParameter('userid')
                g.setCookie('userId', userId)

                var switchTo = function (id) {
                    state.currentArticle.style.display = 'none'
                    state.currentArticle = document.getElementById(id)
                    history.pushState(null, null, '/user.html#' + id)
                    state.currentArticle.style.display = 'block'
                    state[id].init()
                }

                $(document).on('click', '[data-article]', function (e) {
                    var id = e.target.dataset.article
                    switchTo(id)
                })

                state['user'].init()
                history.pushState(null, null, '/user.html#user')
                window.addEventListener('hashchange', function (e) {
                    var hashPos = e.newURL.indexOf('#')
                    var hash = e.newURL.substring(hashPos + 1)
                    switchTo(hash)
                })
            },
            user: {
                init: function () {
                    if (user == null) {
                        $.ajax({
                            type: 'get',
                            url: '/api/users/self',
                            dataType: 'json',
                            success: function (u) {
                                u.birthday = u.birthday.substr(0, 10)
                                u.sex = getSexNameById(u.sex)
                                user = u
                                proc({
                                    containerId: 'user',
                                    data: user,
                                    templateId: 'user-template'
                                })
                            },
                            error: function (u) {
                                alert(JSON.stringify(u))
                            }
                        })
                    }
                }
            },
            cards: {
                isCards:false,
                init: function () {
                    if (!state.cards.isCards) {
                        if (!user.cards) {
                            $.ajax({
                                type: 'get',
                                url: '/api/users/self/cards',
                                dataType: 'json',
                                success: function (cs) {
                                    for (var i = 0; i < cs.length; ++i) {
                                        var a = getSubjectNameById(cs[i].subject)
                                        cs[i].subject = a
                                    }
                                    alert(JSON.stringify(cs))
                                    user.cards = cs
                                    proc({
                                        containerId: 'card',
                                        data: user.cards,
                                        templateId: 'card-template'
                                    })
                                }
                            })
                        }
                        state.cards.isCards = true
                    }
                }/*,
                changed: function () {
                    //step1: clear the element content

                    //step2: rebind
                    proc({
                        containerId: 'card',
                        data: user.cards,
                        templateId: 'card-template'
                    })

                }*/
            },
            info: {
                isInit: false,
                init: function () {
                    if (!state.info.isInit) {
                        //document.getElementById("info").innerHTML=""
                        proc({
                            containerId: 'info',
                            data: user,
                            templateId: 'info-template'
                        })
                        state.info.isInit = true
                    }
                }
            },
            logs: {
                init: function () {
                }
            },
            /*gold: {
             init: function () {}
             },*/
            consumes: {
                init: function () {
                }
            },
            study: {
                init: function () {
                }
            },
            score: {
                init: function () {
                }
            },
            changePassword: {
                init: function () {
                }
            },
            activeCard: {
                init: function () {
                }
            },
            firstActiveCard: {
                init: function () {
                }
            },
            login: {
                init: function () {
                }
            },
            phoneLogin: {
                init: function () {
                }
            },
            settings: {
                init: function () {
                }
            },
            help: {
                init: function () {
                }
            }
        }

        state.init()

        window.addEventListener('load', function (e) {
            var cardNo = document.getElementById("cardNo")
            cardNo.addEventListener('keyup', function (e) {
                e.target.value = e.target.value.replace(/\s/g, '').replace(/\D/g, '').replace(/(\d{4})(?=\d)/g, "$1 ");
            }, false);
        }, false);


        var ajax = function (method, url, headers, data, postProcess) {
            //alert('enter');
            var xhr = new XMLHttpRequest();
            //alert('new xhr');
            xhr.onreadystatechange = function () {
                //alert('enter callback');
                if (xhr.readyState === 4) {
                    //alert('xhr state is 4');
                    var result = {meta: {code: xhr.status, text: xhr.statusText}, data: null};
                    if (xhr.responseText[0] == '{' || xhr.responseText[0] == '[') {
                        //alert('xhr success');
                        result.data = JSON.parse(xhr.responseText);
                    } else {
                        //alert('xhr failure');
                        result.data = xhr.responseText;
                    }
                    postProcess(result);
                }
            }
            //alert('set callback');
            xhr.open(method, url, false);
            //alert('open');
            for (var i = 0, c = headers.length; i < c; ++i) {
                xhr.setRequestHeader(headers[i].name, headers[i].value);
            }
            //alert('set headers');
            var sendContent = null;
            if (data != null) {
                sendContent = JSON.stringify(data);
            }
            xhr.send(sendContent);
            //alert('send content');
        }

        //userId = g.getUrlParameter('userid');
        if (userId) {
            g.setCookie("userId", userId)
        }
        var timeoutId;
        var activeCode = function (e) {
            //alert('active code')
            var phoneNumber = document.getElementById('phoneNumber').value
            if (phoneNumber != "") {
                ajax('GET', 'api/users/telephones/' + phoneNumber + '/code', [
                    {name: 'Accept', value: 'application/json'}
                ], null, function (r) {
                    var tips = document.getElementById("tips")
                    if (r.meta.code < 400) {
                        tips.innerHTML = '发送成功，请注意查收'
                    } else {
                        tips.innerHTML = '发送失败，请重新获取验证码'
                    }
                })

                var timeoutCount = 180;
                var proc = function () {
                    e.target.value = ' (' + timeoutCount + ')  秒后\n重新发送';
                    --timeoutCount;
                    e.target.disabled = true
                    if (timeoutCount <= 0) {
                        e.target.value = ' 重新发送 ';
                        clearInterval(timeoutId);
                        e.target.disabled = false
                    }
                }
                timeoutId = setInterval(proc, 1000);
            } else {
                alert('手机号不能为空')
            }
        }

        var o = 0

        var save = function (e) {
            if (o == 1) {
                var tips = document.getElementById("tips");
                tips.innerHTML = "不可以重复激活,请填写新的卡号并激活";
                return
            }
            if (document.getElementById('cardNo').value == "" || document.getElementById('password').value == "" || document.getElementById('phoneNumber').value == "" || document.getElementById('validCode').value == "") {
                alert("输入框不能为空")
            } else {

                var data = {};
                var code = document.getElementById('cardNo').value
                data.cardNo = code.replace(/\s/ig, '');
                data.password = document.getElementById('password').value;
                data.phoneNumber = document.getElementById('phoneNumber').value;
                data.validCode = document.getElementById('validCode').value;
                var url = 'api/users/self/cards'
                if (userId) {
                    url = 'api/users/' + userId + '/cards'
                }
                ajax('POST', url, [
                    {name: 'Content-Type', value: 'application/json'},
                    {name: 'Accept', value: 'application/json'}
                ], data, function (r) {
                    if (r.meta.code < 400) {
                        $.ajax({
                            type:"get",
                            url:"/api/users/cards/"+ data.cardNo,
                            dataType:"json",
                            success:function (e) {
                                alert("激活成功")
                                back();
                                user.cards.push(e);
                                alert(user.cards)
                                state.cards.isCards = false
                            },
                            error:function (e) {
                                alert(JSON.stringify(e));
                            }
                        })
                    } else {
                        //alert('save error');
                        var tips = document.getElementById("tips");
                        //alert('get tips');
                        switch (r.meta.code) {
                            case 500:
                                tips.innerHTML = "你的手机号跟别人重复啦";
                                break;
                            case 412:
                                tips.innerHTML = "请返回的我的首页";
                                break;
                            case 520:
                                tips.innerHTML = "后台错误520";
                                break;
                            case 404:
                                tips.innerHTML = "卡号或密码错误";
                                break;
                            case 405:
                                tips.innerHTML = "不可以重复激活,请填写新的卡号并激活";
                                o = 1;
                                break;
                            case 401:
                                tips.innerHTML = "手机号或验证码错误";
                                break;
                            case 410:
                                tips.innerHTML = "验证码超时";
                                break;
                            case 200:
                                $.ajax({
                                    type:"get",
                                    url:"/api/users/cards/"+ data.cardNo,
                                    dataType:"json",
                                    success:function (e) {
                                        alert("激活成功")
                                        back();
                                        user.cards.push(e);
                                        alert(user.cards)
                                        state.cards.isCards = false
                                    },
                                    error:function (e) {
                                        alert(JSON.stringify(e));
                                    }
                                })
                                break;
                        }
                    }
                })
            }
        }


    var enableActive = function (e) {
            clearInterval(timeoutId);
            var activeCodeButton = document.getElementById('activeCode');
            activeCodeButton.disabled = false
            activeCodeButton.value = '发送验证码'
        }

        var activeCodeButton = document.getElementById('activeCode');
        activeCodeButton.addEventListener('click', activeCode, false);

        var saveButton = document.getElementById('save');
        saveButton.addEventListener('click', save, false);

        var validCode = document.getElementById('validCode')

        validCode.addEventListener('change', enableActive, false)

        var phoneNumber = document.getElementById('phoneNumber')
        phoneNumber.addEventListener('change', enableActive, false)

        var save_info = document.getElementById('save_info')
        save_info.addEventListener('click', saveInfo, false)

        var cardNo = document.getElementById('cardNo')
        cardNo.addEventListener('change', function (e) {
            o = 0
        }, false)

        function saveInfo() {
            var se = $("#info_sex").val();
            var sex = getSexNameById(se);
            //alert($("#info_birthday").val())
            var b = $("#info_birthday").val();
            b += "T00:00:00+08:00";
            var data = {

                // ,

                name: $("#info_name").val(),
                sex: sex,
                telephone: $("#info_telephone").val(),
                location: $("#info_location").val(),


                birthday: b,

                school: $("#info_school").val(),

                classname: $("#info_class").val(),
                //, sex: sex1,
                //birthday: b3,
            }
           // alert(b)
            $.ajax({
                type: "put",
                url: "/api/users/" + userId,
                data: JSON.stringify(data),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (e) {
                    //alert("成功")
                    back();
                },
                error: function (e) {
                    alert('修改用户信息失败，请刷新以重试')
                }
            })
        }
    //$('#activeCode').tap(activeCode)

    //$('#save').tap(save)
</script>
<script>
    /* function Coin(opts) {
     //默认参数
     this.defaults = {
     coinSrc: "images/corn1.png",     //金币图片地址
     audioSrc: "images/shake.mp3",	//金币音频地址
     coinWidth: 30,           //金币宽度
     coinHeight: 30,          //金币高度、密度
     density: 30
     };
     this.settings = this._extendDeep(this.defaults, opts);   //深拷贝
     this.density = this.settings.density;                   //密度，即金币个数
     this.timeLag = 800;                                    //金币散落的事件间隔，数字越大表示间隔越大
     this.coinWidth = this.settings.coinWidth;               //金币宽度
     this.coinHeight = this.settings.coinHeight;             //金币高度
     this.wrapWidth = 0;
     this.wrapHeight = 0;
     this._init();
     }

     Coin.prototype = {
     constructor: Coin,
     /!**
     * 动画初始化方法
     * @method _init
     **!/
     _init: function () {
     //初始化包括尺寸大小
     this.wrapWidth = document.documentElement.clientWidth;
     this.wrapHeight = document.documentElement.clientHeight;
     this._requestAnimationFrame();
     this._createCanvas();
     this._createAudio();
     },
     /!**
     * 对象深拷贝方法
     * @method _extendDeep
     * @param  {object} parent 父对象
     {object} child  子对象
     @return {object} child  父对象继承给子对象
     **!/
     _extendDeep: function (child, parent) {
     var i,
     toStr = Object.prototype.toString,
     astr = "[object Array]";
     child = child || {};
     for (i in parent) {
     if (parent.hasOwnProperty(i)) {
     if (typeof parent[i] === "object") {
     child[i] = (toStr.call(parent[i]) === astr) ? [] : {};
     extendDeep(parent[i], child[i]);
     } else {
     child[i] = parent[i];
     }
     }
     }
     return child;
     },
     /!**
     * requestAnimationFrame做兼容
     * @method _requestAnimationFrame
     **!/
     _requestAnimationFrame: function () {
     var lastTime = 0;
     var vendors = ['webkit', 'moz'];
     for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
     window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
     window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame'] ||    // name has changed in Webkit
     window[vendors[x] + 'CancelRequestAnimationFrame'];
     }
     if (!window.requestAnimationFrame) {
     window.requestAnimationFrame = function (callback, element) {
     var currTime = new Date().getTime();
     var timeToCall = Math.max(0, 16.7 - (currTime - lastTime));
     var id = window.setTimeout(function () {
     callback(currTime + timeToCall);
     }, timeToCall);
     lastTime = currTime + timeToCall;
     return id;
     };
     }
     if (!window.cancelAnimationFrame) {
     window.cancelAnimationFrame = function (id) {
     clearTimeout(id);
     };
     }
     },
     /!**
     * 创建canvas画布
     * @method _createCanvas
     **!/
     _createCanvas: function () {
     var _self = this;
     this.canvas = document.createElement('canvas');
     this.canvas.setAttribute("data-id", Date.now());
     if (!this.canvas.getContext) {
     alert("您的浏览器不支持canvas");
     return;
     }
     this.context = this.canvas.getContext('2d');
     this.canvas.width = this.wrapWidth;
     this.canvas.height = this.wrapHeight;
     var oBody = document.getElementsByTagName('body')[0];
     oBody.appendChild(this.canvas);
     this._createCacheCanvas();
     },
     _createCacheCanvas: function () {
     var _self = this;
     this.cacheCanvas = document.createElement('canvas');
     this.cacheContext = this.cacheCanvas.getContext('2d');
     this.cacheCanvas.width = this.wrapWidth;
     this.cacheCanvas.height = this.wrapHeight;
     this.coinImg = new Image();
     this.coinImg.src = this.settings.coinSrc;
     this.coinImg.onload = function () {
     _self._startCacheCanvasAnim();
     }
     },
     /!**
     * 执行金币绘制动画
     * @method _startCanvasAnim
     **!/
     _startCacheCanvasAnim: function () {
     var _self = this;
     var availWidth = this.cacheCanvas.width - this.coinWidth;
     var availHeight = this.cacheCanvas.height - this.coinHeight;
     //var disX=availWidth/this.density;  //每个硬币X轴的间距
     var coinRange = availWidth * this.density / (this.density + 10);
     var rangeStart = (availWidth - coinRange) / 2;
     var g = 9.8 * 280;   //重力加速度
     var bPlayAudio = false;
     var coinAttrArr = [];  //存储金币下落过程中的一些属性参数
     for (var i = 0; i < _self.density; i++) {
     coinAttrArr[i] = {
     rndX: Math.random(),                                    //存储金币开始降落x轴随机值
     rndOrder: Math.round(Math.random() * _self.timeLag / 17),   //存储金币撒落顺序的一个数组
     time: 0,									               //存储金币绘制的具体时间
     top: 0,                                                 //存储金币绘制距离顶部的距离
     left: 0,                                                //存储金币弹起后距离左边的距离
     endSpeed: 0,                                            //存储金币第一次接触地面的速度
     bEnd: false,								               //存储金币是否触碰到地面
     reDownSpeed: 0,                                         //存储金币弹起后重新降落的速度
     reDownHDelta: Math.random() * 100 + 250,                    //存储金币弹起的高度参数，随机值250~350之间
     rndOffsetX: Math.random() * 0.06 + 0.97                     //存储金币x轴的偏移量，随机值0.97~1.03之间
     }
     }
     var startTime = Date.now();  //开始绘制前的时间
     function draw() {
     var drawStart = Date.now();  //记录重绘的结束事件
     var diff = (drawStart - startTime) / 1000;  //计算每次重绘所需要的事件，单位为秒
     startTime = drawStart;   //结束事件传给开始事件
     _self.context.clearRect(0, 0, _self.canvas.width, _self.canvas.height);  //清除画布，方便重绘
     _self.cacheContext.clearRect(0, 0, _self.cacheCanvas.width, _self.cacheCanvas.height);  //清除画布，方便重绘
     _self.cacheContext.save();
     //根据金币个数循环绘制金币
     for (var i = 0; i < _self.density; i++) {
     if ((coinAttrArr[i].rndOrder == 0 && coinAttrArr[i].time == 0)) {   //如果顺序为0，表示开始下落，同时下落的初始时间为0时，赋值初始时间
     coinAttrArr[i].time = diff;
     }
     if (coinAttrArr[i].time > 0) {     //如果初始事件大于0，表示已经在下落过程中,则每次的初始时间递增
     coinAttrArr[i].time = coinAttrArr[i].time + diff;
     }
     if (coinAttrArr[i].rndOrder == 0) {  //如果顺序为0，开始下落，则开始绘制金币
     if (!coinAttrArr[i].bEnd) {   //金币下落（过程一），自由落体运动
     coinAttrArr[i].top = g * Math.pow(coinAttrArr[i].time, 2) / 2 - _self.coinHeight;   //自由落体加速度运动，求下落的高度
     //coinAttrArr[i].left=disX*coinAttrArr[i].rndX+i*disX;
     coinAttrArr[i].left = coinRange * coinAttrArr[i].rndX + rangeStart;
     } else if (coinAttrArr[i].endSpeed == 0) {   //金币弹起后在空中重新下落（过程三）
     coinAttrArr[i].reDownSpeed = coinAttrArr[i].reDownSpeed * 1.1;
     coinAttrArr[i].top = coinAttrArr[i].top + coinAttrArr[i].reDownSpeed;
     coinAttrArr[i].left = coinAttrArr[i].left * coinAttrArr[i].rndOffsetX;
     } else {   //金币弹起（过程二）
     coinAttrArr[i].endSpeed = -Math.abs(coinAttrArr[i].endSpeed * 0.96);
     if (Math.abs(coinAttrArr[i].endSpeed) < 1) coinAttrArr[i].endSpeed = 0;
     coinAttrArr[i].top = coinAttrArr[i].top + coinAttrArr[i].endSpeed;
     coinAttrArr[i].left = coinAttrArr[i].left * coinAttrArr[i].rndOffsetX;
     }
     //金币第一次降落超过地面时，将其高度设置和地面齐平
     if (coinAttrArr[i].top > _self.cacheCanvas.height - _self.coinHeight && !coinAttrArr[i].bEnd) {
     coinAttrArr[i].top = _self.cacheCanvas.height - _self.coinHeight;
     }
     //金币落地时，计算落地的速度
     if (coinAttrArr[i].top == _self.cacheCanvas.height - _self.coinHeight) {
     coinAttrArr[i].endSpeed = g * coinAttrArr[i].time / coinAttrArr[i].reDownHDelta;
     coinAttrArr[i].reDownSpeed = coinAttrArr[i].endSpeed / 10;
     coinAttrArr[i].bEnd = true;
     }
     //绘制金币
     _self.cacheContext.drawImage(_self.coinImg, coinAttrArr[i].left, coinAttrArr[i].top, _self.coinWidth, _self.coinHeight);
     }
     coinAttrArr[i].rndOrder = coinAttrArr[i].rndOrder == 0 ? 0 : coinAttrArr[i].rndOrder - 1;//顺序每一次重绘则递减一次，直到为0时，代表开始下落
     }
     _self.cacheContext.restore();
     _self.context.drawImage(_self.cacheCanvas, 0, 0, _self.canvas.width, _self.canvas.height);
     var firstH = _self._maxNum(coinAttrArr, "top");//求降落过程中高度最大的金币高度
     if (firstH >= _self.cacheCanvas.height - _self.coinHeight && !bPlayAudio) {
     _self._playAudio();
     bPlayAudio = true;
     }
     var lastH = _self._minNum(coinAttrArr, "top");//求降落过程中高度最小的金币高度
     if (lastH <= _self.cacheCanvas.height + _self.coinHeight) { //最后一个金币高度超出canvas的高度停止重绘
     window.requestAnimationFrame(draw);  //重绘，递回调用绘制方法
     } else {
     console.log("金币都撒完了");
     _self._destory();
     }
     }

     window.requestAnimationFrame(draw);  //第一次绘制
     },
     /!**
     * 求最小值
     * @method _minNum
     * @param   {arr}    arr  属性数组
     {string} attr 数组下的属性名称
     * @return  {number}      返回数组下属性值最小的值
     **!/
     _minNum: function (arr, attr) {
     var tempArr = [];
     for (var i = 0; i < arr.length; i++) {
     tempArr.push(arr[i][attr]);
     }
     return tempArr.sort(function (a, b) {
     return a - b
     })[0];
     },
     /!**
     * 求最大值
     * @method _minNum
     * @param   {arr}    arr  属性数组
     {string} attr 数组下的属性名称
     * @return  {number}      返回数组下属性值最大的值
     **!/
     _maxNum: function (arr, attr) {
     var tempArr = [];
     for (var i = 0; i < arr.length; i++) {
     tempArr.push(arr[i][attr]);
     }
     return tempArr.sort(function (a, b) {
     return b - a
     })[0];
     },
     /!**
     * 创建音频对象
     * @method _createAudio
     **!/
     _createAudio: function () {
     this.audio = document.createElement('audio');
     this.audio.setAttribute("preload", "load");
     var oSource = document.createElement('source');
     oSource.setAttribute("src", this.settings.audioSrc);
     oSource.setAttribute("type", "audio/mp3");
     this.audio.appendChild(oSource);
     var oBody = document.getElementsByTagName('body')[0];
     oBody.appendChild(this.audio);
     },
     /!**
     * 播放音频
     * @method _playAudio
     **!/
     _playAudio: function () {
     this.audio.play();
     },
     /!**
     * 销毁canvas和audio
     * @method _destory
     **!/
     _destory: function () {
     var oBody = document.getElementsByTagName('body')[0];
     oBody.removeChild(this.canvas);
     oBody.removeChild(this.audio);
     }
     }

     function goldshow () {
     var oBtn = document.getElementById('btn1');
     init();
     var coin = new Coin();
     var SHAKE_THRESHOLD = 400;
     var last_update = 0;
     var index = 0;
     var x = y = z = last_x = last_y = last_z = 0;
     var w_curTime = 0;

     function init() {
     if (window.DeviceMotionEvent) {
     window.addEventListener('devicemotion', deviceMotionHandler, false);
     } else {
     alert('not support mobile event');
     }
     }

     function deviceMotionHandler(eventData) {
     var acceleration = eventData.accelerationIncludingGravity;
     var curTime = new Date().getTime();
     if ((curTime - last_update) > 100) {
     var diffTime = curTime - last_update;
     last_update = curTime;
     x = acceleration.x;
     y = acceleration.y;
     z = acceleration.z;
     var speed = Math.abs(x + y + z - last_x - last_y - last_z) / diffTime * 10000;
     var delta = Math.abs(x + y + z - last_x - last_y - last_z);
     if (speed > SHAKE_THRESHOLD) {
     if ((curTime - w_curTime) > 2000) {
     w_curTime != 0 && new Coin({density: Math.round(delta)});
     w_curTime = curTime;
     }
     }
     last_x = x;
     last_y = y;
     last_z = z;
     }
     }
     }


     var closeWindow = document.getElementById('closeWindow')
     closeWindow.addEventListener('click', function (e) {
     WeixinJSBridge.invoke('closeWindow', {}, function (res) {
     })
     }, false)*/
</script>
</body>
</html>