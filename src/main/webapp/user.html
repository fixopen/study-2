<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>用户信息</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0,user-scalable=no"
          id="viewport"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="screen-orientation" content="portrait"/>

    <!-- 引入样式表 -->
    <link rel="stylesheet" href="myUser/css/common.css"/>
   <link rel="stylesheet" href="myUser/css/global.css">
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <link rel="stylesheet" href="myUser/css/user.css">


</head>
<body>
<article id="sign" style="display: none">
    <div class="wrap">
        <div class="header">
            <div class="avatar"></div>
            <div class="touImg">
                 <img src="myUser/image/login_tou.png" class="avatarImg"/>
            </div>
            <ul class="tab_switch">
                <li class="tab_swli cur">
                    <a class="tab_mima" href="JavaScript:;" id="pass">密码登录</a>
                    <span class="now_sanjiao"></span>
                </li>
                <li class="tab_swli">
                    <a class="tab_duanx" href="JavaScript:;" id="shortMessage">短信登录</a>
                    <span class="now_sanjiao sanJer"></span>
                </li>
            </ul>
        </div>
        <div class="mine_zilo">
            <div class="mine_table cur" id="username">
                <ul class="mine_zUl">
                    <li class="mine_zuli">
                        <span class="mine_leftsp">账号</span>
                        <input class="mine_rightip" type="number" id="Number" placeholder="请输入已激活手机号">
                        <i class="errorTs" id="errorNumber">
                            <!--该手机号尚未绑卡激活，请重新输入-->
                        </i>
                    </li>
                    <li class="mine_zuli">
                        <span class="mine_leftsp">密码</span>
                        <input class="mine_rightip" type="password" id="Dense" placeholder="请输入6-16位密码">
                        <a class="eye" href="#"></a>
                        <i class="errorTs" id="errorpassword1">
                            <!--密码错误-->
                        </i>
                    </li>
                    <li class="mine_zuli zuli_yzm" style="display: block;">
                        <span class="mine_leftsp">验证码</span>
                        <input class="mine_rightip" type="password" id="Verification" placeholder="请输入验证码">
                        <a class="yanZma" href="#">点击换一张</a>
                        <i class="errorTs">
                            <!--验证码错误-->
                        </i>
                    </li>
                    <span id="zhanghaoerror"></span>
                </ul>
            </div>
            <div class="mine_table" id="short">
                <ul class="mine_zUl">
                    <li class="mine_zuli">
                        <span class="mine_leftsp">账号</span>
                        <input class="mine_rightip" type="number" id="duanNumber" placeholder="请输入已激活手机号">
                    </li>
                    <li class="mine_zuli">
                        <span class="mine_leftsp">密码</span>
                        <input class="mine_rightip" type="password" id="duanDense" placeholder="请输入短信密码">
                        <!--<a class="famima" href="JavaScript:;" id="fapassword">发送密码</a>-->
                        <input type="button" id="fapassword" class="famima"  value="发送密码">
                    </li>
                </ul>
                <span class="mine_tishi" id="errorfamima"></span>
            </div>
            <div class="bottom_bdiv">
                <a class="bottom_btn" href="JavaScript:;" id="signSubmit">登 录</a>
            </div>
            <div class="bottom_txt" data-article="firstActiveCard"><span class="leftLine">——</span>还没有账号？先去“填加卡号”<span class="leftLine">——</span></div>
        </div>
    </div>

</article>
<article id="gold" style="display: none">
    <!--<div class="goldwrap"></div>
    <div class="goldbgImg">
        <div class="goldcloud1"></div>
        <div class="goldblue-bg"></div>
        <div class="goldbtm-img">
            <a href="javascript:;" onclick="kai()">完善资料</a>
        </div>
    </div>
    <div class="goldcloud2"></div>
    <div class="goldwords">
        <div class="goldtac">
            <img src="myUser/image/gx.png" height="43" width="296" alt=""/><br>
            <img class="goldtac_erimg"  src="myUser/image/wanshan.png" height="43" width="183" alt=""/><br>
            <img src="myUser/image/cg.png" height="88" width="457"/>
        </div>
    </div>-->
    <div class="goldwrap"></div>
    <div class="goldbgImg">
        <div class="goldcloud1"></div>
        <div class="goldblue-bg"></div>
        <div class="goldbtm-img">
            <a href="JavaScript:;" data-article="info">完善资料</a>
        </div>
    </div>
    <div class="goldcloud2"></div>
    <div class="goldwords">
        <div class="goldtac">
            <img src="images/gx.png" alt=""><br>
            <img class="goldtac_erimg" src="images/wanshan.png" alt=""><br>
            <img src="images/cg.png" alt="">
        </div>
    </div>
</article >
<article id="user">
</article>
<article id="cards" style="display: none;">
        <!--<div class="user_div_css">-->
            <div id="card"></div>
            <!--<div class="card_button_div_css">-->
                <a class="card_button_css " href="JavaScript:;">充值</a>
                <a class="card_button_css card_button_background_css" href="JavaScript:;" data-article="firstActiveCard">添加卡号</a>
                <!--<a class="bottom_btn Btn02" href="JavaScript:;" onclick="back()">返回上一页</a>-->
            <!--</div>-->
        <!--</div>-->
</article>
<article id="info" style="display: none;"></article>
<!--<article id="gold" style="display: none;">
    <div class="wrap"></div>
    <div class="bgImg">
        <div class="cloud1"></div>
        <div class="blue-bg"></div>
        <div class="btm-img">
            <a href="javascript:void(0)" id="closeWindow">返回首页学习</a>
        </div>
    </div>
    <div class="cloud2"></div>
    <div class="words">
        <div class="tac">
            <img src="images/gx.png" alt=""><br>
            <img src="images/cg.png" alt="">
        </div>
    </div>
</article>-->
<article id="logs" style="display: none;"></article>
<article id="head" style="display: none;">
    <!--<img src="" alt="" id="myimg">-->
</article>
<!--<article id="gold" style="display: none;">
    <div class="goldwrap"></div>
    <div class="goldbgImg">
        <div class="goldcloud1"></div>
        <div class="goldblue-bg"></div>
        <div class="goldbtm-img">
            <a href="javascript:void(0)" id="closeWindow">返回首页学习</a>
        </div>
    </div>
    <div class="goldcloud2"></div>
    <div class="goldwords">
        <div class="goldtac">
            <img src="images/gx.png" alt=""><br>
            <img src="images/cg.png" alt="">
        </div>
    </div>
</article>-->
<article id="consumes" style="display: none;"></article>
<article id="study" style="display: none;"></article>
<article id="score" style="display: none;"></article>
<article id="change-password" style="display: none;">
    <div class="wrap">
        <!-- main -->
            <ul class="changePassword_ul_css">
                <li class="changePassword_li_css public_li_css" >
                    <span class="public_span_css changePassword_interval_width_css" >原密码</span>
                    <input class="firstActiveCard_input_css" type="password" id="oldpwd" placeholder="请输入原密码">
                </li>
                <li class="changePassword_li_css public_li_css">
                    <span class="public_span_css changePassword_interval_width_css">新密码</span>
                    <input class="firstActiveCard_input_css" type="password" id="newpwd1" placeholder="请输入新密码">
                </li>
                <li class="changePassword_li_css public_li_css">
                    <span class="public_span_css changePassword_interval_width_css">确认新密码</span>
                    <input class="firstActiveCard_input_css" type="password" id="newpwd2" placeholder="请确认新密码">
                </li>
                <div id="error"></div>
            </ul>

            <div class="changePassword_box_css">
                <a href="javascript:void(0)" class="changePassword_button_css" id="pwd_save">保 存</a>
                <a href="javascript:void(0)" id="quxiao" class="changePassword_save_css">取 消</a>
            </div>
        </div>
</article>
<!--<article id="activeCard" style="display: none;">
    <section style="overflow: hidden; background-color: #fff; border-top: 1px solid #e5e5e5;">
        <div>
            <span class="common-font common-line-height title">卡号</span>
            <input type="text" id="cardNo" class="common-font common-line-height common-border-style value"
                   placeholder="请输入卡号" required pattern="\d+"/>
        </div>
        <div>
            <span class="common-font common-line-height title">密码</span>
            <input type="password" id="password" class="common-font common-line-height common-border-style value"
                   placeholder="请输入密码" required/>
        </div>
    </section>
    <div id="tips" class="common-font common-line-height common-border-style tips">欢迎来到激活卡页面!</div>
    <input type="button" id="save" class="common-font common-line-height common-border-style save" value="确 认"/>
</article>-->
<article id="firstActiveCard" style="display: none;">
    <div class="wrap">
        <section style="overflow: hidden; background-color: #fff; border-top: 1px solid #e5e5e5;">
            <div class="firstActiveCard_li_css public_li_css">
                <span class="public_span_css changePassword_interval_width_css">卡号</span>
                <input class="firstActiveCard_input_css" type="text" placeholder="请输入卡号" id="cardNo"
                       style="height:20px; font-size:18px;"
                       required pattern="\d+">
                <!--onkeyup="test()"-->
            </div>
            <div class="firstActiveCard_li_css public_li_css">
                <span class="public_span_css changePassword_interval_width_css">密码</span>
                <input class="firstActiveCard_input_css" type="password" placeholder="请输入密码" id="password"
                       style="height:20px; font-size:18px;" required>
            </div>
            <div class="firstActiveCard_li_css public_li_css">
                <span class="public_span_css changePassword_interval_width_css">手机号</span>
                <input class="firstActiveCard_input_css" type="tel" id="phoneNumber" placeholder="请输入手机号" required pattern="\d+"
                       style="height:20px; width: 115px; font-size:16px;">
                <input type="button" id="activeCode" style="display: inline-block; font-size:14px;" value="获取验证码"
                       class="send-btn cur">
            </div>
            <div class="firstActiveCard_li_css public_li_css">
                <span class="public_span_css changePassword_interval_width_css">验证码</span>
                <input class="firstActiveCard_input_css" type="text" placeholder="请输入验证码" id="validCode"
                       style="height:20px; font-size:18px;" required
                       pattern="\d{6}">
            </div>
        </section>
        <br/>
        <div style="font-size: 0.875rem; color: #fe6568; padding-left: 0.875rem; box-sizing: border-box; line-height: 1.375rem;"
             id="tips">
            欢迎来到激活卡页面!
        </div>
        <br/>
        <button id="save" style="text-decoration: none; color: #fff; height: 3.75rem;  width: 90%; text-align: center; display: block; font-size: 18px;  margin-left: 5%;
    margin-right: 5%; background-color: #fe6568; border: none">确 认
        </button>
        <br/>
        <!--  <button onclick="back()" style="text-decoration: none; color: #fff; height: 3.75rem;  width: 90%; text-align: center; display: block; font-size: 18px;  margin-left: 5%;
      margin-right: 5%; background-color: #fe6568; border: none">返回上一页
          </button>-->
    </div>
</article>
<article id="login" style="display: none;">
    <div>
        <span class="common-font common-line-height title">手机号</span>
        <input type="tel" id="login-account" class="common-font common-line-height common-border-style value"
               placeholder="请输入手机号" required pattern="\d+"/>
    </div>
    <div>
        <span class="common-font common-line-height title">密码</span>
        <input type="text" id="login-password" class="common-font common-line-height common-border-style value"
               placeholder="请输入验证码" required pattern="\d{6}"/>
    </div>
</article>
<article id="phone-login" style="display: none;">
    <div>
        <span class="common-font common-line-height title">手机号</span>
        <input type="tel" id="login-phoneNumber" class="common-font common-line-height common-border-style value"
               placeholder="请输入手机号" required pattern="\d+"/>
        <input type="button" id="login-activeCode" class="common-font common-border-style validButton" value="获取手机验证码"/>
    </div>
    <div>
        <span class="common-font common-line-height title">验证码</span>
        <input type="text" id="login-validCode" class="common-font common-line-height common-border-style value"
               placeholder="请输入验证码" required pattern="\d{6}"/>
    </div>
</article>
<article id="settings" style="display: none;">
    <div class="wrap">
        <!-- main -->

        <div class="changePassword_div_css">
            <ul class="changePassword_ul_css">
                <li class="firstActiveCard_li_css public_li_css">
                    <a href="javascript:void(0)" data-article="change-password">修改密码 <span class="next-btn"></span></a>
                </li>
                <li class="firstActiveCard_li_css public_li_css">
                    <a href="javascript:void(0)" data-article="info">修改个人信息 <span class="next-btn"></span></a>
                </li>
                <li class="firstActiveCard_li_css public_li_css">
                    <a href="javascript:void(0)" data-article="firstActiveCard">添加新卡 <span class="next-btn"></span></a>
                </li>
                <!--<li class="set-li">
                    <a href="javascript:void(0)" onclick="back()">返回上一页 <span class="next-btn"></span></a>

                </li>-->
            </ul>
        </div>

    </div>
</article>
<article id="help" style="display: none;">
    <div class="wrap">
        <div class="userTou">
            三味学堂用户操作流程
        </div>
        <div class="rain-main">
            <ul>
                <li class="daEr_li">
                    <div class="daYi">1.新书扫一扫</div>
                    <ul class="daEr">
                        <li class="daEr_li">①您购买了三味学堂的图书，可以扫一扫图书的二维码，进入“三味学堂”。</li>
                        <li class="daEr_li">②在页面下方“活动公告”栏中选“账号管理”，进入页面，点击“注册”，注册成为我们的会员。</li>
                        <li class="daEr_li">③注册完成后，点击“登录”，登录自己的账号，进行学习。</li>
                        <li class="daEr_li">④之后可以选择“我的账号信息”，完善自己的资料。</li>
                        <li class="daEr_li">注意：每本新书只可以扫描一次哦。您若购买了多本图书，可以多次扫描，但只需注册一次就可以了。</li>
                    </ul>
                </li>
                <li class="daEr_li">
                    <div class="daYi">2.新用户注册</div>
                    <ul class="daEr">
                        <li class="daEr_li">①您若是扫描了“三味学堂”的二维码或是加微信关注了“三味学堂”，可以进入“三味学堂”进行体验。</li>
                        <li class="daEr_li">②若想观看更多精彩内容，可以在首页下方“活动公告”栏中选“账号管理”，进入页面，点击“注册”，注册成为我们的会员。</li>
                        <li class="daEr_li">③注册完成后，点击“登录”，登录自己的账号，点击“我的充值”进行充值。</li>
                        <li class="daEr_li">④之后可以选择“我的账号信息”，完善自己的资料。</li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</article>
<article id="nickname" style="display: none">
    <div class="wrap">
        <div class="mine_zilo">
            <ul class="mine_zUl">
                <li class="mine_zuli">
                    <span class="mine_leftsp">昵称</span>
                    <input class="mine_rightip" type="text" value="小雨知时" id="nicknameval">
                    <a class="chahao" href="JavaScript:;" id="nicehng"></a>
                </li>
            </ul>
        </div>
    </div>
</article>
<template id="user-template">
    <!--<div class="user_div_css">-->
        <ul class="public_ul_css">
            <li class="user_li_css public_li_css" data-article="head">
                <span class="public_span_css">我的头像</span>
                <img class="user_head_css" src="${head}" alt="">
            </li>
            <li class="user_li_css public_li_css" data-article="nickname">
                <span class="public_span_css">昵称</span>
                <input class="user_input_css public_input_css" type="text" value="${name}" readonly>
            </li>
            <li class="user_li_css public_li_css">
                <span class="public_span_css">账号</span>
                <input class="user_input_css public_input_css" type="text" value="${telephone}" readonly>
            </li>
            <li>
                <ul class="user_li_css public_li_css" data-article="info">个人资料</ul>
            </li>
<br/>

            <li>
                <ul class="user_li_css public_li_css" data-article="cards">我的学习卡</ul>
            </li>
            <li>
                <ul class="user_li_css public_li_css" >学习记录</ul>
            </li>
            <br/>
            <li>
                <ul class="user_li_css public_li_css" >账户余额</ul>
            </li>
            <li>
                <ul class="user_li_css public_li_css" >充值</ul>
            </li>
            <li>
                <ul class="user_li_css public_li_css" >我的积分</ul>
            </li>
            <br/>
            <li class="user_li_css public_li_css" data-article="settings">设置</li>
            <li class="user_li_css public_li_css" data-article="help">帮助</li>
        </ul>
    <!--</div>-->
</template>
<template id="info-template">
    <ul class="public_ul_css">
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">真实姓名</span>
            <input class="info_input_width_css public_input_css" type="text" placeholder="请输入真实姓名" value="${name}" id="info_name">
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">手机号</span>
            <input class="info_input_width_css public_input_css" type="tel" value="${telephone}" id="info_telephone">
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">性别</span>
            <input class="info_input_width_css public_input_css" type="text" value="${sex}" id="info_sex">
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">出生年月</span>
            <input id="date" class="info_input_width_css public_input_css" type="date" value="${birthday}" >
            <!--value="${birthday}"  placeholder="请选择出生日期" style="height:41px;overflow: hidden;"  style="height:41px;overflow: hidden;"-->
            <!--<input class="infomine_rightip" type="date" value="${birthday}" placeholder="请选择出生日期" style="height:41px;overflow: hidden;" id="info_birthday">-->
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">收货地址</span>
            <input class="info_input_width_css public_input_css" type="text" placeholder="请输入收货地址" value="${location}" id="info_location">
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">就读学校</span>
            <input class="info_input_width_css public_input_css" type="text" value="${school}" id="info_school">
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">所在班级</span>
            <input class="info_input_width_css public_input_css" type="text" value="${classname}" id="info_class">
        </li>
        <li>
            <span class="public_span_css info_interval_width_css"></span>
            <button id="save_info"  style="text-decoration: none; color: #fff; height: 3.75rem;  width: 90%; text-align: center; display: block; font-size: 18px;  margin-left: 5%;
    margin-right: 5%; background-color: #fe6568; border: none">确 认
            </button>
        </li>
    </ul>
</template>
<template id="card-template">
    <ul class="public_ul_css">
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">卡号</span>
            <span class="public_input_css">${no}</span>
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">学习类型</span>
            <span class="public_input_css">${subject}</span>
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">激活时间</span>
            <span class="public_input_css">${activeTime}</span>
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">剩余雨点</span>
            <span class="public_input_css">${amount}</span>
        </li>
        <li class="public_li_css">
            <span class="public_span_css info_interval_width_css">有效期</span>
            <span class="public_input_css">${endTime}</span>
        </li>
    </ul>
</template>
<template id="consume-template">
    <li>
        <p>${time}</p>
        <p>${direction}</p>
        <p><span>${amount}</span>金豆</p>
    </li>
</template>
<template id="study-template">

</template>
<template id="settings-template">

</template>


<!--<dialog>添加成功啦！<br>请到我的学习卡里~</dialog>-->

<!-- 引入js -->
<script src="/jquery/jquery-3.1.1.min.js"></script>
<!--<script type="text/javascript" src="/zepto/zepto.min.js"></script>-->
<!--<script type="text/javascript" src="/zepto/touch.js"></script>-->
<!--<script type="text/javascript" src="/zepto/selector.js"></script>-->
<script src="/util.js"></script>
<script src="/basic.js"></script>
<script>

    var user = null;
    var sessionId;
    var userId;
    var pan;
    var duan;
    //var count =0;
    var oppid;
    var state = {
        currentArticle: document.getElementById('sign'),
        init: function () {
            sessionId = g.getUrlParameter('sessionId')
            g.setCookie('sessionId', sessionId, '/api')
            oppid = g.getUrlParameter("oppid");
            alert(oppid)
         //   alert(sessionId)
           /* $.ajax({
                type:"get",
                url:"/api/users/"+sessionId+"/userId",
                dataType:"json",
                success:function (e) {
                userId = e;
                }
            })*/

            var switchTo = function (id) {
                state.currentArticle.style.display = 'none'
                state.currentArticle = document.getElementById(id)
                history.pushState(null, null, '/user.html#' + id)
                state.currentArticle.style.display = 'block'
                state[id].init()
            }

            $(document).on('click', '[data-article]', function (e) {
                var id = e.target.dataset.article
                switchTo(id)
            })
            /*if(oppid != null){
                switchTo("user")
            }else{
                switchTo("sign")
            }*/
            state['sign'].init()
            history.pushState(null, null, '/user.html#user');
            window.addEventListener('hashchange', function (e) {
                var hashPos = e.newURL.indexOf('#')
                var hash = e.newURL.substring(hashPos + 1)
                switchTo(hash)
            }, false)
        },
        getSubjectNameById: function (subjects) {
            var result = ''
            if (subjects == 1) {
                result = "语文"
            }
            if (subjects == 2) {
                result = "数学"
            }
            if (subjects == 3) {
                result = "英语"
            }
            return result
        },
        getSexNameById:function (sex) {
            var result = 0
            if (sex == 1) {
                result = "男"
            }
            if (sex == 2) {
                result = "女"
            }
            if (sex == "男") {
                result = 1
            }
            if (sex == "女") {
                result = 2
            }

            return result
        },
        sign: {

            init: function () {
                document.getElementById("sign").style.display="block"
                var biaoji = 1;
                var shortMessage = document.getElementById("shortMessage");
                shortMessage.addEventListener('click',function (e) {
                    document.getElementById("username").style.display="none";
                    document.getElementById("short").style.display="block";
                    biaoji = 0;
                })
                var pass = document.getElementById("pass");
                pass.addEventListener('click',function (e) {
                    document.getElementById("username").style.display="block";
                    document.getElementById("short").style.display="none";
                    biaoji = 1;
                })
                var deviceType;
                var fapassword = document.getElementById('fapassword');
                fapassword.addEventListener('click', function () {
                    //count = 0;
                    state.firstActiveCard.activeCode(0)
                }, false);

                var signSubmit = document.getElementById("signSubmit");
                signSubmit.addEventListener('click',function (e) {
                    var browser = {
                        versions: function () {
                            var u = navigator.userAgent, app = navigator.appVersion;
                            var yng =
                                {//移动终端浏览器版本信息
                                    trident: u.indexOf('Trident') > -1, //IE内核
                                    presto: u.indexOf('Presto') > -1, //opera内核
                                    webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
                                    gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
                                    mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
                                    ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
                                    android: u.indexOf('Android') > -1, //android终端
                                    iPhone: u.indexOf('iPhone') > -1, //是否为iPhone
                                    iPad: u.indexOf('iPad') > -1, //是否iPad
                                    webApp: u.indexOf('Safari') == -1 //是否web应该程序，没有头部与底部
                                };

                            if(yng.mobile == true){
                                if(yng.ios == true){
                                    deviceType = "ios";
                                }
                                if(yng.android == true){
                                    deviceType = "android";
                                }
                                if(yng.iPhone == true){
                                    deviceType = "iPhone";
                                }
                                if(yng.iPad == true){
                                    deviceType = "iPad";
                                }
                            }else{
                                if(yng.trident == true){
                                    deviceType = "IE内核";
                                }
                                if(yng.presto == true){
                                    deviceType = "opera内核";
                                }
                                if(yng.webKit == true){
                                    deviceType = "苹果/谷歌内核";
                                }
                                if(yng.gecko == true){
                                    deviceType = "火狐内核";
                                }
                            }
                            return yng;
                        } (),
                        // language: (navigator.browserLanguage || navigator.language).toLowerCase()
                    }
                    alert(deviceType)
                   // alert(JSON.stringify(deviceType))
                    var loginInfo={};
                    var nub =$("#Number").val();
                    var dnub =$("#duanNumber").val();

                    if(biaoji == 1){
                        loginInfo = {
                            info:nub,
                            key:$("#Dense").val(),
                            type:"telephone",
                            deviceType:deviceType,
                            deviceNo:nub,
                            openId:g.getUrlParameter('openId'),
                        }
                        var dense = $("#Dense").val();
                        if (dense.length >= 6 && dense.length <= 16) {
                            document.getElementById("errorpassword1").style.display="none";
                            document.getElementById("errorpassword1").innerHTML = ""
                            pan = 0
                        } else {
                            document.getElementById("errorpassword1").style.display="block";
                            document.getElementById("errorpassword1").innerHTML = "请输入6-16位密码";
                            pan = 1
                        }

                        var ber = $("#Number").val();
                        if (ber.length != 11) {
                            document.getElementById("errorNumber").style.display="block";
                            document.getElementById("errorNumber").innerHTML = "请输入正确的手机格式";
                            duan = 1
                        } else {
                            document.getElementById("errorNumber").style.display="none";
                            document.getElementById("errorNumber").innerHTML = ""
                            duan = 0
                        }
                        if(pan == 0 && duan == 0){
                            send(loginInfo)
                        }
                    }else{
                        loginInfo = {
                            info:dnub,
                            key:$("#duanDense").val(),
                            type:"validationCode",
                            deviceType:deviceType,
                            deviceNo:dnub,
                            openId:g.getUrlParameter('openId'),
                        }
                        send(loginInfo)
                    }


                    function send(loginInfo) {
                        $.ajax({
                            type:"PUT",
                            url:"/api/sessions",
                            data:JSON.stringify(loginInfo),
                            dataType:"json",
                            contentType: "application/json; charset=utf-8",
                            success:function (a) {
                                alert("登录成功")
                               // document.getElementById("sign").style.display="none"
                               // state.init()
                                //switchTo("user")
                            },
                            error:function (e) {
                                alert(JSON.stringify(e))
                                /*  alert("登录失败");*/
                                if(loginInfo.type == "telephone"){
                                    document.getElementById("zhanghaoerror").innerHTML="账号或密码错误，请重新输入！"
                                }else {
                                    if(e.status == 405){
                                        document.getElementById("errorfamima").innerHTML="密码过期，请重新输入！"
                                    }else {
                                        document.getElementById("errorfamima").innerHTML="手机号或密码错误，请重新输入！"
                                    }

                                }

                            }
                        })
                    }
                })
            },




        },
        user: {
            init: function () {
                if (user == null) {
                    $.ajax({
                        type: 'get',
                        url: '/api/users/self',
                        dataType: 'json',
                        success: function (u) {
                            u.birthday = u.birthday.substr(0, 10)
                            u.sex = state.getSexNameById(u.sex);
                            user = u;
                            proc({
                                containerId: 'user',
                                data: user,
                                templateId: 'user-template'
                            })
                        },
                        error: function (u) {
                            alert(JSON.stringify(u))
                        }
                    })
                }
            },

        },
        cards: {
            isCards: false,
            init: function () {
                if (!state.cards.isCards) {
                    if (!user.cards) {
                        $.ajax({
                            type: 'get',
                            url: '/api/users/self/cards',
                            dataType: 'json',
                            success: function (cs) {
                                for (var i = 0; i < cs.length; ++i) {

                                    var a = state.getSubjectNameById(cs[i].subject);

                                    cs[i].subject = a;
                                }
                                user.cards = cs
                                proc({
                                    containerId: 'card',
                                    data: user.cards,
                                    templateId: 'card-template'
                                })
                            }
                        })
                    } else {
                        document.getElementById("card").innerHTML = "";
                        proc({
                            containerId: 'card',
                            data: user.cards,
                            templateId: 'card-template'
                        })
                    }
                    state.cards.isCards = true
                }
            }
        },
        info: {
            isInit: false,
            init: function () {
                if (!state.info.isInit) {
                    //document.getElementById("info").innerHTML=""
                    proc({
                        containerId: 'info',
                        data: user,
                        templateId: 'info-template'
                    })
                    state.info.isInit = true
                }
                var save_info = document.getElementById('save_info')
                save_info.addEventListener('click', saveInfo, false)

                function saveInfo() {
                    var se = $("#info_sex").val();
                    var sex = state.getSexNameById(se);
                    var b = $("#info_birthday").val();
                    b += "T00:00:00+08:00";
                    var data = {
                        name: $("#info_name").val(),
                        sex: sex,
                        telephone: $("#info_telephone").val(),
                        location: $("#info_location").val(),
                        birthday: b,
                        school: $("#info_school").val(),
                        classname: $("#info_class").val(),
                    }

                    $.ajax({
                        type: "put",
                        url: "/api/users/" + sessionId,
                        data: JSON.stringify(data),
                        dataType: "json",
                        contentType: "application/json; charset=utf-8",
                        success: function (e) {
                            //alert("成功")
                            history.back();
                        },
                        error: function (e) {
                            alert('修改用户信息失败，请刷新以重试')
                        }
                    })
                }
            }
        },
        logs: {
            init: function () {
            }
        },
        gold: {
            init: function () {

            },
         },
        consumes: {
            init: function () {
            }
        },
        head: {
            init: function () {

                var url = window.location.href;
                url = url.replace(/[/]/g, ',')
                $.ajax({
                    type: "get",
                    url: "/api/public-account/config/" + url,
                    dataType: "json",
                    success: function (e) {
                        alert(JSON.stringify(e));
                        wechat(e.appId, e.timestamp, e.nonceStr, e.signature)
                    },error:function (e) {
                        alert(JSON.stringify(e));
                        wechat(e.appId, e.timestamp, e.nonceStr, e.signature)
                    }
                })
                function wechat(appId, timestamp, nonceStr, signature) {
                    wx.config({
                        debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                        appId: appId, // 必填，公众号的唯一标识
                        timestamp: timestamp, // 必填，生成签名的时间戳
                        nonceStr: nonceStr, // 必填，生成签名的随机串
                        signature: signature,// 必填，签名，见附录1
                        jsApiList: ['chooseImage', 'uploadImage', 'downloadImage']  // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
                    });
                    wx.error(function (res) {
                        // config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
                        gettick();
                        alert("服务器繁忙，请刷新！")
                    });
                    wx.ready(function () {
                        wx.chooseImage({
                            count: 1,
                            needResult: 1,
                            sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
                            sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
                            success: function (res) {
                                var localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                                //上传图片接口
                                wx.uploadImage({
                                    localId: localIds.toString(), // 需要上传的图片的本地ID，由chooseImage接口获得
                                    isShowProgressTips: 1, // 默认为1，显示进度提示
                                    success: function (res) {
                                        var mediaId = res.serverId; // 返回图片的服务器端ID
                                        //alert("返回图片的服务器端ID=="+mediaId)
                                        libai(mediaId)
                                    }
                                });
                            }
                        });
                    })
                }

                function gettick() {
                    $.ajax({
                        type: "get",
                        url: "/api/public-account/ticket/",
                        dataType: "json",
                        success: function (e) {
                            //alert(JSON.stringify(e))
                        },
                        error: function (e) {
                            //alert(JSON.stringify(e))
                        }
                    })
                }
             /*var sdakfjlasf = "6GMxwySqgrQCtgcw0M-FcFQH6OUG0JgGPypedTaFJntlEwzAlB4BnGajCeiifCUB";
                libai(sdakfjlasf);
                function libai(mediaId) {
                    alert("李白来了" + mediaId)
                    $.ajax({
                        type: "GET",
                        url: "/api/public-account/weChat/Head/" + mediaId,
                        dataType: "json",
                        success: function (e) {
                            alert("成功" + JSON.stringify(e))
                            user.head=e.head;
                            state.user.isCards = false
                            history.back();
                        },
                        error: function (e) {
                            alert(JSON.stringify(e))
                        }
                    })
                }*/
            }
        },
        study: {
            init: function () {
            }
        },
        score: {
            init: function () {
            }
        },
        changePassword: {
            init: function () {
            }
        },
        activeCard: {
            init: function () {
            }
        },
        firstActiveCard: {
            init: function () {

                var cardNo = document.getElementById("cardNo");
                cardNo.addEventListener('keyup', function (e) {
                    e.target.value = e.target.value.replace(/\s/g, '').replace(/\D/g, '').replace(/(\d{4})(?=\d)/g, "$1 ");
                }, false);
                var ajax = function (method, url, headers, data, postProcess) {
                    //alert('enter');
                    var xhr = new XMLHttpRequest();
                    //alert('new xhr');
                    xhr.onreadystatechange = function () {
                        //alert('enter callback');
                        if (xhr.readyState === 4) {
                            //alert('xhr state is 4');
                            var result = {meta: {code: xhr.status, text: xhr.statusText}, data: null};
                            if (xhr.responseText[0] == '{' || xhr.responseText[0] == '[') {
                                //alert('xhr success');
                                result.data = JSON.parse(xhr.responseText);
                            } else {
                                //alert('xhr failure');
                                result.data = xhr.responseText;
                            }
                            postProcess(result);
                        }
                    }
                    //alert('set callback');
                    xhr.open(method, url, false);
                    //alert('open');
                    for (var i = 0, c = headers.length; i < c; ++i) {
                        xhr.setRequestHeader(headers[i].name, headers[i].value);
                    }
                    //alert('set headers');
                    var sendContent = null;
                    if (data != null) {
                        sendContent = JSON.stringify(data);
                    }
                    xhr.send(sendContent);
                    //alert('send content');
                }

                //userId = g.getUrlParameter('userid');
               /* if (userId) {
                    g.setCookie("userId", userId)
                }
*/

                var o = 0

                var save = function (e) {
                    if (o == 1) {
                        var tips = document.getElementById("tips");
                        tips.innerHTML = "不可以重复激活,请填写新的卡号并激活";
                        return
                    }
                    if (document.getElementById('cardNo').value == "" || document.getElementById('password').value == "" || document.getElementById('phoneNumber').value == "" || document.getElementById('validCode').value == "") {
                        alert("输入框不能为空")
                    } else {
                        document.getElementById("gold").style.display="block";
                       /* kai();*/
                        /*var data = {};
                        var code = document.getElementById('cardNo').value
                        data.cardNo = code.replace(/\s/ig, '');
                        data.password = document.getElementById('password').value;
                        data.phoneNumber = document.getElementById('phoneNumber').value;
                        data.validCode = document.getElementById('validCode').value;
                        var url = '/api/users/self/cards'
                        if (userId) {
                            url = '/api/users/' + userId + '/cards'
                        }
                        $.ajax({
                            type:"post",
                            url:url,
                            dataType:"json",
                            data:JSON.stringify(data),
                            contentType: "application/json; charset=utf-8",
                            success:function (e) {
                                $.ajax({
                                    type: "get",
                                    url: "/api/cards/" + e.id,
                                    dataType: "json",
                                    success: function (e) {
                                        // alert("激活成功")
                                      /!*  e.subject =state.getSubjectNameById(e.subject)
                                        // getSubjectNameById(e.subject)
                                        user.cards.push(e);
                                        //alert(user.cards)
                                        state.cards.isCards = false;*!/
                                        document.getElementById("gold").style.display="block";
                                        state.gold.yao();
                                        // history.back();
                                        //back();
                                    },
                                    error: function (e) {
                                        alert(JSON.stringify(e));
                                    }
                                })
                            },
                            error:function (e) {
                                var tips = document.getElementById("tips");
                                switch (e.status) {
                                    case 500:
                                        tips.innerHTML = "你的手机号跟别人重复啦";
                                        break;
                                    case 412:
                                        tips.innerHTML = "请返回的我的首页";
                                        break;
                                    case 520:
                                        tips.innerHTML = "后台错误520";
                                        break;
                                    case 404:
                                        tips.innerHTML = "卡号或密码错误";
                                        break;
                                    case 405:
                                        tips.innerHTML = "不可以重复激活,请填写新的卡号并激活";
                                        break;
                                    case 401:
                                        tips.innerHTML = "手机号或验证码错误";
                                        break;
                                    case 410:
                                        tips.innerHTML = "验证码超时";
                                        break;

                                }
                            }
                        })*/
                        /*ajax('POST', url, [
                            {name: 'Content-Type', value: 'application/json'},
                            {name: 'Accept', value: 'application/json'}
                        ], data, function (r) {
                            if (r.meta.code < 400) {
                                $.ajax({
                                    type: "get",
                                    url: "/api/users/cards/" + data.cardNo,
                                    dataType: "json",
                                    success: function (e) {
                                       // alert("激活成功")
                                        e.subject =state.getSubjectNameById(e.subject)
                                                // getSubjectNameById(e.subject)
                                        user.cards.push(e);
                                        //alert(user.cards)
                                        state.cards.isCards = false;
                                        document.getElementById("gold").style.display="block";
                                        state.gold.yao();
                                       // history.back();
                                        //back();
                                    },
                                    error: function (e) {
                                        alert(JSON.stringify(e));
                                    }
                                })
                            } else {
                                //alert('save error');
                                var tips = document.getElementById("tips");
                                //alert('get tips');
                                switch (r.meta.code) {
                                    case 500:
                                        tips.innerHTML = "你的手机号跟别人重复啦";
                                        break;
                                    case 412:
                                        tips.innerHTML = "请返回的我的首页";
                                        break;
                                    case 520:
                                        tips.innerHTML = "后台错误520";
                                        break;
                                    case 404:
                                        tips.innerHTML = "卡号或密码错误";
                                        break;
                                    case 405:
                                        tips.innerHTML = "不可以重复激活,请填写新的卡号并激活";
                                        o = 1;
                                        break;
                                    case 401:
                                        tips.innerHTML = "手机号或验证码错误";
                                        break;
                                    case 410:
                                        tips.innerHTML = "验证码超时";
                                        break;
                                    case 200:
                                        $.ajax({
                                            type: "get",
                                            url: "/api/users/cards/" + data.cardNo,
                                            dataType: "json",
                                            success: function (e) {
                                               // alert("激活成功")
                                                e.subject =state.getSubjectNameById(e.subject)
                                                        // getSubjectNameById(e.subject)
                                                user.cards.push(e);
                                                //alert(user.cards)
                                                state.cards.isCards = false
                                                document.getElementById("gold").style.display="block";
                                                state.gold.yao();
                                                //history.back();
                                            },
                                            error: function (e) {
                                                alert(JSON.stringify(e));
                                            }
                                        })
                                        break;
                                }
                            }
                        })*/
                    }
                }

                var enableActive = function (e) {
                    clearInterval(timeoutId);
                    var activeCodeButton = document.getElementById('activeCode');
                    activeCodeButton.disabled = false
                    activeCodeButton.value = '发送验证码'
                }
               /* var timeoutId;
                //var asfdf = "phoneNumber";
                var activeCode = function () {
                    //alert('active code')
                    alert("来了")
                    var phoneNumber = document.getElementById("phoneNumber").value
                    if (phoneNumber != "") {
                        ajax('GET', '/api/users/telephones/' + phoneNumber + '/code', [
                            {name: 'Accept', value: 'application/json'}
                        ], null, function (r) {
                            var tips = document.getElementById("tips")
                            if (r.meta.code < 400) {
                                tips.innerHTML = '发送成功，请注意查收'
                            } else {
                                tips.innerHTML = '发送失败，请重新获取验证码'
                            }
                        })

                        var timeoutCount = 180;
                        var proc = function () {
                            e.target.value = ' (' + timeoutCount + ')  秒后\n重新发送';
                            --timeoutCount;
                            e.target.disabled = true
                            if (timeoutCount <= 0) {
                                e.target.value = ' 重新发送 ';
                                clearInterval(timeoutId);
                                e.target.disabled = false
                            }
                        }
                        timeoutId = setInterval(proc, 1000);
                    } else {
                        alert('手机号不能为空')
                    }
                }*/

                var activeCodeButton = document.getElementById('activeCode');
                activeCodeButton.addEventListener('click', function () {
                   // count = 1;
                    state.firstActiveCard.activeCode(1)
                    //state.firstActiveCard.activeCode
                }, false);

                var saveButton = document.getElementById('save');
                saveButton.addEventListener('click', save, false);

                var validCode = document.getElementById('validCode')

                validCode.addEventListener('change', enableActive, false)

                var phoneNumber = document.getElementById('phoneNumber')
                phoneNumber.addEventListener('change', enableActive, false)

                var cardNo = document.getElementById('cardNo')
                cardNo.addEventListener('change', function (e) {
                    o = 0
                }, false)
            },

            activeCode:function (e) {
                var timeoutId;
                var an;
                var error;
                //var asfdf = "phoneNumber";
                if(e == 1){
                    var phoneNumber = document.getElementById("phoneNumber").value
                    an="activeCode";
                    error="tips";
                }else{
                    var phoneNumber = document.getElementById("duanNumber").value
                    an = "fapassword";
                    error="errorfamima";
                }
                        //e = document.getElementById("activeCode")
                    if (phoneNumber != "") {
                        $.ajax({
                            type:"get",
                            url:"/api/users/telephones/"+ phoneNumber + "/code",
                            dataType:"json",
                            error:function (r) {
                                var tips = document.getElementById(error);
                                //alert(JSON.stringify(r))
                                if (r.status < 400) {
                                    tips.innerHTML = '短信已发送至手机，3分钟内有效'
                                } else {
                                    tips.innerHTML = '发送失败，请重新获取验证码'
                                }
                                var timeoutCount = 180;
                                var proc = function () {
                                    document.getElementById(an).value = ' (' + timeoutCount + ')  秒后\n重新发送';
                                    --timeoutCount;
                                    document.getElementById(an).disabled = true
                                    if (timeoutCount <= 0) {
                                        document.getElementById(an).value = ' 重新发送 ';
                                        clearInterval(timeoutId);
                                        document.getElementById(an).disabled = false
                                    }
                                }
                                timeoutId = setInterval(proc, 1000);
                            }
                        })
                        /*ajax('GET', '/api/users/telephones/' + phoneNumber + '/code', [
                            {name: 'Accept', value: 'application/json'}
                        ], null, function (r) {
                            var tips = document.getElementById("tips")
                            if (r.meta.code < 400) {
                                tips.innerHTML = '发送成功，请注意查收'
                            } else {
                                tips.innerHTML = '发送失败，请重新获取验证码'
                            }
                        })*/


                    } else {
                        alert('手机号不能为空')
                    }
            }

        },
        login: {
            init: function () {
            }
        },
        phoneLogin: {
            init: function () {
            }
        },
        settings: {
            init: function () {
                var i;
                var j;
                var x;
                var p1 = document.getElementById("newpwd1");
                p1.addEventListener('blur', function () {
                    validatePWD1(newpwd1,error);
                })
                var p2 = document.getElementById("newpwd2");
                p2.addEventListener('blur', function () {
                    validatePWD2();
                })
                var p3 = document.getElementById("oldpwd");
                p3.addEventListener('blur', function () {
                    validatePWD3(oldpwd,error);
                })

                function validatePWD1(id,error) {
                    var pwd1 = $("#"+id+"").val();
                    if (pwd1.length >= 6 && pwd1.length <= 16) {
                        document.getElementById(""+error+"").innerHTML = ""
                        j = 1;
                    } else {
                        document.getElementById(""+error+"").innerHTML = "请输入6-16位密码"
                        j = 0;
                    }
                }

                function validatePWD3(id,error) {
                    var pwd3 = $("#"+id+"").val();
                    if (pwd3.length >= 6 && pwd3.length <= 16) {
                        document.getElementById(""+error+"").innerHTML = ""
                        x = 1;
                    } else {
                        document.getElementById(""+error+"").innerHTML = "请输入6-16位密码"
                        x = 0;
                    }
                }

                function validatePWD2() {
                    var pwd1 = $("#newpwd1").val();
                    var pwd2 = $("#newpwd2").val();
                    if (pwd1 != pwd2) {
                        document.getElementById("error").innerHTML = "密码输入不一致，请重新输入"
                        i = 0;
                    } else {
                        document.getElementById("error").innerHTML = ""
                        i = 1;
                    }
                }

                var pwdSave = document.getElementById("pwd_save");
                var quxiao = document.getElementById("quxiao");
                quxiao.addEventListener('click',function () {
                    history.back();
                })
                pwdSave.addEventListener('click', function () {
                    if (i == 1 && j == 1 && x == 1) {
                        var filter = {
                            password: $("#oldpwd").val()
                        }
                        $.ajax({
                            type: 'get',
                            url: "/api/users?filter=" + JSON.stringify(filter),
                            dataType: "json",
                            success: function (e) {
                                //alert("原密码正确")
                                var data = {
                                    password: $("#newpwd2").val()
                                }
                                $.ajax({
                                    type: "put",
                                    url: "/api/users/" + sessionId,
                                    data: JSON.stringify(data),
                                    dataType: "json",
                                    contentType: "application/json; charset=utf-8",
                                    success: function (a) {
                                        alert("修改密码成功")
                                        history.back();
                                    },
                                    error: function (a) {
                                        alert(JSON.stringify(a))
                                    }
                                })
                            },
                            error: function (e) {
                                document.getElementById("error").innerHTML = "原密码错误，请重新输入"
                            }
                        })
                    }
                }, false);
               /* function back() {
                    history.back();
                }*/
            }
        },
        help: {
            init: function () {
            }
        },
        nickname:{
           init:function () {
               $("#nicehng").on('click',function () {
                    $("#nicknameval").val("")
               })
           }
        }
    }

    state.init()

  /*  function Coin(opts){
        //默认参数
        this.defaults={
            coinSrc:"images/corn1.png",     //金币图片地址
            audioSrc:"images/shake.mp3",	//金币音频地址
            coinWidth:30,           //金币宽度
            coinHeight:30,          //金币高度、密度
            density:40
        };
        this.settings=this._extendDeep(this.defaults,opts);   //深拷贝
        this.density=this.settings.density;                   //密度，即金币个数
        this.timeLag=800;                                    //金币散落的事件间隔，数字越大表示间隔越大
        this.coinWidth=this.settings.coinWidth;               //金币宽度
        this.coinHeight=this.settings.coinHeight;             //金币高度
        this.wrapWidth=0;
        this.wrapHeight=0;
        this._init();
    }
    Coin.prototype={
        constructor:Coin,
        /!**
         * 动画初始化方法
         * @method _init
         **!/
        _init:function(){
            //初始化包括尺寸大小
            this.wrapWidth=document.documentElement.clientWidth;
            this.wrapHeight=document.documentElement.clientHeight;
            this._requestAnimationFrame();
            this._createCanvas();
            this._createAudio();
        },
        /!**
         * 对象深拷贝方法
         * @method _extendDeep
         * @param  {object} parent 父对象
         {object} child  子对象
         @return {object} child  父对象继承给子对象
         **!/
        _extendDeep:function(child,parent){
            var i,
                    toStr = Object.prototype.toString,
                    astr = "[object Array]";
            child = child || {};
            for (i in parent) {
                if (parent.hasOwnProperty(i)) {
                    if (typeof parent[i] === "object") {
                        child[i] = (toStr.call(parent[i]) === astr) ? [] : {};
                        extendDeep(parent[i], child[i]);
                    } else {
                        child[i] = parent[i];
                    }
                }
            }
            return child;
        },
        /!**
         * requestAnimationFrame做兼容
         * @method _requestAnimationFrame
         **!/
        _requestAnimationFrame:function(){
            var lastTime = 0;
            var vendors = ['webkit', 'moz'];
            for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
                window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
                window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame'] ||    // name has changed in Webkit
                        window[vendors[x] + 'CancelRequestAnimationFrame'];
            }
            if (!window.requestAnimationFrame) {
                window.requestAnimationFrame = function(callback, element) {
                    var currTime = new Date().getTime();
                    var timeToCall = Math.max(0, 16.7 - (currTime - lastTime));
                    var id = window.setTimeout(function() {
                        callback(currTime + timeToCall);
                    }, timeToCall);
                    lastTime = currTime + timeToCall;
                    return id;
                };
            }
            if (!window.cancelAnimationFrame) {
                window.cancelAnimationFrame = function(id) {
                    clearTimeout(id);
                };
            }
        },
        /!**
         * 创建canvas画布
         * @method _createCanvas
         **!/
        _createCanvas:function(){
            var _self=this;
            this.canvas=document.createElement('canvas');
            this.canvas.setAttribute("data-id",Date.now());
            if(!this.canvas.getContext){
                alert("您的浏览器不支持canvas");
                return;
            }
            this.context=this.canvas.getContext('2d');
            this.canvas.width=this.wrapWidth;
            this.canvas.height=this.wrapHeight;
            var oBody=document.getElementsByTagName('body')[0];
            oBody.appendChild(this.canvas);
            this._createCacheCanvas();
        },
        _createCacheCanvas:function(){
            var _self=this;
            this.cacheCanvas=document.createElement('canvas');
            this.cacheContext=this.cacheCanvas.getContext('2d');
            this.cacheCanvas.width=this.wrapWidth;
            this.cacheCanvas.height=this.wrapHeight;
            this.coinImg=new Image();
            this.coinImg.src=this.settings.coinSrc;
            this.coinImg.onload=function(){
                _self._startCacheCanvasAnim();
            }
        },
        /!**
         * 执行金币绘制动画
         * @method _startCanvasAnim
         **!/
        _startCacheCanvasAnim:function(){
            var _self=this;
            var availWidth=this.cacheCanvas.width-this.coinWidth;
            var availHeight=this.cacheCanvas.height-this.coinHeight;
            //var disX=availWidth/this.density;  //每个硬币X轴的间距
            var coinRange=availWidth*this.density/(this.density+10);
            var rangeStart=(availWidth-coinRange)/2;
            var g=9.8*280;   //重力加速度
            var bPlayAudio=false;
            var coinAttrArr=[];  //存储金币下落过程中的一些属性参数
            for(var i=0;i<_self.density;i++){
                coinAttrArr[i]={
                    rndX:Math.random(),                                    //存储金币开始降落x轴随机值
                    rndOrder:Math.round(Math.random()*_self.timeLag/17),   //存储金币撒落顺序的一个数组
                    time:0,									               //存储金币绘制的具体时间
                    top:0,                                                 //存储金币绘制距离顶部的距离
                    left:0,                                                //存储金币弹起后距离左边的距离
                    endSpeed:0,                                            //存储金币第一次接触地面的速度
                    bEnd:false,								               //存储金币是否触碰到地面
                    reDownSpeed:0,                                         //存储金币弹起后重新降落的速度
                    reDownHDelta:Math.random()*100+250,                    //存储金币弹起的高度参数，随机值250~350之间
                    rndOffsetX:Math.random()*0.06+0.97                     //存储金币x轴的偏移量，随机值0.97~1.03之间
                }
            }
            var startTime =  Date.now();  //开始绘制前的时间
            function draw(){
                var drawStart = Date.now();  //记录重绘的结束事件
                var diff = (drawStart - startTime)/1000;  //计算每次重绘所需要的事件，单位为秒
                startTime = drawStart;   //结束事件传给开始事件
                _self.context.clearRect(0,0,_self.canvas.width,_self.canvas.height);  //清除画布，方便重绘
                _self.cacheContext.clearRect(0,0,_self.cacheCanvas.width,_self.cacheCanvas.height);  //清除画布，方便重绘
                _self.cacheContext.save();
                //根据金币个数循环绘制金币
                for(var i=0;i<_self.density;i++){
                    if((coinAttrArr[i].rndOrder==0&&coinAttrArr[i].time==0)){   //如果顺序为0，表示开始下落，同时下落的初始时间为0时，赋值初始时间
                        coinAttrArr[i].time=diff;
                    }
                    if(coinAttrArr[i].time>0){     //如果初始事件大于0，表示已经在下落过程中,则每次的初始时间递增
                        coinAttrArr[i].time=coinAttrArr[i].time+diff;
                    }
                    if(coinAttrArr[i].rndOrder==0){  //如果顺序为0，开始下落，则开始绘制金币
                        if(!coinAttrArr[i].bEnd){   //金币下落（过程一），自由落体运动
                            coinAttrArr[i].top=g*Math.pow(coinAttrArr[i].time,2)/2-_self.coinHeight;   //自由落体加速度运动，求下落的高度
                            //coinAttrArr[i].left=disX*coinAttrArr[i].rndX+i*disX;
                            coinAttrArr[i].left=coinRange*coinAttrArr[i].rndX+rangeStart;
                        }else if(coinAttrArr[i].endSpeed==0){   //金币弹起后在空中重新下落（过程三）
                            coinAttrArr[i].reDownSpeed=coinAttrArr[i].reDownSpeed*1.1;
                            coinAttrArr[i].top=coinAttrArr[i].top+coinAttrArr[i].reDownSpeed;
                            coinAttrArr[i].left=coinAttrArr[i].left*coinAttrArr[i].rndOffsetX;
                        }else{   //金币弹起（过程二）
                            coinAttrArr[i].endSpeed=-Math.abs(coinAttrArr[i].endSpeed*0.96);
                            if(Math.abs(coinAttrArr[i].endSpeed)<1) coinAttrArr[i].endSpeed=0;
                            coinAttrArr[i].top=coinAttrArr[i].top+coinAttrArr[i].endSpeed;
                            coinAttrArr[i].left=coinAttrArr[i].left*coinAttrArr[i].rndOffsetX;
                        }
                        //金币第一次降落超过地面时，将其高度设置和地面齐平
                        if(coinAttrArr[i].top>_self.cacheCanvas.height-_self.coinHeight&&!coinAttrArr[i].bEnd){
                            coinAttrArr[i].top=_self.cacheCanvas.height-_self.coinHeight;
                        }
                        //金币落地时，计算落地的速度
                        if(coinAttrArr[i].top==_self.cacheCanvas.height-_self.coinHeight){
                            coinAttrArr[i].endSpeed=g*coinAttrArr[i].time/coinAttrArr[i].reDownHDelta;
                            coinAttrArr[i].reDownSpeed=coinAttrArr[i].endSpeed/10;
                            coinAttrArr[i].bEnd=true;
                        }
                        //绘制金币
                        _self.cacheContext.drawImage(_self.coinImg,coinAttrArr[i].left,coinAttrArr[i].top,_self.coinWidth,_self.coinHeight);
                    }
                    coinAttrArr[i].rndOrder=coinAttrArr[i].rndOrder==0?0:coinAttrArr[i].rndOrder-1;//顺序每一次重绘则递减一次，直到为0时，代表开始下落
                }
                _self.cacheContext.restore();
                _self.context.drawImage(_self.cacheCanvas,0,0,_self.canvas.width,_self.canvas.height);
                var firstH=_self._maxNum(coinAttrArr,"top");//求降落过程中高度最大的金币高度
                if(firstH>=_self.cacheCanvas.height-_self.coinHeight&&!bPlayAudio){
                    _self._playAudio();
                    bPlayAudio=true;
                }
                var lastH=_self._minNum(coinAttrArr,"top");//求降落过程中高度最小的金币高度
                if(lastH<=_self.cacheCanvas.height+_self.coinHeight){ //最后一个金币高度超出canvas的高度停止重绘
                    window.requestAnimationFrame(draw);  //重绘，递回调用绘制方法
                }else{
                    console.log("金币都撒完了");
                    _self._destory();
                }
            }
            window.requestAnimationFrame(draw);  //第一次绘制
        },
        /!**
         * 求最小值
         * @method _minNum
         * @param   {arr}    arr  属性数组
         {string} attr 数组下的属性名称
         * @return  {number}      返回数组下属性值最小的值
         **!/
        _minNum:function(arr,attr){
            var tempArr=[];
            for(var i=0;i<arr.length;i++){
                tempArr.push(arr[i][attr]);
            }
            return tempArr.sort(function(a,b){return a-b})[0];
        },
        /!**
         * 求最大值
         * @method _minNum
         * @param   {arr}    arr  属性数组
         {string} attr 数组下的属性名称
         * @return  {number}      返回数组下属性值最大的值
         **!/
        _maxNum:function(arr,attr){
            var tempArr=[];
            for(var i=0;i<arr.length;i++){
                tempArr.push(arr[i][attr]);
            }
            return tempArr.sort(function(a,b){return b-a})[0];
        },
        /!**
         * 创建音频对象
         * @method _createAudio
         **!/
        _createAudio:function(){
            this.audio=document.createElement('audio');
            this.audio.setAttribute("preload","load");
            var oSource=document.createElement('source');
            oSource.setAttribute("src",this.settings.audioSrc);
            oSource.setAttribute("type","audio/mp3");
            this.audio.appendChild(oSource);
            var oBody=document.getElementsByTagName('body')[0];
            oBody.appendChild(this.audio);
        },
        /!**
         * 播放音频
         * @method _playAudio
         **!/
        _playAudio:function(){
            this.audio.play();
        },
        /!**
         * 销毁canvas和audio
         * @method _destory
         **!/
        _destory:function(){
            var oBody=document.getElementsByTagName('body')[0];
            oBody.removeChild(this.canvas);
            oBody.removeChild(this.audio);
        }
    }
    function kai(){
       // var oBtn=document.getElementById('goldbtn1');
        init();
        var coin=new Coin();
        // oBtn.onclick=function(){
        // }
        var SHAKE_THRESHOLD = 400;
        var last_update = 0;
        var index=0;
        var x = y = z = last_x = last_y = last_z = 0;
        var w_curTime=0;
        function init() {
            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', deviceMotionHandler, false);
            } else {
                alert('not support mobile event');
            }
        }
        function deviceMotionHandler(eventData) {
            var acceleration = eventData.accelerationIncludingGravity;
            var curTime = new Date().getTime();
            if ((curTime - last_update) > 100) {
                var diffTime = curTime - last_update;
                last_update = curTime;
                x = acceleration.x;
                y = acceleration.y;
                z = acceleration.z;
                var speed = Math.abs(x + y + z - last_x - last_y - last_z) / diffTime * 10000;
                var delta=Math.abs(x + y + z - last_x - last_y - last_z);
                if (speed > SHAKE_THRESHOLD) {
                    if((curTime-w_curTime)>2000){
                        w_curTime!=0 && new Coin({density:Math.round(delta)});
                        w_curTime=curTime;
                    }
                }
                last_x = x;
                last_y = y;
                last_z = z;
            }
        }
    }
*/
</script>
</body>
</html>