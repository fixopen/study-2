<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>audioRecord</title>
    <style>
        .wrap {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .wrap img {
            width: 100%;
            height: 100%;
        }

        .amplifier {
            position: absolute;
            bottom: 2.5%;
            left: 2.5%;
            width: 12%;
            height: 7.3%;
            background: url('amplifier.png') no-repeat center;
            -webkit-background-size: contain;
            background-size: contain;
        }
    </style>
</head>
<body>
<article id="content"></article>
<template id="audio-template">
    <div class="wrap">
        <audio id="player" src="p-zhibo-0520/${bookNo}.mp3#t=${startSecond},${endSecond}" autoplay></audio>
        <img src="p-zhibo-0520/${bookNo}/${pageNo}.jpg" alt="">
        <div id="play" class="amplifier"></div>
    </div>
</template>
<template id="video-template">
    <div>
        <video src="p-zhibo-0520/${bookNo}.mp4" controls autoplay style="width: 100%; height: 100%;"></video>
    </div>
</template>
<script src="/jquery/jquery-3.1.1.min.js"></script>
<script src="/util.js"></script>
<script src="/basic.js"></script>
<script>
    var bookNo = g.getUrlParameter('book')
    $.ajax({
        type: 'get',
        url: '/api/audio-records/05/20/' + bookNo + '/name',
        success: function(n) {
            document.title = n.name
            var pageNo = g.getUrlParameter('page')
            var unitNo = g.getUrlParameter('unit')
            if (pageNo == null && unitNo == null) {
                proc({
                    templateId: 'video-template',
                    data: {bookNo: bookNo},
                    containerId: 'content'
                })
            } else {
                $.ajax({
                    type: 'get',
                    url: '/api/audio-records/05/20/' + bookNo + '/' + pageNo + '/' + unitNo,
                    success: function (record) {
                        record.duration = record.endTime - record.startTime
                        record.startSecond = record.startTime / 1000
                        record.endSecond = record.endTime / 1000
                        proc({
                            templateId: 'audio-template',
                            data: record,
                            containerId: 'content'
                        })

//                        var tid = null

                        var start = null

                        var checkPause = function (timestamp) {
                            if (!start) {
                                start = timestamp
                            }
                            var progress = timestamp - start;
                            if (progress >= record.duration) {
                                player.pause()
                            } else {
                                requestAnimationFrame(checkPause)
                            }
//                            var isPause = false
//                            var ct = player.currentTime
//                            if (ct >= record.endSecond - 0.5) {
//                                isPause = true
//                                player.pause()
//                            }
//                            if (!isPause) {
//                                requestAnimationFrame(checkPause)
//                            }
                        }

                        var player = document.getElementById('player')
                        var play = document.getElementById('play')

                        play.addEventListener('click', function (e) {
                            player.currentTime = record.startSecond
                            player.play()
//                            clearTimeout(tid)
//                            tid = setTimeout(function() {
//                                var ct = player.currentTime
//                                if (ct >= record.endSecond) {
//                                    player.pause()
//                                }
//                            }, record.endTime - record.startSecond)
                            requestAnimationFrame(checkPause)
                        }, false)

//                        player.addEventListener('timeupdate', function (e) {
//                            checkPause()
//                        }, false)
                    }
                })
            }
        }
    })
</script>
</body>
</html>