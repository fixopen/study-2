<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <meta name="screen-orientation" content="landscape"/>
    <!-- 引入样式表 -->
    <link rel="stylesheet" href="../../css/global.css">
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="introduce.css">
    <style>
        ul, li {
            list-style: none;
        }

        .wrap {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
        }

        .abs {
            position: absolute;
            -webkit-background-size: contain;
            background-size: contain;
        }

        .dialog {
            position: absolute;
            top: 50%;
            left: 50%;
            -webkit-transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -50%);
            -o-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
            width: 660px;
            height: 720px;
            margin: auto;
            background-color: white;
            border-radius: 20px;
            z-index: 99;
            display: none;
        }

        .videoBook-Image {
            width: 369px;
            height: 81px;
            position: absolute;
            z-index: 50;
            top: 30px;
            right: 30px;
        }

        .message {
            width: 100%;
            margin: 0 auto;
            line-height: 60px;
            font-size: 40px;
            font-family: "苹方", "Microsoft YaHei";
            overflow: auto;
        }

        .ul01_flet {
            color: #aaa;
            float: left;
        }

        .ul01_flet li {
            float: left;
        }

        .ul01_fli {
            margin-right: 30px;
        }

        .ul01_count {
            margin-left: 10px;
        }

        .ul01_imgzan {
            width: 38px;
            height: 38px;
        }

        .ul01_riht {
            float: right;
        }

        .ul01_riht li {
            float: left;
        }

        .mulu_botBtn {
            color: #24cbd1;
            font-size: 40px;
            font-family: "苹方", "Microsoft YaHei";
            float: right;
            padding-right: 40px;
            text-decoration: none;
            background: url('../../img/write.png') right center no-repeat;
            background-size: 30px 30px;
        }

        /*写留言*/
        .textarea {
            width: 100%;
            /*padding: 0.9375rem;*/
            margin-top: 0.9375rem;
            border-radius: 0.3125rem;
            font-size: 2rem;
            min-height: 10rem;
        }

        .sub-btn {
            width: 100%;
            height: 5rem;
            line-height: 5rem;
            background-color: #0BB20C;
            color: #ffffff;
            text-align: center;
            margin-top: 0.9375rem;
            border-radius: 0.3125rem;
            font-size: 2rem;
        }

        .muluBn_center {
            margin: 1.5625rem 0 0.9375rem;
            overflow: hidden;
        }

        .liuyan_li {
            float: left;
            margin-left: 0.625rem;
        }

        .lion_01 {
            width: 16%;
        }

        .lion_01 img {
            width: 100%;
            text-align: center;
        }

        .lion_02 {
            width: 77%;
        }

        .topUl {
            overflow: hidden;
        }

        .topUl_top {
            width: 100%;
            overflow: hidden;
        }

        .litop_fleft {
            color: #aaa;
            float: left;
        }

        .litop_friht {
            color: #aaa;
            float: right;
        }

        .tcmar_top {
            margin-top: 0.3125rem;
        }
    </style>
</head>
<body>
<article id="introduce"></article>
<article id="content" style="display: none;"></article>
<template id="introduce-template">
    <div class="wrap">
        <div class="daodu-div">
            <div class="daodu-top">
                <img class="daodu-top-flower" src="img/read-flower.png" alt="">
                <p class="daodu-top-txt">英语自然拼读法通过直接学习26个字母及字母组合在单词中的发音规则，建立字母及字母组合与发音的感知，让学生在轻松愉快的氛围中，了解和学习英语字母组合的奥妙，掌握英语拼读规律。</p>
                <img class="daodu-top-car" src="img/read-car.png" alt="">
            </div>
            <div class="daodu-center">
                <img class="daodu-center-book" src="img/read-book.png" alt="">
                <div class="daodu-center-left">
                    <img class="${bookImg}" src="img/english01.png" alt="">
                </div>
                <div class="daodu-center-right">
                    <h3 class="daodu-center-rightH3">${bookNo}</h3>
                    <p class="daodu-center-rightP">${description}</p>
                </div>
            </div>
            <div class="daodu-center-bottom">
                <a class="daodu-center-bottomBtn" href="javascript:void(0)" data-article="content">开始学习</a>
            </div>
        </div>
    </div>
</template>
<template id="audio-template">
    <div class="wrap" data-ext-point="units">
        <audio id="player" src="p-zhibo-0520/${bookNo}/${pageNo}${unitNo}.mp3" autoplay></audio>
        <img src="p-zhibo-0520/${bookNo}/${pageNo}.jpg" alt="" style="width: 100%; height: 100%;">
        <a id="videoBook" href="p-zhibo-0520.html?book=${bookNo}">
            <img src="videoBook.png" alt="" class="videoBook-Image">
        </a>
        <div data-ext-point="operation-panel"></div>
        <div>
            <a id="previous" class="abs" style="bottom: 90px;  right: 240px;"
               href="p-zhibo-0520.html?book=${bookNo}&page=${previousPageNo}&unit=${previousUnitNo}">
                <img src="previousOff.png" alt="" style="width: 159px; height: 57px;">
            </a>
            <a id="next" class="abs" style="bottom: 90px; right: 30px;"
               href="p-zhibo-0520.html?book=${bookNo}&page=${nextPageNo}&unit=${nextUnitNo}">
                <img src="nextOff.png" alt="" style="width: 159px; height: 57px;">
            </a>
        </div>
        <div class="message">
            <ul class="ul01_flet">
                <li class="ul01_fli">阅读<span class="ul01_count">${readCount}</span></li>
                <li><img class="ul01_imgzan" src="../../img/zan.png" alt=""><span class="ul01_count">${likeCount}</span>
                </li>
            </ul>
            <ul class="ul01_riht">
                <li class="ul01_fli"><a class="mulu_botBtn" href="#" id="createComment">写留言</a></li>
            </ul>
            <div id="commentWriter" style="display: none;margin: 1.875rem">
                <textarea name="message" id="textarea" class="textarea"></textarea>
                <button type="submit" class="sub-btn" id="btn">提交</button>
            </div>
            <span id="comments" data-ext-point="comments"></span>
        </div>
        <div id="mask"
             style="display: none; position: absolute; z-index: 50; top: 0; left: 0; width: 100%; height: 100%; background-color: black; opacity: 0.6;"></div>
        <div id="dialog" class="dialog">
            <img src="dialogIcon.png" alt="" style="position: relative; top: -105px; left:-6px; width: 370px;">
            <img id="tanClose" src="mask.png" alt="" style="position: absolute; top: -120px; right:0; width: 74px;">
            <!--<div style="word-wrap: break-word;">-->
            <pre id="chinese"
                 style="color: #131212; font-size: 2.5em; font-family: '微软雅黑'; margin: 0; padding:0 40px; height:300px;overflow-y: auto;
                     white-space: pre-wrap;word-wrap: break-word;"></pre>
            <!--</div>-->
            <div class="bottomBtn" style="width:100%;text-align: center;position: absolute; bottom: 40px;">
                <button id="closeTranslator" style="margin: auto; display: block; border:none; background: none;"><img
                        src="okOff.png" alt="" style="width:360px; height: 103.2px;"></button>
            </div>
        </div>
    </div>
</template>
<template id="comment-template">
    <ul class="muluBn_center">
        <li class="liuyan_li lion_01">
            <img src="${userAvatar}" alt="">
        </li>
        <li class="liuyan_li lion_02">
            <ul class="topUl">
                <li class="topUl_top">
                    <div class="litop_fleft">${userName}</div>
                    <!--<div class="litop_friht" data-id="${id}">-->
                    <!--<img class="ul01_imgzan_" src="img/zan.png" alt="">-->
                    <!--<span class="ul01_count">${likeCount}</span>-->
                    <!--</div>-->
                </li>
                <li class="topUl_center tcmar_top">
                    ${content}
                </li>
                <li class="topUl_bottom tcmar_top">
                    <div class="litop_fleft">${createTime}</div>
                </li>
            </ul>
        </li>
    </ul>
</template>
<template id="operation-panel-template">
    <section>
        <div class="abs" style="top: ${top}%; left: ${left}%; width: ${width}%; height: ${height}%;">
            <div id="play${unitNo}" data-unit="${unitNo}" class="abs"
                 style="bottom: 0; left: 0px; width: 117px; height: 117px; background: url('amplifierOff.png') no-repeat center; background-size: contain;"></div>
            <div id="translator${unitNo}" data-unit="${unitNo}" class="abs"
                 style="bottom: 0; margin-left: 180px; width: 117px; height: 117px; background: url('translatorOff.png') no-repeat center; background-size: contain;"></div>
        </div>
    </section>
</template>
<template id="video-template">
    <div>
        <video src="p-zhibo-0520/${bookNo}.mp4" controls autoplay style="width: 100%; height: 100%;"></video>
    </div>
</template>
<script src="/jquery/jquery-3.1.1.min.js"></script>
<script src="/util.js"></script>
<script src="/basic.js"></script>
<script>

    var state = {
        currentArticle: document.getElementById('introduce'),
        init: function () {
//            var userId = g.getUrlParameter('userid')
//            g.setCookie('userId', userId)
            var bookNo = g.getUrlParameter('book');
            var pageNo = g.getUrlParameter('page');
            var unitNo = g.getUrlParameter('unit');



            var switchTo = function (id) {
                state.currentArticle.style.display = 'none'
                state.currentArticle = document.getElementById(id)
                state.currentArticle.style.display = 'block'
                history.pushState(null, null, '/p-zhibo-0520.html#' + id)
                state[id].init()
            }

            $(document).on('click', '[data-article]', function (e) {
                var id = e.target.dataset.article;
                switchTo(id);
                state[id].changeId(e.target.dataset.id)
            })


            window.addEventListener('hashchange', function (e) {
                var hashPos = e.newURL.indexOf('#')
                var hash = e.newURL.substring(hashPos + 1)
                switchTo(hash)
            }, false)
        },
        introduce:{
            init: function () {
            },
            changeId: function () {

                state.introduce.show();

            },
            value: null,
            show: function () {
                $('#introduce').html("");


                proc({
                    containerId: 'introduce',
                    data: {},
                    templateId: 'introduce-template'
                })



            },
        },
        content:{
            parentId: 0,
            init: function () {

            },
            changeId: function () {

                state.content.show();

            },
            value: null,
            show: function () {

                $('#content').html("");


                proc({
                    containerId: 'content',
                    data: {},
                    templateId: 'video-template'
                })


            }
        },
    }
    }

    state.init()

    var bookNo = g.getUrlParameter('book');
    var pageNo = g.getUrlParameter('page');
    var unitNo = g.getUrlParameter('unit');
    if (pageNo == null && unitNo == null) {
        $.ajax({
            type: 'get',
            url: '/api/audio-records/05/20/' + bookNo + '/name',
            success: function (n) {
                document.title = n.name
                proc({
                    templateId: 'video-template',
                    data: {bookNo: bookNo},
                    containerId: 'content'
                })
            }
        })
    } else {
        $.ajax({
            type: 'get',
            url: '/api/audio-records/05/20/' + bookNo + '/' + pageNo,
            success: function (n) {
                document.title = n.name;
                var getNavigatorInfo = function (pageNo) {
                    var result = {};
                    switch (pageNo) {
                        case '00':
                            result.nextPageNo = '10';
                            break;
                        case '10':
                            result.previousPageNo = '00';
                            result.nextPageNo = '20';
                            break;
                        case '20':
                            result.previousPageNo = '10';
                            result.nextPageNo = '30';
                            break;
                        case '30':
                            result.previousPageNo = '20';
                            result.nextPageNo = '40';
                            break;
                        case '40':
                            result.previousPageNo = '30';
                            result.nextPageNo = '50';
                            break;
                        case '50':
                            result.previousPageNo = '40';
                            result.nextPageNo = '60';
                            break;
                        case '60':
                            result.previousPageNo = '50';
                            result.nextPageNo = '70';
                            break;
                        case '70':
                            result.previousPageNo = '60';
                            result.nextPageNo = '80';
                            break;
                        case '80':
                            result.previousPageNo = '70';
                            result.nextPageNo = '90';
                            break;
                        case '90':
                            result.previousPageNo = '80';
                            result.nextPageNo = '100';
                            break;
                        case '100':
                            result.previousPageNo = '90';
                            result.nextPageNo = '110';
                            break;
                        case '110':
                            result.previousPageNo = '100';
                            result.nextPageNo = '120';
                            break;
                        case '120':
                            result.previousPageNo = '110';
                            result.nextPageNo = '130';
                            break;
                        case '130':
                            result.previousPageNo = '120';
                            result.nextPageNo = '140';
                            break;
                        case '140':
                            result.previousPageNo = '130';
                            result.nextPageNo = '150';
                            break;
                        case '150':
                            result.previousPageNo = '140';
                            break
                    }
                    return result
                }

                for (var i = 0; i < n.records.length; ++i) {
                    var r = n.records[i];
                    r.width = (r.right - r.left) / 100;
                    r.left = r.left / 100;
                    r.right = r.right / 100;

                    r.height = (r.bottom - r.top) / 100;
                    r.top = r.top / 100;
                    r.bottom = r.bottom / 100;
                }

                var navigatorInfo = getNavigatorInfo(pageNo);

                proc({
                    templateId: 'audio-template',
                    data: {
                        bookNo: bookNo,
                        pageNo: pageNo,
                        unitNo: unitNo,
                        records: n.records,
                        previousPageNo: navigatorInfo.previousPageNo,
                        previousUnitNo: '10',
                        nextPageNo: navigatorInfo.nextPageNo,
                        nextUnitNo: '10',
                    },
                    containerId: 'content',
                    secondBind: {
                        extPoint: 'operation-panel',
                        dataFieldName: 'records',
                        templateId: 'operation-panel-template'
                    },
//                    secondBind: {
//                        extPoint: 'comments',
//                        dataFieldName: 'comments',
//                        templateId: 'comment-template'
//                    }
                })

                var previous = document.getElementById('previous');
                var next = document.getElementById('next');

                if (navigatorInfo.previousPageNo == null) {
                    previous.style.display = 'none'
                }

                if (navigatorInfo.nextPageNo == null) {
                    next.style.display = 'none'
                }

                var player = document.getElementById('player');
                var dialog = document.getElementById('dialog');
                var mask = document.getElementById('mask');
                var chinese = document.getElementById('chinese');
                var ok = document.getElementById('closeTranslator');
                var tanClose = document.getElementById('tanClose');

                ok.addEventListener('click', function (e) {
                    dialog.style.display = 'none';
                    mask.style.display = 'none'
                }, false)
                tanClose.addEventListener('click', function (e) {
                    dialog.style.display = 'none';
                    mask.style.display = 'none'
                }, false)

                // message---------
                var createComment = document.getElementById('createComment');
                createComment.addEventListener('click', function () {
                    $('#commentWriter').toggle();
                    var btn = document.getElementById('btn');
                    btn.addEventListener('click', submit, false);
                    function submit(e) {
                        var textarea = document.getElementById('textarea');
                        var value = textarea.value;
                        if (value.length < 1) {
                            return false;
                        }
                        textarea.value = '';
                        e.target.style.color = '#f5f5f5';
                        $.ajax({
                            type: "post",
                            url: "/api/audio-records/05/20/' + bookNo ",
                            data: JSON.stringify({
                                //   userId: 1,
                                objectType: 'knowledge-point',
                                objectId: g.getUrlParameter("id"),
                                content: value
                            }),
                            dataType: "json",
                            contentType: "application/json; charset=utf-8",
                            success: function (data) {
                                location.reload();
                                //alert(JSON.stringify(data))
                            }
                        })
                    }
                }, false);

                // likes---点赞
                var id = g.getUrlParameter("id")
                $.ajax({
                    type: "get",
                    url: '/api/audio-records/05/20/' + id + '/is-self-like',
                    dataType: "json",
                    success: function (like) {
                        var liked = like.like
                        var icon = document.getElementById('icon');
                        if (liked) {
                            icon.setAttribute('src', 'img/zan-over.png');
                        } else {
                            icon.setAttribute('src', 'img/zan.png');
                        }
                        icon.addEventListener('click', function (e) {
                            if (liked) {
                                $.ajax({
                                    type: "put",
                                    url: '/api/audio-records/05/20/' + id + '/unlike',
                                    data: JSON.stringify({}),
                                    dataType: "json",
                                    contentType: "application/json; charset=utf-8",
                                    success: function (unlike) {
                                        icon.setAttribute('src', 'img/zan.png');
                                        --n.likeCount;
                                        e.target.nextElementSibling.textContent = n.likeCount;
                                        liked = false;
                                    }
                                })
                            } else {
                                $.ajax({
                                    type: "put",
                                    url: '/api/audio-records/05/20/' + id + '/like',
                                    data: JSON.stringify({}),
                                    dataType: "json",
                                    contentType: "application/json; charset=utf-8",
                                    success: function (like) {
                                        icon.setAttribute('src', 'img/zan-over.png');
                                        ++n.likeCount;
                                        e.target.nextElementSibling.textContent = n.likeCount
                                        liked = true;
                                    }
                                })
                            }
                        }, false)
                    }
                });

                for (var i = 0; i < n.records.length; ++i) {
                    var play = document.getElementById('play' + n.records[i].unitNo);
                    play.addEventListener('click', function (e) {
                        player.src = 'p-zhibo-0520/' + bookNo + '/' + pageNo + e.target.dataset.unit + '.mp3';
                        player.currentTime = 0;
                        player.play()
                    }, false)

                    var translator = document.getElementById('translator' + n.records[i].unitNo);
                    translator.addEventListener('click', function (e) {
                        var content = '';
                        for (var j = 0; j < n.records.length; ++j) {
                            if (n.records[j].unitNo == e.target.dataset.unit) {
                                content = n.records[j].chinese
                            }
                        }
                        //show content via dialog
                        mask.style.display = 'block';
                        chinese.textContent = content;
                        dialog.style.display = 'block';
                        e.target.style.backgroundImage = new Image('translatorOff.png')
                    }, false)
                }
            }
        })
    }
</script>
</body>
</html>