<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>audio record</title>
    <style>
        .wrap {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .abs {
            position: absolute;
            -webkit-background-size: contain;
            background-size: contain;
        }

        .dialog {
            position: absolute;
            top: 50%;
            left: 50%;
            -webkit-transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -50%);
            -o-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
            width: 50%;
            height: 51.5%;
            background-color: white;
            margin: auto;
            z-index: 99;
            display: none;
        }
    </style>
</head>
<body>
<article id="content"></article>
<template id="audio-template">
    <div class="wrap" data-ext-point="units">
        <audio id="player" src="p-zhibo-0520/${bookNo}/${pageNo}${unitNo}.mp3" autoplay></audio>
        <img src="p-zhibo-0520/${bookNo}/${pageNo}.jpg" alt="" style="width: 100%; height: 100%;">
        <div data-ext-point="operation-panel"></div>
        <div>
            <a id="previous" class="abs" style="bottom: 12.5%; left: 82.5%; width: 12%; height: 7.3%;" href="p-zhibo-0520.html?book=${bookNo}&page=${previousPageNo}&unit=${previousUnitNo}">
                <img src="previous.png" alt="">
            </a>
            <a id="next" class="abs" style="bottom: 12.5%; left: 90.5%; width: 12%; height: 7.3%;" href="p-zhibo-0520.html?book=${bookNo}&page=${nextPageNo}&unit=${nextUnitNo}">
                <img src="next.png" alt="">
            </a>
        </div>
        <div id="mask" style="display: none; position: absolute; z-index: 50; top: 0; left: 0; width: 100%; height: 100%; background-color: black; opacity: 0.6;"></div>
        <div id="dialog" class="dialog">
            <img src="dialogIcon.png" alt="" style="position: relative; top: -50px; width: 200px;">
            <pre id="chinese"></pre>
            <button id="closeTranslator" style="margin: auto; display: block;"><img src="ok.png" alt=""></button>
        </div>
    </div>
</template>
<template id="operation-panel-template">
    <section>
        <div class="abs" style="top: ${top}%; left: ${left}%; width: ${width}%; height: ${height}%;">
            <div id="play${unitNo}" data-unit="${unitNo}" class="abs" style="bottom: 0; left: 0; width: 30px; height: 30px; background: url('amplifierOn.png') no-repeat center; background-size: contain;"></div>
            <div id="translator${unitNo}" data-unit="${unitNo}" class="abs" style="bottom: 0; left: 40px; width: 30px; height: 30px; background: url('translatorOn.png') no-repeat center; background-size: contain;"></div>
        </div>
    </section>
</template>
<template id="video-template">
    <div>
        <video src="p-zhibo-0520/${bookNo}.mp4" controls autoplay style="width: 100%; height: 100%;"></video>
    </div>
</template>
<script src="/jquery/jquery-3.1.1.min.js"></script>
<script src="/util.js"></script>
<script src="/basic.js"></script>
<script>
    var bookNo = g.getUrlParameter('book')
    $.ajax({
        type: 'get',
        url: '/api/audio-records/05/20/' + bookNo,
        success: function(n) {
            document.title = n.name
            var pageNo = g.getUrlParameter('page')
            var unitNo = g.getUrlParameter('unit')
            if (pageNo == null && unitNo == null) {
                proc({
                    templateId: 'video-template',
                    data: {bookNo: bookNo},
                    containerId: 'content'
                })
            } else {
                var previousIndex = null
                var nextIndex = null
                var records = []
                var i = 0
                for (; i < n.records.length; ++i) {
                    if (n.records[i].pageNo == pageNo) {
                        if (previousIndex == null && i > 0) {
                            previousIndex = i - 1
                        }
                        var r = n.records[i]
                        r.width = (r.right - r.left) / 100
                        r.left = r.left / 100
                        r.right = r.right / 100

                        r.height = (r.bottom - r.top) / 100
                        r.top = r.top / 100
                        r.bottom = r.bottom / 100
                        records.push(r)
                        if (i < n.records.length) {
                            nextIndex = i + 1
                        }
                    }
                }
                var previousPageNo = ''
                if (previousIndex != null) {
                    previousPageNo = n.records[previousIndex].pageNo
                }
                var nextPageNo = ''
                if (nextIndex != null) {
                    nextPageNo = n.records[nextIndex].pageNo
                }
                proc({
                    templateId: 'audio-template',
                    data: {
                        bookNo: bookNo,
                        pageNo: pageNo,
                        unitNo: unitNo,
                        records: records,
                        previousPageNo: previousPageNo,
                        previousUnitNo: '10',
                        nextPageNo: nextPageNo,
                        nextUnitNo: '10',
                    },
                    containerId: 'content',
                    secondBind: {
                        extPoint: 'operation-panel',
                        dataFieldName: 'records',
                        templateId: 'operation-panel-template'
                    }
                })

                var player = document.getElementById('player')
                var dialog = document.getElementById('dialog')
                var mask = document.getElementById('mask')
                var chinese = document.getElementById('chinese')
                var ok = document.getElementById('closeTranslator')

                ok.addEventListener('click', function(e){
                    dialog.style.display = 'none'
                    mask.style.display = 'none'
                }, false)

                for (var i = 0; i < records.length; ++i) {
                    var play = document.getElementById('play' + records[i].unitNo)
                    play.addEventListener('click', function (e) {
                        player.src = 'p-zhibo-0520/' + bookNo + '/' + pageNo + e.target.dataset.unit + '.mp3'
                        player.currentTime = 0
                        player.play()
                    }, false)

                    var translator = document.getElementById('translator' + records[i].unitNo)
                    translator.addEventListener('click', function (e) {
                        var content = ''
                        for (var j = 0; j < n.records.length; ++j) {
                            if (n.records[j].unitNo == e.target.dataset.unit) {
                                content = n.records[j].chinese
                            }
                        }
                        //show content via dialog
                        mask.style.display = 'block'
                        chinese.textContent = content
                        dialog.style.display = 'block'
                        e.target.style.backgroundImage = new Image('translatorOff.png')
                    }, false)
                }
            }
        }
    })
</script>
</body>
</html>